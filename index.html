<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Flight Replay</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- CesiumJS for 3D Visualization -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.108/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.108/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js"
    data-id="flightreplay" data-description="Support me on Buy me a coffee!" data-message="" data-color="#40DCA5"
    data-position="Right" data-x_margin="70" data-y_margin="18"></script>
  <style>
    :root {
      /* Light Theme (Default) */
      --bg-color: #f0f0f0;
      --glass-bg: rgba(255, 255, 255, 0.65);
      --glass-border: rgba(255, 255, 255, 0.4);
      --text-main: #1a1a1a;
      --text-header: #444444;
      --text-secondary: #666666;
      --button-bg: rgba(0, 0, 0, 0.05);
      --button-border: rgba(0, 0, 0, 0.1);
      --button-hover: rgba(0, 0, 0, 0.1);
      --flight-hover: rgba(0, 0, 0, 0.05);
      --flight-active-bg: rgba(0, 122, 255, 0.15);
      --flight-active-text: #007aff;
      --shadow-color: rgba(0, 0, 0, 0.05);
      --tooltip-bg: rgba(255, 255, 255, 0.85);
      --accent-color: #007aff;
      --chart-axis-color: #555555;
      --chart-grid-color: rgba(0, 0, 0, 0.1);
      --bmc-icon-color: #0D0C22;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        /* Dark Theme */
        --bg-color: #000000;
        --glass-bg: rgba(27, 27, 27, 0.65);
        --glass-border: rgba(255, 255, 255, 0.1);
        --text-main: #ffffff;
        --text-header: #cccccc;
        --text-secondary: #aaaaaa;
        --button-bg: rgba(255, 255, 255, 0.1);
        --button-border: rgba(255, 255, 255, 0.2);
        --button-hover: rgba(255, 255, 255, 0.2);
        --flight-hover: rgba(255, 255, 255, 0.1);
        --flight-active-bg: rgba(10, 132, 255, 0.3);
        --flight-active-text: #0a84ff;
        --shadow-color: rgba(0, 0, 0, 0.5);
        --tooltip-bg: rgba(40, 40, 40, 0.85);
        --accent-color: #0a84ff;
        --chart-axis-color: #cccccc;
        --chart-grid-color: rgba(255, 255, 255, 0.1);
        --bmc-icon-color: #f2f3dd;
      }
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Floating Buttons */
    #multi_file_button {
      position: absolute;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      color: var(--text-main);
      font-size: 0.8rem;
      z-index: 1001;
      background-color: var(--glass-bg);
      padding: 6px 12px;
      border-radius: 20px;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px var(--shadow-color);
      border: 1px solid var(--glass-border);
    }

    #brandingBtn {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1001;
      padding-left: 7px;
      background-color: transparent;
      border: none;
      box-shadow: none;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      font-size: 1.3rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      pointer-events: none;
      user-select: none;
      text-shadow: 0 4px 12px rgba(0, 0, 0, 1);
    }

    #brandingText {
      padding-bottom: 3px;
    }

    #brandingBtn svg {
      width: 48px;
      height: 48px;
      margin-left: 1px;
      display: block;
      filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 1));
    }

    #multiCsvFiles {
      display: none;
    }

    #toggleMarkersBtn {
      position: absolute;
      top: 80px;
      left: 10px;
      z-index: 1001;
      padding: 8px 16px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 20px;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
    }

    #screenshotBtn {
      position: absolute;
      top: 140px;
      right: 12px;
      z-index: 1001;
      padding: 10px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
    }

    #tipBtn {
      position: absolute;
      top: 200px;
      right: 12px;
      z-index: 1001;
      padding: 0;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 22px;
      /* Fixed radius to prevent 'bending' */
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      /* Align to the right where the icon stays */
      height: 44px;
      width: 140px;
      overflow: hidden;
      white-space: nowrap;
      text-decoration: none;
      padding-right: 9px;
      /* Precisely centers 24px icon in 44px button (1px border) */
    }

    #tipBtn .btn-text {
      margin-right: 12px;
      opacity: 1;
      transform: translateX(0);
      transition: opacity 1.5s ease, transform 1.5s cubic-bezier(0.4, 0, 0.2, 1), margin 1.5s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-block;
    }

    #tipBtn svg {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
      display: block;
    }

    #tipBtn.shrunk {
      width: 44px;
    }

    #tipBtn.shrunk .btn-text {
      opacity: 0;
      transform: translateX(40px);
      /* Pushed into/behind the icon */
      margin-right: -40px;
      /* Collapse space to keep icon centered */
    }

    #tipBtn:hover {
      transform: scale(1.05);
      background-color: var(--button-hover);
    }

    #layerBtn {
      position: absolute;
      top: 20px;
      right: 12px;
      z-index: 1001;
      padding: 10px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
    }

    #layerBtn:hover {
      transform: scale(1.1);
      background-color: var(--button-hover);
    }

    #infoBtn {
      position: absolute;
      top: 260px;
      right: 12px;
      z-index: 1001;
      padding: 10px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
    }

    #infoBtn:hover {
      transform: scale(1.1);
      background-color: var(--button-hover);
    }

    #layer3DBtn {
      position: absolute;
      top: 20px;
      right: 12px;
      z-index: 1001;
      padding: 10px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
    }

    #layer3DBtn:hover {
      transform: scale(1.1);
      background-color: var(--button-hover);
    }

    #searchBtn {
      position: absolute;
      top: 380px;
      right: 12px;
      z-index: 1001;
      padding: 10px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
    }

    #searchBtn:hover {
      transform: scale(1.1);
      background-color: var(--button-hover);
    }

    #debugBtn {
      position: absolute;
      top: 440px;
      right: 12px;
      z-index: 1001;
      padding: 10px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
    }

    #debugBtn:hover {
      transform: scale(1.1);
      background-color: var(--button-hover);
    }

    #debugBtn.active {
      background-color: var(--accent-color);
      color: white;
    }

    #debugStats {
      position: absolute;
      top: 200px;
      z-index: 1002;
      background-color: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 0, 0, 0.3);
      padding: 0;
      color: #ff0000;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      font-weight: bold;
      display: none;
      text-align: left;
      line-height: 1.6;
    }

    #debugStats.active {
      display: block;
    }

    #debugStats .debug-header {
      text-align: center;
      background-color: rgba(255, 0, 0, 0.2);
      padding: 6px 12px;
      border-bottom: 1px solid rgba(255, 0, 0, 0.3);
      border-radius: 8px 8px 0 0;
      font-size: 12px;
      letter-spacing: 1px;
    }

    #debugStats .debug-body {
      padding: 8px 12px;
    }

    #debugStats .debug-version {
      text-align: center;
      font-size: 10px;
      opacity: 0.7;
      margin-top: 4px;
      padding-top: 4px;
      border-top: 1px solid rgba(255, 0, 0, 0.2);
    }

    #trueTimeBtn {
      position: absolute;
      top: 500px;
      right: 12px;
      z-index: 1001;
      padding: 10px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
    }

    #trueTimeBtn.active {
      background-color: var(--accent-color);
      color: white;
    }

    #trueTimeBtn:hover {
      transform: scale(1.1);
      background-color: var(--button-hover);
    }

    /* 3D Container */
    #cesiumContainer {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    /* 3D Toggle Button */
    #toggle3DBtn {
      position: absolute;
      top: 80px;
      right: 12px;
      z-index: 1001;
      padding: 10px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
    }

    #toggle3DBtn:hover {
      transform: scale(1.1);
      background-color: var(--button-hover);
    }

    #followBtn {
      position: absolute;
      top: 320px;
      right: 12px;
      z-index: 1001;
      padding: 10px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      /* Default color when active (white/black) */
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      display: none;
    }

    #followBtn.active {
      background-color: var(--accent-color);
      color: white;
    }

    #followBtn:hover {
      transform: scale(1.1);
      background-color: var(--button-hover);
    }

    #toggleTracksBtn {
      position: absolute;
      top: 130px;
      left: 12px;
      right: auto;
      z-index: 1001;
      z-index: 1001;
      padding: 10px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      display: none;
      /* Hidden by default */
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
    }

    #toggleTracksBtn.active {
      background-color: var(--accent-color);
      color: white;
    }

    #toggleTracksBtn:hover {
      transform: scale(1.1);
      background-color: var(--button-hover);
    }

    /* Radar Button */
    #radarBtn {
      position: absolute;
      top: 190px;
      left: 12px;
      z-index: 1001;
      padding: 10px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
    }

    #radarBtn.active {
      background-color: var(--accent-color);
      color: white;
    }

    #radarBtn:hover {
      transform: scale(1.1);
      background-color: var(--button-hover);
    }

    /* ATC Data Label */
    .atc-data-label {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      position: absolute;
      color: #ffffff;
      font-size: 16px;
      padding: 4px 8px;
      pointer-events: none;
      z-index: 600;
      line-height: 1.1;
      text-shadow: 0 0 2px rgba(0, 0, 0, 1);
      white-space: nowrap;
      -webkit-text-stroke: 4px black;
      paint-order: stroke fill;
    }

    @media only screen and (max-width: 768px) {
      .atc-data-label {
        font-size: 12px;
        -webkit-text-stroke: 1px black;
      }
    }

    #follow2DBtn {
      position: absolute;
      top: 250px;
      left: 12px;
      z-index: 1001;
      padding: 10px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
    }

    #follow2DBtn.active {
      background-color: var(--accent-color);
      color: white;
    }

    #follow2DBtn:hover {
      transform: scale(1.1);
      background-color: var(--button-hover);
    }

    /* Hide Cesium's default UI elements */
    .cesium-viewer-bottom {
      display: none !important;
    }

    .cesium-viewer-toolbar {
      top: 10px !important;
      right: 60px !important;
    }

    .cesium-baseLayerPicker-dropDown {
      display: none !important;
    }

    .cesium-baseLayerPicker-itemLabel {
      display: none !important;
    }

    .cesium-baseLayerPicker-selected {
      display: none !important;
    }

    button.cesium-button.cesium-toolbar-button[data-bind*="toggleDropDown"] {
      display: none !important;
    }



    /* Custom Cesium Geocoder Styling */
    .cesium-viewer-geocoderContainer {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      margin: 0 !important;
      z-index: 2001 !important;
      opacity: 0 !important;
      visibility: hidden !important;
      transition: opacity 0.3s ease, visibility 0.3s ease !important;
    }

    .cesium-viewer-geocoderContainer.active {
      opacity: 1 !important;
      visibility: visible !important;
    }

    .cesium-geocoder-input {
      background-color: var(--glass-bg) !important;
      backdrop-filter: blur(5px) !important;
      -webkit-backdrop-filter: blur(5px) !important;
      border: 1px solid var(--glass-border) !important;
      border-radius: 20px !important;
      color: var(--text-main) !important;
      padding: 8px 40px 8px 16px !important;
      font-size: 0.9rem !important;
      box-shadow: 0 4px 6px var(--shadow-color) !important;
      transition: all 0.3s ease !important;
      width: 300px !important;
    }

    .cesium-geocoder-input:focus {
      outline: none !important;
      border-color: var(--accent-color) !important;
      box-shadow: 0 4px 12px var(--shadow-color) !important;
    }

    .cesium-geocoder-input::placeholder {
      color: var(--text-secondary) !important;
      opacity: 0.7 !important;
    }

    .cesium-geocoder-searchButton {
      background-color: transparent !important;
      border: none !important;
      color: var(--text-main) !important;
      right: 8px !important;
      top: 50% !important;
      transform: translateY(-50%) !important;
    }

    .cesium-geocoder-searchButton:hover {
      background-color: var(--button-hover) !important;
      border-radius: 50% !important;
    }

    .cesium-geocoder-suggestions {
      background-color: var(--glass-bg) !important;
      backdrop-filter: blur(15px) !important;
      -webkit-backdrop-filter: blur(15px) !important;
      border: 1px solid var(--glass-border) !important;
      border-radius: 12px !important;
      box-shadow: 0 8px 32px var(--shadow-color) !important;
      margin-top: 8px !important;
      overflow: hidden !important;
    }

    .cesium-geocoder-suggestion {
      color: var(--text-main) !important;
      padding: 10px 16px !important;
      border-bottom: 1px solid var(--glass-border) !important;
      transition: background-color 0.2s ease !important;
    }

    .cesium-geocoder-suggestion:last-child {
      border-bottom: none !important;
    }

    .cesium-geocoder-suggestion:hover,
    .cesium-geocoder-suggestion-selected {
      background-color: var(--button-hover) !important;
    }


    #infoModal {
      position: fixed;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 20px;
      z-index: 2000;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      width: 250px;
      text-align: center;
      color: var(--text-main);
      display: none;
    }

    #infoModal h3 {
      margin-top: 0;
      margin-bottom: 25px;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-header);
      border-bottom: 1px solid var(--glass-border);
      padding-bottom: 10px;
    }

    .info-group {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .info-label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-secondary);
      letter-spacing: 0.5px;
      margin-bottom: 2px;
    }

    .info-email {
      color: var(--accent-color);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.7rem;
      transition: opacity 0.2s;
    }

    .info-email:hover {
      opacity: 0.8;
      text-decoration: underline;
    }

    .info-subtext {
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .info-feature {
      font-size: 0.9rem;
      color: var(--text-main);
      background: var(--button-bg);
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid var(--button-border);
      display: inline-block;
      margin-top: 4px;
    }

    #infoModal .version {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 25px;
      border-top: 1px solid var(--glass-border);
      padding-top: 10px;
      opacity: 0.7;
    }

    #layerModal {
      position: fixed;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 20px;
      z-index: 2000;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      width: 250px;
      text-align: center;
      color: var(--text-main);
      display: none;
      /* Explicitly hidden in CSS too */
    }

    #layer3DModal {
      position: fixed;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 20px;
      z-index: 2000;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      width: 250px;
      text-align: center;
      color: var(--text-main);
      display: none;
    }

    #errorModal {
      position: fixed;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 59, 48, 0.3);
      /* Red border for error */
      border-radius: 20px;
      padding: 20px;
      z-index: 2100;
      /* Higher than layer modal */
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      width: 320px;
      text-align: center;
      color: var(--text-main);
      display: none;
    }

    #errorOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      z-index: 2099;
      display: none;
    }

    #errorModal h3 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.1rem;
      font-weight: 600;
      color: #ff3b30;
      /* Red color for title */
    }

    #errorModal p {
      font-size: 0.9rem;
      margin-bottom: 20px;
      line-height: 1.4;
    }

    #errorModal button {
      background: var(--button-bg);
      border: 1px solid var(--button-border);
      color: var(--text-main);
      padding: 8px 20px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    #errorModal button:hover {
      background: var(--button-hover);
    }

    #layerModal h3 {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .layer-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .layer-option {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--glass-border);
      padding: 10px;
      border-radius: 10px;
      color: var(--text-main);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .layer-option:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .layer-option.active {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }

    /* Hide the default Buy Me a Coffee widget button */
    #bmc-wbtn {
      display: none !important;
    }

    #screenshotBtn:hover {
      transform: scale(1.1);
      background-color: var(--button-hover);
    }

    #toggleMarkersBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px var(--shadow-color);
      background-color: var(--button-hover);
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      height: 100%;
      width: 100%;
      z-index: 0;
      background-color: #262626;
    }

    /* Info Box Container */
    .infosbox {
      position: absolute;
      top: auto;
      bottom: 20px;
      z-index: 1001;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 40px);
      max-width: 1400px;
      background-color: var(--glass-bg);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      padding: 4px 20px;
      border-radius: 25px;
      color: var(--text-main);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 32px var(--shadow-color);
      border: 1px solid var(--glass-border);
    }

    .infosbox.expanded {
      top: auto;
      bottom: 20px;
    }

    .infosbox.collapsed {
      top: auto;
      bottom: 20px;
    }

    .info-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .info-header {
      display: flex;
      justify-content: center;
      gap: 30px;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--glass-border);
      padding-bottom: 5px;
      margin-bottom: 2px;
      color: var(--text-header);
    }

    .info-body {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      flex-wrap: wrap;
    }

    .control-group.primary {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 2;
      min-width: 280px;
    }

    .playback-controls button {
      background-color: var(--button-bg);
      border: 1px solid var(--button-border);
      color: var(--text-main);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: background 0.2s;
    }

    .playback-controls button:hover {
      background: var(--button-hover);
    }

    .progress-container {
      flex-grow: 1;
      display: flex;
      align-items: center;
    }

    input[type="range"] {
      width: 100%;
      cursor: pointer;
      accent-color: var(--accent-color);
    }

    .data-group {
      display: flex;
      gap: 15px;
      flex: 3;
      justify-content: space-around;
      flex-wrap: wrap;
    }

    .data-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      min-width: 60px;
    }

    .data-item label {
      font-size: 0.65rem;
      color: var(--text-secondary);
      margin-bottom: 2px;
      text-transform: uppercase;
      font-weight: 600;
    }

    .data-item .value {
      font-size: 1rem;
      font-weight: 600;
      white-space: nowrap;
      color: var(--text-main);
      font-variant-numeric: tabular-nums;
    }

    .data-item .unit {
      font-size: 0.7rem;
      color: var(--text-secondary);
      margin-left: 1px;
    }

    /* Fix degree symbol alignment */
    .data-item .unit.degree {
      position: relative;
      top: -4px;
      font-size: 0.6rem;
    }

    .speed-control {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      min-width: 90px;
    }

    .speed-control input {
      width: 100%;
    }

    .aircraft-icon {
      background-color: transparent;
      border: none;
      transform-origin: center;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.9)) drop-shadow(0 4px 12px rgba(0, 0, 0, 0.6));
      /* Enhanced multi-layer shadow for maximum visibility and contrast */
    }

    .aircraft-icon svg {
      width: 32px;
      height: 32px;
    }

    #chart-container {
      height: 240px;
      background-color: transparent;
      overflow: hidden;
      margin-top: 5px;
      transition: height 0.3s ease, opacity 0.3s ease, margin-top 0.3s ease;
    }

    #chart-container.collapsed {
      height: 0;
      opacity: 0;
      margin-top: 0;
    }

    /* Aircraft Info Section - Exact match to reference image */
    #aircraft-info-container {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
      padding: 0;
    }

    #aircraft-info-container.collapsed {
      max-height: 0;
      opacity: 0;
      padding: 0;
    }

    #aircraft-info-container:not(.collapsed) {
      max-height: 100px;
      opacity: 1;
      padding: 10px 15px;
    }

    .aircraft-info-horizontal {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      height: 100%;
      position: relative;
    }

    /* Left Section: Photo + Details */
    .aircraft-left-section {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-shrink: 0;
    }

    .aircraft-photo-section {
      flex-shrink: 0;
      position: relative;
    }

    .aircraft-photo {
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
      display: block;
    }

    .aircraft-photo-copyright {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: #ffffff;
      font-size: 8px;
      padding: 2px 4px;
      border-bottom-left-radius: 4px;
      border-bottom-right-radius: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: none;
    }

    .aircraft-details-section {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 140px;
    }

    .aircraft-operator {
      font-size: 18px;
      font-weight: 700;
      color: #ffffff;
      line-height: 1.2;
    }

    .aircraft-flight-number {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.9);
      line-height: 1.2;
    }

    .aircraft-registration {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.9);
      line-height: 1.2;
    }

    /* Center Section: Route */
    .aircraft-route-section {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 30px;
      align-items: center;
    }

    .aircraft-route-column {
      display: flex;
      flex-direction: column;
      gap: 1px;
      min-width: 0;
    }

    .aircraft-route-times {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.3;
    }

    .aircraft-route-airport {
      font-size: 22px;
      font-weight: 700;
      color: #ffffff;
      line-height: 1.2;
    }

    .aircraft-route-city {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.3;
    }

    .aircraft-model-section {
      flex-shrink: 0;
      text-align: right;
      display: flex;
      flex-direction: column;
      gap: 1px;
      min-width: 180px;
    }

    .aircraft-model-name {
      font-size: 18px;
      font-weight: 700;
      color: #ffffff;
      line-height: 1.2;
    }

    .aircraft-model-code {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.2;
    }

    .aircraft-model-placeholder {
      height: 17px;
    }

    @media (max-width: 1024px) {
      #aircraft-info-container:not(.collapsed) {
        max-height: 160px;
      }

      .aircraft-info-horizontal {
        flex-wrap: wrap;
        gap: 12px;
      }

      .aircraft-route-section {
        position: static;
        transform: none;
        flex: 1 1 100%;
        order: 3;
        justify-content: center;
      }

      .aircraft-model-section {
        order: 2;
      }
    }

    @media (max-width: 768px) {
      #aircraft-info-container:not(.collapsed) {
        max-height: 220px;
      }

      .aircraft-left-section {
        flex-direction: row;
        align-items: flex-start;
        gap: 10px;
      }

      .aircraft-photo {
        height: 70px;
      }

      .aircraft-details-section {
        min-width: auto;
        flex: 1;
      }

      .aircraft-model-section {
        min-width: auto;
      }
    }

    /* iPhone and small mobile screens */
    @media (max-width: 480px) {
      #aircraft-info-container:not(.collapsed) {
        max-height: 200px;
        padding: 12px 10px;
      }

      .aircraft-info-horizontal {
        flex-wrap: wrap;
        align-items: flex-start;
        gap: 10px;
      }

      /* ROW 1: Photo + Details + Model */
      .aircraft-left-section {
        flex-direction: row;
        align-items: flex-start;
        gap: 8px;
        flex: 1;
        min-width: 0;
      }

      .aircraft-photo {
        height: 60px;
        width: auto;
        flex-shrink: 0;
      }

      .aircraft-details-section {
        flex: 1;
        min-width: 0;
        padding-top: 2px;
      }

      .aircraft-operator {
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .aircraft-flight-number,
      .aircraft-registration {
        font-size: 11px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .aircraft-model-section {
        flex-shrink: 0;
        text-align: right;
        min-width: auto;
        order: 0;
        align-self: flex-start;
        padding-top: 2px;
      }

      .aircraft-model-name {
        font-size: 12px;
        white-space: nowrap;
      }

      .aircraft-model-code {
        font-size: 11px;
        white-space: nowrap;
      }

      .aircraft-model-placeholder {
        display: none;
      }

      /* ROW 2: Route Information */
      .aircraft-route-section {
        width: 100%;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: space-around;
        order: 3;
      }

      .aircraft-route-times {
        font-size: 10px;
      }

      .aircraft-route-airport {
        font-size: 16px;
      }

      .aircraft-route-city {
        font-size: 10px;
      }
    }

    /* iPhone SE and very small screens */
    @media (max-width: 375px) {
      #aircraft-info-container:not(.collapsed) {
        max-height: 220px;
        padding: 10px 8px;
      }

      .aircraft-left-section {
        gap: 6px;
      }

      .aircraft-photo {
        height: 50px;
      }

      .aircraft-operator {
        font-size: 13px;
      }

      .aircraft-flight-number,
      .aircraft-registration {
        font-size: 10px;
      }

      .aircraft-model-name {
        font-size: 13px;
      }

      .aircraft-model-code {
        font-size: 10px;
      }

      .aircraft-route-section {
        gap: 10px;
      }

      .aircraft-route-times {
        font-size: 9px;
      }

      .aircraft-route-airport {
        font-size: 14px;
      }

      .aircraft-route-city {
        font-size: 9px;
      }
    }

    canvas {
      height: 240px;
    }

    /* Flight Selector Container */
    #flightSelectorContainer {
      position: absolute;
      top: 250px;
      left: 0;
      z-index: 1001;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: flex-start;
    }

    #flightSelectorContainer.collapsed {
      transform: translateX(calc(-100% + 0px));
    }

    .flight-selector {
      background-color: var(--glass-bg);
      padding: 10px;
      border-radius: 16px;
      color: var(--text-main);
      max-height: 50vh;
      overflow-y: auto;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      box-shadow: 0 4px 10px var(--shadow-color);
      border: 1px solid var(--glass-border);
      margin-left: 10px;
    }

    #flightSelectorToggle {
      position: absolute;
      top: 190px;
      left: 12px;
      z-index: 1001;
      padding: 10px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
    }

    #flightSelectorToggle:hover {
      background: var(--button-hover);
    }

    #flightSelectorToggle span {
      transition: transform 0.3s ease;
      display: inline-block;
      font-size: 12px;
    }

    #flightSelectorContainer.collapsed #flightSelectorToggle span {
      transform: rotate(180deg);
    }

    .flight-item {
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s;
      white-space: nowrap;
      font-size: 0.9rem;
      margin-bottom: 2px;
    }

    .flight-item:hover {
      background-color: var(--flight-hover);
    }

    .flight-item.active {
      background-color: var(--flight-active-bg);
      color: var(--flight-active-text);
      font-weight: 500;
    }

    /* Toggle Graph Button */
    #toggleGraphBtn {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: -17px;
      /* Adjusted position */
      background: var(--glass-bg);
      color: var(--text-main);
      border: 1px solid var(--glass-border);
      border-bottom: none;
      border-radius: 12px 12px 0 0;
      padding: 0;
      /* Reset padding */
      cursor: grab;
      /* Grab cursor */
      width: 60px;
      /* Wider button */
      height: 16px;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      box-shadow: 0 -2px 10px var(--shadow-color);
      display: none;
      /* Hidden by default */
      /* Flex to center handle */
      align-items: center;
      justify-content: center;
      z-index: 1002;
    }

    #toggleGraphBtn:active {
      cursor: grabbing;
    }

    #toggleGraphBtn .handle-bar {
      width: 30px;
      height: 4px;
      background-color: var(--text-secondary);
      border-radius: 2px;
      opacity: 0.5;
    }

    .tooltip-content {
      font-size: 13px;
      color: var(--text-main);
      border-radius: 12px;
      padding: 8px 12px;
      background: var(--tooltip-bg);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px var(--shadow-color);
      border: 1px solid var(--glass-border);
    }

    .tooltip-content strong {
      color: var(--text-main);
      font-weight: 600;
    }

    .speed-indicator {
      font-size: 0.7rem;
    }

    /* RESPONSIVE MEDIA QUERIES */
    @media (max-width: 1024px) {
      .infosbox {
        width: 96%;
        padding: 8px;
      }

      .data-group {
        gap: 10px;
      }
    }

    @media (max-width: 768px) {
      #multi_file_button {
        font-size: 0.75rem;
        padding: 6px 12px;
      }

      #toggleMarkersBtn {
        padding: 6px 14px;
        margin-top: 10px;
      }

      .flight-selector {
        /* Position above info box on mobile */
        left: 10px;
        max-width: 180px;
      }

      .infosbox {
        width: 96%;
        bottom: 15px;
        padding: 10px 10px;
      }

      .info-header {
        font-size: 0.75rem;
        gap: 8px;
        justify-content: space-evenly;
      }

      .control-group.primary {
        min-width: 0;
        width: 100%;
        margin-bottom: 5px;
      }

      .data-group {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        /* 2 columns for better readability */
        gap: 10px;
      }

      .data-item .value {
        font-size: 0.85rem;
      }

      .data-item label {
        font-size: 0.55rem;
      }

      .data-item.speed-control {
        grid-column: span 2;
        flex-direction: row;
        justify-content: center;
        gap: 10px;
      }

      .speed-control input {
        width: 60%;
      }

      #chart-container {
        height: 200px;
      }
    }
  </style>

  <style>
    /* Mobile Portrait Specific Refinements -> Now applied to all screens <= 939px */
    @media (max-width: 939px) {
      .infosbox {
        bottom: 25px;
        padding: 10px 8px;
        width: 95%;
      }

      .info-header {
        display: flex;
        justify-content: space-between;
        padding: 0 5px 8px 5px;
        font-size: 0.75rem;
        border-bottom: 1px solid var(--glass-border);
        margin-bottom: 10px;
      }

      /* FLEX CONTAINER FOR ROW 2 & 3 */
      .info-body {
        display: flex;
        flex-wrap: wrap;
        /* Allow wrapping */
        align-items: center;
        justify-content: space-between;
        gap: 0;
      }

      /* UNWRAP DATA GROUP to allow mixing children with control-group */
      .data-group {
        display: contents;
      }

      /* --- ROW 2: Playback Controls + Speed --- */

      /* 2A: Play/Progress (Left) */
      .control-group.primary {
        order: 1;
        flex: 1 1 55%;
        /* Take approx 55% width */
        min-width: 0;
        /* Allow shrinking */
        margin-right: 5px;
        margin-bottom: 12px;
        /* Push Row 3 down */
      }

      .progress-container {
        flex-grow: 1;
        margin: 0 5px;
      }

      /* 2B: Speed Control (Right) */
      .data-item.speed-control {
        order: 2;
        flex: 1 1 35%;
        /* Take remaining width */
        min-width: 0;
        display: flex;
        flex-direction: row;
        /* Force row layout */
        align-items: center;
        justify-content: flex-end;
        grid-column: auto;
        /* Reset grid if present */
        margin-bottom: 12px;
        /* Push Row 3 down */
        gap: 4px;
        width: auto !important;
        /* Override explicit widths */
      }

      .speed-control label {
        display: block !important;
        /* Make Visible */
        font-size: 0.6rem;
        margin: 0;
        color: var(--text-secondary);
      }

      .speed-control input {
        width: 70px !important;
        margin: 0 2px;
      }

      .speed-indicator {
        font-size: 0.8rem;
        min-width: 20px;
        text-align: right;
        margin-right: 9px;
      }

      /* --- ROW 3: Data Metrics (Alt, GS, Track, Time) --- */

      .data-item:not(.speed-control) {
        order: 3;
        flex: 1 1 10%;
        /*flex: 1 1 22%; -> 4 items ~ 25% each */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-width: 0;
      }

      .data-item:not(.speed-control) label {
        font-size: 0.55rem;
        white-space: nowrap;
        margin-bottom: 2px;
        width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .data-item:not(.speed-control) .value {
        font-size: 0.85rem;
      }

      .data-item .unit {
        font-size: 0.6rem;
      }
    }

    /* CUSTOM ZOOM CONTROL STYLES */
    .leaflet-control-zoom {
      border: none !important;
      box-shadow: 0 4px 6px var(--shadow-color) !important;
      display: flex !important;
      flex-direction: column !important;
      /* Vertical layout */
      gap: 0 !important;
      /* No gap between buttons */
      margin-top: 20px !important;
      /* Top 10px */
      margin-left: 12px !important;
      /* Left 12px */
      background-color: var(--glass-bg) !important;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border: 1px solid var(--glass-border) !important;
      border-radius: 22px !important;
      /* Pill shape (half of 44px width) */
      overflow: hidden;
      /* integrated look */
      padding: 0 !important;
      width: 44px !important;
    }

    .leaflet-control-zoom a {
      background-color: transparent !important;
      color: var(--text-main) !important;
      border: none !important;
      border-radius: 0 !important;
      /* Reset radius */
      width: 42px !important;
      height: 44px !important;
      line-height: 44px !important;
      font-size: 22px !important;
      font-weight: 300 !important;
      box-shadow: none !important;
      transition: background 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin: 0 !important;
    }

    .leaflet-control-zoom a:hover {
      background-color: var(--button-hover) !important;
      color: var(--text-main) !important;
      transform: none !important;
      /* Disable scale to keep pill shape intact */
    }

    /* Standard Order: Plus (In) Top, Minus (Out) Bottom */
    .leaflet-control-zoom-in {
      order: 1;
      border-bottom: 1px solid var(--glass-border) !important;
      /* Separator line */
    }

    .leaflet-control-zoom-out {
      order: 2;
      border-right: none !important;
    }

    /* Remove default rounded corners from first/last child overrides */
    .leaflet-bar a:first-child {
      border-top-left-radius: 0 !important;
      border-top-right-radius: 0 !important;
    }

    .leaflet-bar a:last-child {
      border-bottom-left-radius: 0 !important;
      border-bottom-right-radius: 0 !important;
      border-bottom: none !important;
    }

    /* Center the icons */
    .leaflet-control-zoom-in span,
    .leaflet-control-zoom-out span {
      display: block;
      margin-top: -2px;
    }

    .leaflet-control-zoom-in span,
    .leaflet-control-zoom-out span {
      display: block;
      margin-top: -2px;
    }

    /* Loading Overlay */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      z-index: 3000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      display: none;
      /* Hidden by default */
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid var(--accent-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    .loading-text {
      font-size: 1.2rem;
      font-weight: 500;
      color: var(--text-main);
      background: var(--glass-bg);
      padding: 8px 24px;
      border-radius: 20px;
      border: 1px solid var(--glass-border);
      box-shadow: 0 4px 12px var(--shadow-color);
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <input type="file" id="multiCsvFiles" multiple onchange="handleMultiFiles()" />
  <label id="multi_file_button" for="multiCsvFiles">Select Flight file(s)</label>
  <div id="brandingBtn">
    <span id="brandingText">Flight</span>
    <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
      <path
        d="M 515.98 981.25 C514.75,987.16 513.41,992.00 513.00,992.00 C512.59,992.00 512.26,989.41 512.27,986.25 C512.45,863.74 511.70,700.00 510.96,700.00 C510.43,700.00 505.67,704.13 500.37,709.18 C491.22,717.89 490.66,718.26 489.28,716.43 C487.24,713.71 482.12,703.48 472.33,682.55 C467.68,672.62 463.48,664.10 463.00,663.61 C461.91,662.51 448.90,670.40 440.00,677.56 C422.54,691.60 367.57,724.52 336.00,739.85 C309.76,752.59 275.47,766.30 258.25,770.93 C253.17,772.30 252.59,774.86 256.75,777.55 C258.26,778.53 262.65,782.36 266.50,786.06 C295.96,814.36 338.75,841.95 376.73,857.13 C401.66,867.09 425.26,873.90 451.00,878.56 C458.98,880.01 465.81,881.48 466.19,881.84 C466.57,882.20 467.82,887.00 468.96,892.50 C470.11,898.00 471.88,905.72 472.90,909.65 C473.91,913.58 474.43,917.30 474.05,917.92 C473.54,918.75 469.62,918.53 459.42,917.09 C415.66,910.92 371.50,896.91 331.50,876.49 C293.25,856.96 262.10,833.97 228.23,800.25 C218.15,790.21 209.36,782.00 208.70,782.00 C208.04,782.00 204.12,782.75 200.00,783.66 C189.26,786.04 156.94,786.07 144.22,783.71 C103.08,776.09 77.18,755.86 67.82,724.05 C62.06,704.50 65.72,672.49 76.87,644.73 C82.11,631.69 93.34,610.75 99.18,603.12 C101.77,599.72 101.44,602.37 98.64,607.32 C86.56,628.74 77.45,670.19 79.94,692.33 C83.74,726.00 100.45,746.47 133.03,757.36 C143.61,760.90 159.48,763.00 175.65,763.00 C209.95,763.00 242.53,755.48 290.20,736.56 C314.49,726.92 337.70,715.66 363.00,701.26 C387.58,687.27 413.00,671.26 426.22,661.46 C429.90,658.73 436.19,654.13 440.20,651.23 C444.22,648.33 452.12,642.57 457.77,638.42 C464.29,633.62 468.79,630.98 470.08,631.18 C471.64,631.42 473.49,634.58 477.90,644.50 C487.06,665.10 494.63,680.65 495.86,681.42 C497.62,682.50 509.81,671.08 511.12,667.13 C511.94,664.65 511.94,661.87 511.12,656.63 C508.24,638.15 504.03,603.47 504.50,602.00 C504.79,601.10 510.27,595.89 516.70,590.43 C540.16,570.47 577.64,537.82 582.76,532.86 C587.13,528.64 588.28,527.99 589.51,529.01 C590.33,529.69 591.00,530.61 591.00,531.07 C591.00,532.31 604.55,561.04 620.44,593.50 C628.25,609.45 640.00,633.64 646.56,647.25 C655.14,665.05 658.97,672.00 660.18,672.00 C661.96,672.00 674.57,658.61 676.86,654.27 C678.65,650.89 678.28,647.54 672.18,612.00 C669.39,595.78 663.25,558.02 658.53,528.10 C651.44,483.17 650.13,473.13 651.01,470.47 C651.73,468.29 656.45,463.26 665.57,454.97 C683.44,438.72 709.54,411.80 715.45,403.52 C721.75,394.69 727.41,382.28 729.51,372.69 C731.13,365.32 731.13,364.63 729.51,360.40 C727.04,353.92 724.53,352.62 715.73,353.27 C706.30,353.96 699.54,356.36 686.87,363.50 C667.70,374.31 659.90,380.71 627.31,412.34 C617.30,422.05 608.49,430.00 607.72,430.00 C606.96,430.00 599.39,428.43 590.91,426.50 C487.17,402.98 440.90,393.00 435.61,393.00 C431.64,393.00 428.22,393.68 425.43,395.04 C420.78,397.28 410.63,407.39 411.22,409.17 C411.43,409.79 425.28,417.90 442.01,427.19 C458.73,436.47 473.11,444.65 473.96,445.37 C474.81,446.08 478.42,448.16 482.00,449.97 C485.58,451.79 500.88,460.15 516.00,468.55 C531.12,476.94 544.74,484.38 546.25,485.07 C547.76,485.76 549.00,486.81 549.00,487.41 C549.00,488.01 539.50,498.40 527.88,510.50 C516.27,522.60 499.07,540.94 489.66,551.25 C480.26,561.56 471.83,570.24 470.92,570.52 C470.02,570.81 466.85,570.43 463.89,569.68 C460.92,568.92 450.62,567.08 441.00,565.58 C431.38,564.08 421.58,562.44 419.24,561.93 C416.89,561.42 412.91,561.00 410.39,561.00 C406.09,561.00 405.37,561.42 398.90,567.66 C395.11,571.33 392.00,574.66 392.00,575.07 C392.00,575.47 402.58,581.00 415.50,587.34 C433.30,596.08 439.00,599.32 438.99,600.69 C438.99,601.84 436.51,604.02 432.17,606.70 C428.42,609.01 419.76,614.84 412.93,619.64 C397.36,630.58 357.84,655.27 340.00,665.21 C316.58,678.26 277.38,697.32 255.50,706.31 C232.55,715.74 193.17,727.07 178.29,728.54 L 171.33 729.23 L 163.78 716.36 C135.93,668.94 119.08,619.34 111.42,562.20 C110.51,555.43 110.02,549.64 110.33,549.34 C111.32,548.34 145.45,557.11 146.67,558.68 C147.32,559.50 148.37,563.40 149.01,567.34 C154.00,598.08 163.87,631.28 177.03,661.50 C181.84,672.55 189.63,688.41 192.01,692.00 C192.55,692.83 193.43,694.71 193.96,696.20 C194.48,697.68 196.10,699.68 197.55,700.63 C200.11,702.30 200.56,702.26 211.26,699.15 C243.32,689.83 274.76,675.54 312.27,653.23 C332.86,640.98 336.97,637.73 341.32,630.27 C358.45,600.86 364.86,588.89 363.69,588.48 C359.93,587.19 293.69,571.47 250.00,561.50 C237.07,558.55 215.70,553.58 202.50,550.44 C189.30,547.31 175.12,543.96 171.00,543.01 C159.20,540.26 117.68,530.36 93.00,524.39 C80.62,521.40 63.64,517.29 55.25,515.27 C46.86,513.24 40.00,511.34 40.00,511.04 C40.00,510.74 55.86,510.78 75.25,511.12 C94.64,511.46 197.06,511.80 302.85,511.87 L 495.20 512.00 L 503.35 503.37 C507.83,498.63 511.50,494.02 511.50,493.13 C511.50,491.25 504.67,487.21 468.50,467.73 C454.20,460.03 432.58,447.94 420.45,440.86 C407.05,433.05 397.34,428.00 395.71,428.00 C394.23,428.00 389.75,428.89 385.76,429.99 C381.77,431.08 375.77,432.34 372.43,432.80 L 366.36 433.62 L 359.62 422.06 C353.85,412.18 325.75,362.98 304.47,325.50 C290.95,301.67 285.42,292.03 278.77,280.66 C274.96,274.15 272.08,268.59 272.37,268.30 C273.01,267.66 279.30,271.45 281.01,273.51 C282.02,274.73 281.95,275.00 280.62,275.00 C278.23,275.00 278.65,277.74 281.25,279.12 C282.49,279.78 308.54,305.00 339.13,335.16 C369.73,365.32 395.19,390.00 395.71,390.00 C396.23,390.00 398.87,387.94 401.58,385.42 C417.78,370.36 430.02,367.68 454.50,373.84 C461.10,375.50 469.42,377.37 473.00,377.98 C476.58,378.60 482.42,379.95 486.00,380.99 C497.33,384.27 509.86,386.70 511.21,385.87 C512.26,385.22 512.50,352.13 512.50,209.62 C512.50,113.23 512.64,34.48 512.82,34.48 C512.99,34.66 516.93,50.71 521.57,70.15 C526.22,89.59 532.92,117.65 536.46,132.50 C543.63,162.48 553.00,203.06 559.10,230.50 C563.26,249.18 568.45,271.72 574.52,297.50 C576.47,305.75 580.55,323.75 583.59,337.50 C586.63,351.25 589.51,363.40 589.98,364.50 C590.46,365.60 591.10,368.99 591.41,372.04 C591.71,375.08 593.13,382.28 594.56,388.04 C598.15,402.55 598.79,405.47 599.73,405.57 C599.96,405.60 600.21,405.45 600.53,405.26 C600.64,405.20 600.76,405.13 600.90,405.06 C604.25,403.26 611.27,396.94 628.66,380.07 C645.60,363.63 647.76,361.95 674.00,344.71 C677.03,342.72 693.85,326.71 711.39,309.13 C736.73,283.72 743.17,276.74 742.75,275.14 C742.34,273.57 743.38,272.37 747.60,269.57 C753.74,265.49 754.18,265.35 753.28,267.75 C752.47,269.88 720.20,325.98 718.75,327.77 C717.32,329.54 718.16,330.10 723.70,331.12 C730.95,332.46 740.44,337.53 744.45,342.21 C754.74,354.24 754.58,375.46 744.03,397.71 C734.83,417.08 721.90,432.06 682.12,469.37 L 673.73 477.23 L 674.41 484.87 C675.62,498.47 677.47,509.88 678.67,511.07 C679.55,511.95 717.10,512.14 832.36,511.84 C916.18,511.63 984.67,511.55 984.67,511.66 C984.26,512.07 906.96,530.72 857.00,542.45 C712.90,576.29 691.06,581.54 689.94,582.66 C689.29,583.31 690.33,591.76 693.01,607.58 C695.24,620.73 697.32,632.33 697.63,633.34 C697.94,634.35 698.50,640.88 698.88,647.86 L 699.58 660.54 L 726.44 708.78 C741.22,735.32 753.13,757.18 752.90,757.36 C752.49,757.71 703.04,727.34 678.64,711.75 C663.65,702.17 661.02,701.43 656.27,705.43 C654.68,706.76 652.86,707.53 652.22,707.14 C651.59,706.75 649.66,703.29 647.93,699.46 C643.95,690.62 642.37,688.96 632.00,682.75 C627.33,679.95 619.22,674.89 614.00,671.51 C601.03,663.12 592.15,658.00 590.58,658.00 C589.78,658.00 589.02,659.81 588.63,662.66 C588.28,665.23 585.71,676.59 582.93,687.91 C580.14,699.24 576.08,717.43 573.90,728.34 C570.05,747.68 566.26,764.38 558.10,798.00 C555.90,807.08 552.02,824.40 549.48,836.50 C545.06,857.53 543.34,864.73 538.94,880.60 C537.86,884.51 534.55,898.46 531.58,911.60 C528.61,924.75 524.39,943.38 522.20,953.00 C520.02,962.62 517.22,975.34 515.98,981.25 ZM 576.50 915.91 C554.50,919.19 551.00,919.43 551.00,917.66 C551.00,916.40 552.99,907.28 558.49,883.38 C558.91,881.51 560.29,881.05 569.74,879.58 C604.53,874.17 641.44,862.01 675.00,844.90 C752.87,805.21 814.52,739.01 848.99,658.08 C860.47,631.13 870.80,596.63 874.48,573.00 C875.38,567.22 876.31,561.50 876.56,560.29 C876.65,559.86 876.70,559.51 876.84,559.21 C877.46,557.81 879.96,557.25 897.00,553.05 C903.88,551.35 910.58,549.68 911.90,549.33 L 914.31 548.69 L 913.61 558.83 C911.22,593.51 893.68,652.70 874.38,691.26 C858.48,723.01 836.19,758.68 825.50,769.48 C823.85,771.14 820.47,775.19 818.00,778.47 C812.04,786.37 783.82,814.68 772.50,824.13 C753.20,840.24 742.73,847.87 724.64,859.00 C721.51,860.92 716.12,864.36 712.67,866.64 C704.56,872.00 681.79,883.39 665.38,890.30 C637.94,901.85 602.70,912.01 576.50,915.91 ZM 915.00 471.44 C915.00,472.42 914.16,472.97 912.75,472.91 C908.57,472.75 879.09,465.51 877.96,464.37 C877.34,463.75 875.75,456.80 874.42,448.92 C863.67,385.39 835.79,324.24 793.58,271.56 C782.12,257.27 756.79,232.23 741.19,219.79 C700.82,187.60 661.64,166.79 614.50,152.51 C602.36,148.83 570.29,142.00 565.17,142.00 C560.07,142.00 559.05,140.23 555.58,125.46 C553.78,117.78 551.98,109.75 551.58,107.61 L 550.86 103.71 L 558.68 104.40 C590.19,107.16 631.33,117.62 664.84,131.38 C678.64,137.05 709.28,152.41 717.50,157.79 C720.80,159.95 725.56,162.88 728.08,164.30 C733.87,167.57 752.95,181.28 763.46,189.72 C783.81,206.07 805.39,227.46 821.24,247.00 C830.51,258.43 851.07,287.33 857.32,297.71 C865.03,310.51 876.98,334.16 883.51,349.50 C893.17,372.22 903.83,407.11 908.86,432.50 C911.68,446.77 915.00,467.79 915.00,471.44 ZM 127.50 469.48 C120.90,471.00 114.53,472.61 113.35,473.06 C109.01,474.69 109.02,473.76 113.57,446.17 C120.53,403.94 131.25,369.60 149.23,332.00 C169.29,290.02 195.06,253.85 229.44,219.41 C262.22,186.58 293.55,163.76 333.00,144.00 C376.90,122.01 417.99,109.91 467.15,104.50 C470.26,104.16 473.04,104.26 473.33,104.73 C473.82,105.51 469.24,128.84 466.95,137.22 C465.78,141.53 465.29,141.71 447.13,144.45 C399.87,151.56 340.31,177.23 297.50,208.93 C219.69,266.53 166.39,353.84 149.72,451.00 L 147.40 464.50 L 143.45 465.61 C141.28,466.22 134.10,467.96 127.50,469.48 Z"
        fill="rgb(195,195,195)" />
      <path
        d="M 344.19 395.20 C351.61,408.18 357.34,418.17 359.62,422.06 L 366.36 433.62 L 372.43 432.80 C375.77,432.34 381.77,431.08 385.76,429.99 C389.75,428.89 394.23,428.00 395.71,428.00 C397.34,428.00 407.05,433.05 420.45,440.86 C432.58,447.94 454.20,460.03 468.50,467.73 C504.67,487.21 511.50,491.25 511.50,493.13 C511.50,494.02 507.83,498.63 503.35,503.37 L 495.20 512.00 L 302.85 511.87 C197.06,511.80 94.64,511.46 75.25,511.12 C57.03,510.80 41.93,510.75 40.17,510.99 C40.06,510.93 40.00,510.88 40.00,510.84 C40.00,509.77 41.96,509.28 100.00,495.92 C128.88,489.27 176.12,478.28 205.00,471.49 C248.20,461.34 339.18,440.20 359.50,435.59 C363.43,434.70 364.50,434.03 364.50,432.48 C364.50,431.39 361.88,426.00 358.69,420.50 C356.80,417.24 351.27,407.61 344.19,395.20 ZM 512.79 35.25 C512.63,43.60 512.50,118.77 512.50,209.62 C512.50,352.13 512.26,385.22 511.21,385.87 C509.86,386.70 497.33,384.27 486.00,380.99 C482.42,379.95 476.58,378.60 473.00,377.98 C469.42,377.37 461.10,375.50 454.50,373.84 C430.02,367.68 417.78,370.36 401.58,385.42 C398.87,387.94 396.23,390.00 395.71,390.00 C395.19,390.00 369.73,365.32 339.13,335.16 C308.54,305.00 282.49,279.78 281.25,279.12 C278.65,277.74 278.23,275.00 280.62,275.00 C281.95,275.00 282.02,274.73 281.01,273.51 C280.40,272.78 279.21,271.82 277.90,270.93 C278.33,271.19 278.77,271.47 279.22,271.75 C282.67,273.97 290.90,278.82 297.50,282.53 C308.54,288.73 330.14,301.38 341.00,308.01 C350.86,314.02 429.65,360.80 431.88,361.96 C434.75,363.47 435.46,362.63 436.93,356.00 C437.48,353.52 440.87,338.90 444.47,323.50 C456.21,273.28 460.00,256.95 467.12,226.00 C470.97,209.23 479.46,172.32 485.99,144.00 C492.51,115.68 500.87,79.22 504.56,63.00 C508.26,46.78 511.56,33.18 511.90,32.79 C511.98,32.69 512.30,33.57 512.79,35.25 ZM 983.88 511.64 C976.03,511.56 910.93,511.64 832.36,511.84 C717.10,512.14 679.55,511.95 678.67,511.07 C677.47,509.88 675.62,498.47 674.41,484.87 L 673.73 477.23 L 682.12 469.37 C713.84,439.62 728.49,424.07 737.79,409.17 C734.72,414.15 731.18,419.13 727.18,424.00 C724.70,427.02 719.54,432.71 715.71,436.64 L 708.76 443.79 L 714.13 445.29 C719.70,446.85 754.37,455.31 780.50,461.49 C788.75,463.44 802.92,466.81 812.00,468.98 C830.05,473.29 852.79,478.72 892.00,488.09 C927.04,496.46 979.97,509.66 982.99,510.79 C983.80,511.09 984.17,511.34 983.88,511.64 ZM 429.82 685.03 C433.92,682.19 437.38,679.66 440.00,677.56 C448.90,670.40 461.91,662.51 463.00,663.61 C463.48,664.10 467.68,672.62 472.33,682.55 C482.12,703.48 487.24,713.71 489.28,716.43 C490.66,718.26 491.22,717.89 500.37,709.18 C505.67,704.13 510.43,700.00 510.96,700.00 C511.70,700.00 512.45,863.74 512.27,986.25 C512.26,988.96 512.50,991.24 512.83,991.84 C511.53,990.00 506.93,971.72 498.53,935.00 C494.44,917.12 488.79,892.60 485.97,880.50 C476.53,839.92 451.94,733.70 447.44,714.00 C440.36,683.09 439.42,679.49 438.43,679.70 C438.12,679.77 434.73,681.87 429.82,685.03 ZM 748.19 269.17 C748.00,269.30 747.80,269.43 747.60,269.57 C743.38,272.37 742.34,273.57 742.75,275.14 C743.17,276.74 736.73,283.72 711.39,309.13 C693.85,326.71 677.03,342.72 674.00,344.71 C647.76,361.95 645.60,363.63 628.66,380.07 C611.27,396.94 604.25,403.26 600.90,405.06 C600.76,405.13 600.64,405.20 600.53,405.26 C600.21,405.45 599.96,405.60 599.73,405.57 C598.79,405.47 598.15,402.55 594.56,388.04 C593.13,382.28 591.71,375.08 591.41,372.04 C591.10,368.99 590.46,365.60 589.98,364.50 C589.51,363.40 586.63,351.25 583.59,337.50 C580.55,323.75 576.47,305.75 574.52,297.50 C572.97,290.90 571.47,284.52 570.03,278.36 C571.47,284.53 572.97,290.92 574.53,297.50 C576.47,305.75 580.60,323.98 583.71,338.00 C586.81,352.02 589.63,363.84 589.97,364.25 C590.32,364.66 594.63,362.46 599.55,359.36 C612.91,350.93 648.69,329.00 682.50,308.51 C699.00,298.51 717.67,287.17 724.00,283.32 C730.33,279.46 738.18,274.85 741.46,273.07 C743.75,271.83 746.33,270.33 748.19,269.17 ZM 312.36 750.67 C291.86,759.74 272.36,767.13 258.25,770.93 C270.60,767.61 291.72,759.62 312.36,750.67 ZM 372.98 720.09 C384.47,713.55 396.21,706.56 406.81,699.98 C395.97,706.92 387.93,711.67 372.98,720.09 ZM 840.47 546.35 C836.60,547.25 831.87,548.35 826.50,549.61 C836.00,547.38 846.15,544.99 857.00,542.45 C876.52,537.86 900.21,532.22 921.87,527.03 C895.26,533.44 863.60,540.96 840.47,546.35 ZM 751.44 374.09 C753.30,361.16 750.98,349.84 744.45,342.21 C751.14,350.03 753.34,361.30 751.44,374.09 ZM 542.26 157.00 C540.24,148.41 538.28,140.11 536.46,132.50 C535.15,126.99 533.40,119.66 531.48,111.63 C532.88,117.48 534.09,122.53 534.96,126.12 C536.84,133.93 539.43,144.88 542.26,157.00 ZM 971.17 515.10 C976.45,513.80 980.43,512.80 982.65,512.23 C981.44,512.63 979.35,513.16 976.10,513.92 C974.95,514.19 973.26,514.60 971.17,515.10 ZM 702.40 579.09 C695.16,580.95 690.27,582.33 689.94,582.66 C690.32,582.28 693.13,581.41 702.40,579.09 ZM 753.55 266.23 C753.28,265.99 752.33,266.49 750.19,267.86 C752.29,266.37 753.31,265.83 753.55,266.23 ZM 559.10 230.45 C561.18,239.84 563.53,250.19 566.11,261.40 C563.52,250.18 561.18,239.86 559.10,230.50 C558.20,226.43 557.22,222.08 556.19,217.51 C557.28,222.32 558.26,226.70 559.10,230.45 ZM 523.35 77.58 L 521.57 70.15 C520.66,66.34 519.78,62.66 518.95,59.20 C519.69,62.25 520.47,65.46 521.26,68.79 C521.93,71.63 522.63,74.58 523.35,77.58 ZM 513.01 992.00 C513.36,991.95 514.39,988.41 515.45,983.71 C514.39,988.45 513.36,992.00 513.02,992.00 C513.01,992.00 513.01,992.00 513.01,992.00 ZM 272.48 268.24 C272.44,268.25 272.41,268.27 272.38,268.29 C272.38,268.28 272.39,268.28 272.39,268.28 C272.41,268.26 272.44,268.25 272.48,268.24 Z"
        fill="rgb(255,255,255)" />
    </svg>
    <span id="brandingText">Replay</span>
  </div>
  <button id="screenshotBtn" title="Take Screenshot">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
      <circle cx="12" cy="13" r="4"></circle>
    </svg>
  </button>
  <button id="tipBtn" title="Support me on Buy me a coffee!">
    <span class="btn-text">Leave a tip</span>
    <svg xmlns="http://www.w3.org/2000/svg" width="auto" height="24" viewBox="0 0 884 1279" fill="none">
      <path d="M791.109 297.518L790.231 297.002L788.201 296.383C789.018 297.072 790.04 297.472 791.109 297.518V297.518Z"
        fill="var(--bmc-icon-color)" />
      <path d="M803.896 388.891L802.916 389.166L803.896 388.891Z" fill="var(--bmc-icon-color)" />
      <path
        d="M791.484 297.377C791.359 297.361 791.237 297.332 791.118 297.29C791.111 297.371 791.111 297.453 791.118 297.534C791.252 297.516 791.379 297.462 791.484 297.377V297.377Z"
        fill="var(--bmc-icon-color)" />
      <path d="M791.113 297.529H791.244V297.447L791.113 297.529Z" fill="var(--bmc-icon-color)" />
      <path
        d="M803.111 388.726L804.591 387.883L805.142 387.573L805.641 387.04C804.702 387.444 803.846 388.016 803.111 388.726V388.726Z"
        fill="var(--bmc-icon-color)" />
      <path d="M793.669 299.515L792.223 298.138L791.243 297.605C791.77 298.535 792.641 299.221 793.669 299.515V299.515Z"
        fill="var(--bmc-icon-color)" />
      <path
        d="M430.019 1186.18C428.864 1186.68 427.852 1187.46 427.076 1188.45L427.988 1187.87C428.608 1187.3 429.485 1186.63 430.019 1186.18Z"
        fill="var(--bmc-icon-color)" />
      <path
        d="M641.187 1144.63C641.187 1143.33 640.551 1143.57 640.705 1148.21C640.705 1147.84 640.86 1147.46 640.929 1147.1C641.015 1146.27 641.084 1145.46 641.187 1144.63Z"
        fill="var(--bmc-icon-color)" />
      <path
        d="M619.284 1186.18C618.129 1186.68 617.118 1187.46 616.342 1188.45L617.254 1187.87C617.873 1187.3 618.751 1186.63 619.284 1186.18Z"
        fill="var(--bmc-icon-color)" />
      <path
        d="M281.304 1196.06C280.427 1195.3 279.354 1194.8 278.207 1194.61C279.136 1195.06 280.065 1195.51 280.684 1195.85L281.304 1196.06Z"
        fill="var(--bmc-icon-color)" />
      <path
        d="M247.841 1164.01C247.704 1162.66 247.288 1161.35 246.619 1160.16C247.093 1161.39 247.489 1162.66 247.806 1163.94L247.841 1164.01Z"
        fill="var(--bmc-icon-color)" />
      <path
        d="M472.623 590.836C426.682 610.503 374.546 632.802 306.976 632.802C278.71 632.746 250.58 628.868 223.353 621.274L270.086 1101.08C271.74 1121.13 280.876 1139.83 295.679 1153.46C310.482 1167.09 329.87 1174.65 349.992 1174.65C349.992 1174.65 416.254 1178.09 438.365 1178.09C462.161 1178.09 533.516 1174.65 533.516 1174.65C553.636 1174.65 573.019 1167.08 587.819 1153.45C602.619 1139.82 611.752 1121.13 613.406 1101.08L663.459 570.876C641.091 563.237 618.516 558.161 593.068 558.161C549.054 558.144 513.591 573.303 472.623 590.836Z"
        fill="#FFDD00" />
      <path
        d="M78.6885 386.132L79.4799 386.872L79.9962 387.182C79.5987 386.787 79.1603 386.435 78.6885 386.132V386.132Z"
        fill="var(--bmc-icon-color)" />
      <path
        d="M879.567 341.849L872.53 306.352C866.215 274.503 851.882 244.409 819.19 232.898C808.711 229.215 796.821 227.633 788.786 220.01C780.751 212.388 778.376 200.55 776.518 189.572C773.076 169.423 769.842 149.257 766.314 129.143C763.269 111.85 760.86 92.4243 752.928 76.56C742.604 55.2584 721.182 42.8009 699.88 34.559C688.965 30.4844 677.826 27.0375 666.517 24.2352C613.297 10.1947 557.342 5.03277 502.591 2.09047C436.875 -1.53577 370.983 -0.443234 305.422 5.35968C256.625 9.79894 205.229 15.1674 158.858 32.0469C141.91 38.224 124.445 45.6399 111.558 58.7341C95.7448 74.8221 90.5829 99.7026 102.128 119.765C110.336 134.012 124.239 144.078 138.985 150.737C158.192 159.317 178.251 165.846 198.829 170.215C256.126 182.879 315.471 187.851 374.007 189.968C438.887 192.586 503.87 190.464 568.44 183.618C584.408 181.863 600.347 179.758 616.257 177.304C634.995 174.43 647.022 149.928 641.499 132.859C634.891 112.453 617.134 104.538 597.055 107.618C594.095 108.082 591.153 108.512 588.193 108.942L586.06 109.252C579.257 110.113 572.455 110.915 565.653 111.661C551.601 113.175 537.515 114.414 523.394 115.378C491.768 117.58 460.057 118.595 428.363 118.647C397.219 118.647 366.058 117.769 334.983 115.722C320.805 114.793 306.661 113.611 292.552 112.177C286.134 111.506 279.733 110.801 273.333 110.009L267.241 109.235L265.917 109.046L259.602 108.134C246.697 106.189 233.792 103.953 221.025 101.251C219.737 100.965 218.584 100.249 217.758 99.2193C216.932 98.1901 216.482 96.9099 216.482 95.5903C216.482 94.2706 216.932 92.9904 217.758 91.9612C218.584 90.9319 219.737 90.2152 221.025 89.9293H221.266C232.33 87.5721 243.479 85.5589 254.663 83.8038C258.392 83.2188 262.131 82.6453 265.882 82.0832H265.985C272.988 81.6186 280.026 80.3625 286.994 79.5366C347.624 73.2302 408.614 71.0801 469.538 73.1014C499.115 73.9618 528.676 75.6996 558.116 78.6935C564.448 79.3474 570.746 80.0357 577.043 80.8099C579.452 81.1025 581.878 81.4465 584.305 81.7391L589.191 82.4445C603.438 84.5667 617.61 87.1419 631.708 90.1703C652.597 94.7128 679.422 96.1925 688.713 119.077C691.673 126.338 693.015 134.408 694.649 142.03L696.731 151.752C696.786 151.926 696.826 152.105 696.852 152.285C701.773 175.227 706.7 198.169 711.632 221.111C711.994 222.806 712.002 224.557 711.657 226.255C711.312 227.954 710.621 229.562 709.626 230.982C708.632 232.401 707.355 233.6 705.877 234.504C704.398 235.408 702.75 235.997 701.033 236.236H700.895L697.884 236.649L694.908 237.044C685.478 238.272 676.038 239.419 666.586 240.486C647.968 242.608 629.322 244.443 610.648 245.992C573.539 249.077 536.356 251.102 499.098 252.066C480.114 252.57 461.135 252.806 442.162 252.771C366.643 252.712 291.189 248.322 216.173 239.625C208.051 238.662 199.93 237.629 191.808 236.58C198.106 237.389 187.231 235.96 185.029 235.651C179.867 234.928 174.705 234.177 169.543 233.397C152.216 230.798 134.993 227.598 117.7 224.793C96.7944 221.352 76.8005 223.073 57.8906 233.397C42.3685 241.891 29.8055 254.916 21.8776 270.735C13.7217 287.597 11.2956 305.956 7.64786 324.075C4.00009 342.193 -1.67805 361.688 0.472751 380.288C5.10128 420.431 33.165 453.054 73.5313 460.35C111.506 467.232 149.687 472.807 187.971 477.556C338.361 495.975 490.294 498.178 641.155 484.129C653.44 482.982 665.708 481.732 677.959 480.378C681.786 479.958 685.658 480.398 689.292 481.668C692.926 482.938 696.23 485.005 698.962 487.717C701.694 490.429 703.784 493.718 705.08 497.342C706.377 500.967 706.846 504.836 706.453 508.665L702.633 545.797C694.936 620.828 687.239 695.854 679.542 770.874C671.513 849.657 663.431 928.434 655.298 1007.2C653.004 1029.39 650.71 1051.57 648.416 1073.74C646.213 1095.58 645.904 1118.1 641.757 1139.68C635.218 1173.61 612.248 1194.45 578.73 1202.07C548.022 1209.06 516.652 1212.73 485.161 1213.01C450.249 1213.2 415.355 1211.65 380.443 1211.84C343.173 1212.05 297.525 1208.61 268.756 1180.87C243.479 1156.51 239.986 1118.36 236.545 1085.37C231.957 1041.7 227.409 998.039 222.9 954.381L197.607 711.615L181.244 554.538C180.968 551.94 180.693 549.376 180.435 546.76C178.473 528.023 165.207 509.681 144.301 510.627C126.407 511.418 106.069 526.629 108.168 546.76L120.298 663.214L145.385 904.104C152.532 972.528 159.661 1040.96 166.773 1109.41C168.15 1122.52 169.44 1135.67 170.885 1148.78C178.749 1220.43 233.465 1259.04 301.224 1269.91C340.799 1276.28 381.337 1277.59 421.497 1278.24C472.979 1279.07 524.977 1281.05 575.615 1271.72C650.653 1257.95 706.952 1207.85 714.987 1130.13C717.282 1107.69 719.576 1085.25 721.87 1062.8C729.498 988.559 737.115 914.313 744.72 840.061L769.601 597.451L781.009 486.263C781.577 480.749 783.905 475.565 787.649 471.478C791.392 467.391 796.352 464.617 801.794 463.567C823.25 459.386 843.761 452.245 859.023 435.916C883.318 409.918 888.153 376.021 879.567 341.849ZM72.4301 365.835C72.757 365.68 72.1548 368.484 71.8967 369.792C71.8451 367.813 71.9483 366.058 72.4301 365.835ZM74.5121 381.94C74.6842 381.819 75.2003 382.508 75.7337 383.334C74.925 382.576 74.4089 382.009 74.4949 381.94H74.5121ZM76.5597 384.641C77.2996 385.897 77.6953 386.689 76.5597 384.641V384.641ZM80.672 387.979H80.7752C80.7752 388.1 80.9645 388.22 81.0333 388.341C80.9192 388.208 80.7925 388.087 80.6548 387.979H80.672ZM800.796 382.989C793.088 390.319 781.473 393.726 769.996 395.43C641.292 414.529 510.713 424.199 380.597 419.932C287.476 416.749 195.336 406.407 103.144 393.382C94.1102 392.109 84.3197 390.457 78.1082 383.798C66.4078 371.237 72.1548 345.944 75.2003 330.768C77.9878 316.865 83.3218 298.334 99.8572 296.355C125.667 293.327 155.64 304.218 181.175 308.09C211.917 312.781 242.774 316.538 273.745 319.36C405.925 331.405 540.325 329.529 671.92 311.91C695.905 308.686 719.805 304.941 743.619 300.674C764.835 296.871 788.356 289.731 801.175 311.703C809.967 326.673 811.137 346.701 809.778 363.615C809.359 370.984 806.139 377.915 800.779 382.989H800.796Z"
        fill="var(--bmc-icon-color)" />
    </svg>
  </button>
  <button id="layerBtn" title="Change Map Layer">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
      <polyline points="2 17 12 22 22 17"></polyline>
      <polyline points="2 12 12 17 22 12"></polyline>
    </svg>
  </button>
  <button id="layer3DBtn" title="Change 3D Map Layer" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
      <polyline points="2 17 12 22 22 17"></polyline>
      <polyline points="2 12 12 17 22 12"></polyline>
    </svg>
  </button>
  <button id="infoBtn" title="Info & Contact">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
    </svg>
  </button>
  <button id="searchBtn" title="Search Location" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="11" cy="11" r="8"></circle>
      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
    </svg>
  </button>
  <button id="debugBtn" title="Toggle Debug Info">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path
        d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h-1.5c0-.59-.48-1.07-1.07-1.07-.59 0-1.07.48-1.07 1.07H15c0-2.76-2.24-5-5-5s-5 2.24-5 5H3.64c0-.59-.48-1.07-1.07-1.07-.59 0-1.07.48-1.07 1.07H0a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z">
      </path>
      <line x1="8" y1="14" x2="8" y2="17"></line>
      <line x1="12" y1="14" x2="12" y2="17"></line>
      <line x1="16" y1="14" x2="16" y2="17"></line>
    </svg>
  </button>
  <button id="trueTimeBtn" title="Toggle TrueTime (Real-time Playback)">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"></circle>
      <polyline points="12 6 12 12 16 14"></polyline>
    </svg>
  </button>
  <div id="debugStats">
    <div class="debug-header">-DEV DEBUG-</div>
    <div class="debug-body">
      <div>FPS: <span id="fpsCounter">0</span></div>
      <div>MS: <span id="msCounter">0</span></div>

      <div class="debug-version">v0.1.0</div>
    </div>
  </div>
  <div id="infoModal" style="display: none;">
    <h3>About Flight Replay</h3>

    <div class="info-group">
      <div class="info-label">Contact</div>
      <a href="mailto:flightplayback.webmaster@gmail.com" class="info-email">flightplayback.webmaster@gmail.com</a>
      <div class="info-subtext">For feedbacks and bug reports.</div>
    </div>

    <div class="info-group">
      <div class="info-label">Coming Soon</div>
      <div class="info-feature">3D Globe Visualiser</div>
      <div class="info-feature">Flight View</div>
      <div class="info-feature">Detailed Aicraft Infos</div>
    </div>

    <div class="version">Version 0.1.0</div>
  </div>
  <div id="layerModal" style="display: none;">
    <h3>Select Map Style</h3>
    <div class="layer-options">
      <!-- Options will be generated by JS or static -->
      <button class="layer-option active" onclick="switchBaseLayer('Esri Satellite')">Esri Satellite</button>
      <button class="layer-option" onclick="switchBaseLayer('OpenStreetMap')">OpenStreetMap</button>
      <button class="layer-option" onclick="switchBaseLayer('Esri Topo')">Esri Topo</button>
      <button class="layer-option" onclick="switchBaseLayer('Esri Streets')">Esri Streets</button>
      <button class="layer-option" onclick="switchBaseLayer('CartoDB Light')">CartoDB Light</button>
      <button class="layer-option" onclick="switchBaseLayer('CartoDB Dark')">CartoDB Dark</button>
      <button class="layer-option" onclick="switchBaseLayer('OpenTopoMap')">OpenTopoMap</button>
    </div>
  </div>
  <div id="layer3DModal" style="display: none;">
    <h3>Select 3D Map Style</h3>
    <div class="layer-options">
      <!-- 3D Layer Options -->
      <button class="layer-option" onclick="switch3DBaseLayer('Bing Maps Aerial')">Bing Maps Aerial</button>
      <button class="layer-option" onclick="switch3DBaseLayer('Bing Maps Roads')">Bing Maps Roads</button>
      <button class="layer-option active" onclick="switch3DBaseLayer('ArcGIS World Imagery')">ArcGIS World
        Imagery</button>
      <button class="layer-option" onclick="switch3DBaseLayer('ArcGIS World Hillshade')">ArcGIS World Hillshade</button>
      <button class="layer-option" onclick="switch3DBaseLayer('OpenStreetMap')">OpenStreetMap</button>
    </div>
  </div>
  <div id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading...</div>
  </div>
  <div id="map"></div>
  <!-- 3D Cesium Container (hidden by default) -->
  <div id="cesiumContainer" style="display: none;"></div>
  <button id="toggle3DBtn" title="Toggle 2D/3D View">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path
        d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
      </path>
      <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
      <line x1="12" y1="22.08" x2="12" y2="12"></line>
    </svg>
  </button>
  <div id="flightSelectorContainer" class="collapsed" style="display: none;">
    <div id="flightSelector" class="flight-selector"></div>
  </div>
  <button id="flightSelectorToggle" title="Toggle Flight List" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </button>
  <button id="followBtn" title="Toggle Follow Mode" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <!-- Broken square corners (aiming reticle) -->
      <!-- Top-left corner -->
      <path d="M 4 4 L 4 8" />
      <path d="M 4 4 L 8 4" />
      <!-- Top-right corner -->
      <path d="M 20 4 L 20 8" />
      <path d="M 16 4 L 20 4" />
      <!-- Bottom-left corner -->
      <path d="M 4 20 L 4 16" />
      <path d="M 4 20 L 8 20" />
      <!-- Bottom-right corner -->
      <path d="M 20 20 L 20 16" />
      <path d="M 16 20 L 20 20" />
      <!-- Top-down plane view in the middle -->
      <!-- Fuselage (vertical line) -->
      <path d="M 12 7 L 12 17" stroke-width="1.8" />
      <!-- Wings (horizontal line) -->
      <path d="M 8 10.5 L 16 10.5" stroke-width="1.8" />
      <!-- Tail stabilizer (horizontal line at bottom) -->
      <path d="M 10 15 L 14 15" stroke-width="1.8" />
    </svg>
  </button>
  <button id="toggleTracksBtn" title="Toggle Single/Multi Track View">
    <!-- Icon removed, content set dynamically -->
  </button>
  <button id="radarBtn" title="Toggle ATC Radar Data">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <!-- Radar screen circle -->
      <circle cx="12" cy="12" r="9"></circle>
      <!-- Radar sweep line -->
      <path d="M12 3 L12 12"></path>
      <!-- Radar blips -->
      <circle cx="15" cy="9" r="1.5" fill="currentColor"></circle>
      <circle cx="9" cy="14" r="1.5" fill="currentColor"></circle>
      <circle cx="16" cy="15" r="1.5" fill="currentColor"></circle>
    </svg>
  </button>
  <button id="follow2DBtn" title="Toggle Follow 2D Mode">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <!-- Broken square corners (aiming reticle) -->
      <!-- Top-left corner -->
      <path d="M 4 4 L 4 8" />
      <path d="M 4 4 L 8 4" />
      <!-- Top-right corner -->
      <path d="M 20 4 L 20 8" />
      <path d="M 16 4 L 20 4" />
      <!-- Bottom-left corner -->
      <path d="M 4 20 L 4 16" />
      <path d="M 4 20 L 8 20" />
      <!-- Bottom-right corner -->
      <path d="M 20 20 L 20 16" />
      <path d="M 16 20 L 20 20" />
      <!-- Top-down plane view in the middle -->
      <!-- Fuselage (vertical line) -->
      <path d="M 12 7 L 12 17" stroke-width="1.8" />
      <!-- Wings (horizontal line) -->
      <path d="M 8 10.5 L 16 10.5" stroke-width="1.8" />
      <!-- Tail stabilizer (horizontal line at bottom) -->
      <path d="M 10 15 L 14 15" stroke-width="1.8" />
    </svg>
  </button>


  <!-- <button id="toggleMarkersBtn">VFR</button> -->
  <div class="infosbox collapsed">
    <button id="toggleGraphBtn" title="Slide to toggle graph">
      <div class="handle-bar"></div>
    </button>

    <div class="info">
      <div class="info-grid">
        <div class="info-header">
          <div>LOC <span id="heure">--/--/---- --:--:--</span></div>
          <div>UTC <span id="UTCTime">--/--/---- --:--:--</span></div>
        </div>

        <div class="info-body">
          <div class="control-group primary">
            <div class="playback-controls">
              <button id="playPauseBtn"></button>
            </div>
            <div class="progress-container">
              <input type="range" id="progressBar" value="0" min="0" step="1" disabled>
            </div>
          </div>

          <div class="data-group">
            <div class="data-item speed-control">
              <label>Speed</label>
              <input type="range" id="speedControl" min="0" max="8" value="0" step="1" disabled>
              <span class="speed-indicator" id="speedIndicator">1x</span>
            </div>

            <div class="data-item">
              <label>Baro Alt</label>
              <div class="value"><span id="altitude">-----</span><span class="unit">ft</span></div>
            </div>

            <div class="data-item">
              <label>GS</label>
              <div class="value"><span id="vitesse">----</span><span class="unit">kts</span></div>
            </div>

            <div class="data-item">
              <label>Track</label>
              <div class="value"><span id="direction">---</span><span class="unit degree"></span></div>
            </div>

            <div class="data-item">
              <label>Actual Flt Time</label>
              <div class="value"><span id="flightTime">--:--:--</span></div>
            </div>

            <div class="data-item">
              <label>Distance</label>
              <div class="value"><span id="flightDistance">----</span><span class="unit">nm</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Aircraft Information Section (KML only) - Between chart and info body -->
    <div id="aircraft-info-container" class="collapsed">
      <div class="aircraft-info-horizontal">
        <!-- Left Section: Photo + Flight Details -->
        <div class="aircraft-left-section">
          <div class="aircraft-photo-section">
            <img id="ac-photo" class="aircraft-photo" alt="Aircraft Photo" style="display: none;">
            <div id="ac-photo-copyright" class="aircraft-photo-copyright"></div>
          </div>

          <div class="aircraft-details-section">
            <div class="aircraft-operator" id="ac-operator">--</div>
            <div class="aircraft-flight-number" id="ac-flight-number">-- / --</div>
            <div class="aircraft-registration" id="ac-registration">--</div>
          </div>
        </div>

        <!-- Center Section: Route Information -->
        <div class="aircraft-route-section">
          <!-- Departure -->
          <div class="aircraft-route-times" id="ac-dep-times">STD --:-- UTC<br>ATD --:-- UTC</div>
          <div class="aircraft-route-column">
            <div class="aircraft-route-airport" id="ac-departure-airport">---</div>
            <div class="aircraft-route-city" id="ac-departure-city">---</div>
          </div>
          <div>-></div>
          <!-- Arrival -->
          <div class="aircraft-route-column">
            <div class="aircraft-route-airport" id="ac-arrival-airport">---</div>
            <div class="aircraft-route-city" id="ac-arrival-city">---</div>
          </div>
          <div class="aircraft-route-times" id="ac-arr-times">STA --:-- UTC<br>ETA --:-- UTC</div>
        </div>

        <!-- Right Section: Aircraft Model -->
        <div class="aircraft-model-section">
          <div class="aircraft-model-name" id="ac-model">--</div>
          <div class="aircraft-model-code" id="ac-icao">(----)</div>
          <div class="aircraft-model-placeholder"></div>
        </div>
      </div>
    </div>

    <div id="chart-container" class="collapsed">
      <canvas id="flightChart"></canvas>
    </div>

    <script>
      let aircraftMarker = null;
      let flightPath = null;
      let flightPathPoints = [];
      let playbackInterval = null;
      let isPlaying = false;
      let playbackSpeed = 200;
      let chartInstance = null;
      let currentTooltip = null;
      let flightName = "";
      let altitudeSegments = [];
      let allFlights = [];
      let currentFlightIndex = 0;
      let currentFlightData = null;
      let isSingleTrackMode = false;

      // Info box slide state: 0 = collapsed, 1 = graph shown, 2 = graph + aircraft info shown
      let infoBoxSlideState = 0;
      let currentAircraftInfo = null; // Stores aircraft info from KML files
      let isKMLFile = false; // Track if current file is KML

      // Radar mode variables
      let radarModeEnabled = false;
      let atcDataLabel = null;
      let isFollowing2D = false;

      // TrueTime Mode Variables
      let isTrueTimeMode = false;
      let trueTimeAnimationFrame = null;
      let isUserScrubbing = false;
      let currentSimulatedTime = 0;
      let simulationLastFrameTime = 0;

      // Cesium 3D Variables
      Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJhYTNmZTFhNC1mNDBlLTQ0MGMtOWY5Yi0wODdjNzk4ODRkZWEiLCJpZCI6Mzc5Mzg3LCJpYXQiOjE3Njg1Mjg2OTN9.N_lOlCsyXEE9vkrDpzTqAbBbZpU_jSXF2LQ0ycDKOD4';
      let viewer = null;
      let cesiumAircraftEntity = null;
      let cesiumPathEntity = null;
      let is3DMode = false;
      let cesiumInitialized = false;
      const defaultViewFrom = new Cesium.Cartesian3(-80.0, 0.0, 0.0); // Directly Behind and above

      // Initialize Cesium viewer (lazy loading)
      async function initCesium() {
        if (cesiumInitialized) return;

        try {
          const imageryViewModels = Cesium.createDefaultImageryProviderViewModels();
          const allowedLayers = [
            'Bing Maps Aerial',
            'Bing Maps Roads',
            'ArcGIS World Imagery',
            'ArcGIS World Hillshade'
          ];

          const filteredViewModels = imageryViewModels.filter(vm =>
            allowedLayers.some(allowed => vm.name.includes(allowed))
          );

          // Explicitly add OpenStreetMap
          filteredViewModels.push(new Cesium.ProviderViewModel({
            name: 'OpenStreetMap',
            iconUrl: Cesium.buildModuleUrl('Widgets/Images/ImageryProviders/openStreetMap.png'),
            tooltip: 'OpenStreetMap',
            creationFunction: function () {
              return new Cesium.UrlTemplateImageryProvider({
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                subdomains: 'abc',
                maximumLevel: 19
              });
            }
          }));

          const selectedImageryViewModel = filteredViewModels.find(vm => vm.name.includes('ArcGIS World Imagery')) || filteredViewModels[0];

          viewer = new Cesium.Viewer('cesiumContainer', {
            terrainProvider: await Cesium.createWorldTerrainAsync(),
            imageryProviderViewModels: filteredViewModels,
            terrainProviderViewModels: [],
            animation: false,
            timeline: false,
            infoBox: false,
            selectionIndicator: false,
            navigationHelpButton: false,
            baseLayerPicker: true,
            selectedImageryProviderViewModel: selectedImageryViewModel,
            fullscreenButton: false,
            geocoder: true,
            homeButton: false,
            sceneModePicker: false,
            shouldAnimate: false
          });


          viewer.scene.globe.depthTestAgainstTerrain = true;
          viewer.scene.globe.enableLighting = false;

          // Improve rendering quality for mobile/Retina displays
          // Use full device pixel ratio for sharp rendering on high-DPI displays (iPhone, etc.)
          var pixelRatio = window.devicePixelRatio || 1;
          viewer.resolutionScale = pixelRatio; // Use full device pixel ratio (3.0 on iPhone)

          // Improve globe texture resolution (lower value = higher detail)
          // Lowered from 1.5 to 1.0 for maximum quality on mobile
          viewer.scene.globe.maximumScreenSpaceError = 1.0;

          // Enable anti-aliasing if supported
          viewer.scene.postProcessStages.fxaa.enabled = true;

          // Set initial camera position to view Europe (matching user's desired view)
          viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(15.0, 40.0, 20000000), // Centered on Europe, higher altitude for full continent view
            orientation: {
              heading: 0.0,
              pitch: Cesium.Math.toRadians(-90), // Looking straight down
              roll: 0.0
            }
          });

          // Sync Cesium clock with playback
          viewer.clock.onTick.addEventListener((clock) => {
            if (!is3DMode || !currentFlightData || !isPlaying) return;
            syncStatsFrom3D();
          });

          cesiumInitialized = true;
          console.log("Cesium initialized successfully");
        } catch (error) {
          console.error("Cesium initialization failed:", error);
          alert("Failed to initialize 3D view. Falling back to 2D mode.");
          is3DMode = false;
          document.getElementById('map').style.display = 'block';
          document.getElementById('cesiumContainer').style.display = 'none';
        }
      }


      function calculateFlightTime(data) {
        if (!data || data.length === 0) return "00:00:00";

        let firstAirborneTimestamp = null;
        for (let i = 0; i < data.length; i++) {
          if (parseFloat(data[i].Altitude) > 0) {
            firstAirborneTimestamp = parseInt(data[i].Timestamp);
            break;
          }
        }

        let lastAirborneTimestamp = null;
        for (let i = data.length - 1; i >= 0; i--) {
          if (parseFloat(data[i].Altitude) > 0) {
            lastAirborneTimestamp = parseInt(data[i].Timestamp);
            break;
          }
        }

        if (firstAirborneTimestamp && lastAirborneTimestamp) {
          const durationSeconds = lastAirborneTimestamp - firstAirborneTimestamp;
          const hours = Math.floor(durationSeconds / 3600);
          const minutes = Math.floor((durationSeconds % 3600) / 60);
          const seconds = Math.floor(durationSeconds % 60);

          return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        return "00:00:00";
      }

      function calculateFlightDistance(points) {
        if (!points || points.length < 2) return "0.0";

        // Haversine formula to calculate distance between two lat/lng points
        function haversineDistance(lat1, lon1, lat2, lon2) {
          const R = 3440.065; // Earth's radius in nautical miles
          const dLat = (lat2 - lat1) * Math.PI / 180;
          const dLon = (lon2 - lon1) * Math.PI / 180;
          const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
          return R * c;
        }

        let totalDistance = 0;
        for (let i = 0; i < points.length - 1; i++) {
          const p1 = points[i];
          const p2 = points[i + 1];
          totalDistance += haversineDistance(p1.lat, p1.lng, p2.lat, p2.lng);
        }

        return totalDistance.toFixed(1);
      }

      function createAircraftIcon(rotation = 0, model = "") {
        const isAirbusA320 = /A3(1[89]|2[01])/i.test(model || "");
        const isAirbusA330 = /A33[23789P]|A30[LT]/i.test(model || "");
        const isAirbusA340 = /A34[23456]|A340/i.test(model || "");
        const isAirbusA380 = /A388|A380/i.test(model || "");
        const isBoeing737 = /B(3[789]M|73[1-9])/i.test(model || "");
        const isBoeing747 = /B74[1-48DRSCF]|BLCF/i.test(model || "");
        const isBoeing757 = /B75[023]/i.test(model || "");
        const isBoeing767 = /B76[234]|B462|B767/i.test(model || "");
        const isBoeing777 = /B77[2L3WX89F]/i.test(model || "");
        const isBoeing787 = /B78[89X]/i.test(model || "");
        const isEmbraerEJet = /E(19[05]|295)/i.test(model || "");

        let svgHtml = '';
        if (isAirbusA320) {
          // Custom Airbus A320 Family Silhouette (user-provided exact path)
          svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <path d="M 251.239 4.012 C 242.63 11.82 234.623 25.533 230.719 39.347 C 229.117 45.252 228.817 51.959 228.316 111.718 L 227.816 177.582 L 211.3 186.391 L 194.784 195.299 L 194.183 180.085 C 193.783 169.674 193.082 163.769 191.981 161.166 L 190.379 157.362 L 176.566 157.663 L 162.752 157.963 L 161.251 160.966 C 160.25 163.168 159.749 168.773 159.449 181.686 C 158.948 202.006 159.249 204.208 162.752 205.109 C 164.654 205.609 165.255 206.41 165.255 208.412 C 165.255 211.015 161.451 213.117 97.989 247.15 C 60.953 266.869 29.622 284.186 28.421 285.488 C 25.218 288.891 23.416 296.098 22.315 309.611 C 21.814 315.918 21.514 321.323 21.714 321.423 C 21.814 321.623 23.216 319.221 24.817 316.018 L 27.62 310.212 L 99.09 285.388 L 170.46 260.563 L 199.388 260.563 L 228.316 260.563 L 228.316 315.817 C 228.316 382.282 229.618 399.7 236.725 427.427 L 239.027 436.536 L 233.922 441.541 C 228.116 447.246 213.602 457.856 190.279 473.272 C 181.471 479.077 173.463 484.983 172.562 486.485 C 171.361 488.186 170.76 491.79 170.46 497.896 C 170.059 505.703 170.26 506.804 171.661 506.804 C 172.562 506.804 189.478 502.7 209.298 497.796 C 229.117 492.791 245.633 488.787 246.134 488.787 C 246.634 488.787 247.435 492.29 248.036 496.695 C 248.636 500.999 249.938 506.304 250.939 508.406 C 252.64 511.809 253.241 512.31 256.344 512.31 C 259.447 512.31 260.047 511.809 261.749 508.406 C 262.75 506.304 264.051 500.999 264.652 496.695 C 265.253 492.29 266.053 488.787 266.554 488.787 C 267.054 488.787 283.571 492.891 303.39 497.796 C 323.209 502.801 340.126 506.804 341.027 506.804 C 342.428 506.804 342.628 505.703 342.228 497.896 C 341.928 491.79 341.327 488.186 340.126 486.384 C 339.125 484.983 331.317 479.077 322.609 473.372 C 299.987 458.457 284.672 447.346 278.766 441.541 L 273.661 436.536 L 275.963 427.427 C 283.07 399.7 284.371 382.282 284.371 315.817 L 284.371 260.563 L 313.3 260.563 L 342.228 260.563 L 413.598 285.388 L 485.068 310.212 L 487.871 316.018 C 489.472 319.221 490.873 321.623 490.974 321.423 C 491.174 321.323 490.873 315.918 490.373 309.611 C 489.272 296.098 487.47 288.891 484.267 285.488 C 483.066 284.186 451.735 266.869 414.699 247.15 C 351.237 213.117 347.433 211.015 347.433 208.412 C 347.433 206.41 348.034 205.609 349.935 205.109 C 353.439 204.208 353.739 202.006 353.239 181.686 C 352.938 168.773 352.438 163.168 351.437 160.966 L 349.935 157.963 L 336.122 157.663 L 322.308 157.362 L 320.707 161.166 C 319.606 163.769 318.905 169.674 318.505 180.085 L 317.904 195.299 L 301.188 186.291 L 284.371 177.282 L 284.371 115.121 C 284.271 48.356 284.071 44.652 279.066 31.139 C 277.765 27.435 275.062 21.83 273.26 18.727 C 269.757 12.921 258.246 0.308 256.344 0.308 C 255.843 0.308 253.541 2.01 251.239 4.012 Z" fill="#fed700"/>
          </svg>
        `;
        } else if (isAirbusA330) {
          // Custom Airbus A330 Family Silhouette (user-provided exact path)
          svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2507 5080 c-68 -80 -132 -246 -161 -420 -28 -167 -36 -354 -36 -820 l0 -456 -47 -36 c-43 -32 -309 -198 -318 -198 -2 0 -5 56 -7 123 -2 86 -7 129 -17 140 -11 14 -33 17 -112 17 -134 0 -134 1 -134 -209 0 -152 1 -156 23 -166 59 -26 50 -32 -754 -534 -514 -321 -783 -495 -798 -515 -12 -17 -48 -66 -79 -108 -44 -60 -57 -85 -57 -113 0 -19 2 -35 5 -35 3 0 427 165 942 366 l938 366 185 14 c102 7 190 13 196 14 9 0 13 -138 17 -512 5 -512 13 -672 53 -983 14 -114 48 -297 60 -328 4 -11 -62 -59 -233 -172 -131 -86 -269 -178 -308 -203 -86 -58 -105 -91 -105 -184 0 -48 4 -68 13 -68 7 0 159 40 337 90 179 49 332 90 340 90 11 0 21 -28 38 -98 24 -106 43 -142 72 -142 29 0 48 36 72 142 17 70 27 98 38 98 8 0 161 -41 340 -90 178 -50 330 -90 337 -90 20 0 17 127 -5 170 -18 38 -9 31 -395 285 -173 114 -237 161 -233 172 13 32 46 214 60 328 42 336 56 603 56 1088 0 319 3 407 13 407 6 -1 95 -7 197 -14 l185 -14 938 -366 c515 -201 939 -366 942 -366 3 0 5 16 5 35 0 28 -13 53 -57 113 -31 42 -67 91 -79 108 -15 20 -285 195 -798 515 -804 502 -813 508 -753 534 21 10 22 14 22 166 0 210 0 209 -134 209 -79 0 -101 -3 -112 -17 -10 -11 -15 -54 -17 -140 -2 -67 -5 -123 -7 -123 -9 0 -275 166 -317 198 l-48 36 0 451 c0 600 -14 777 -75 988 -44 153 -129 297 -175 297 -10 0 -34 -18 -53 -40z" fill="#fed700"/>
            </g>
          </svg>
        `;
        } else if (isAirbusA340) {
          // Custom Airbus A340 Family Silhouette (user-provided exact path)
          svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2507 5053 c-58 -88 -78 -129 -116 -236 -73 -207 -74 -216 -80 -894 -6 -591 -7 -612 -26 -638 -11 -15 -92 -73 -180 -129 l-160 -103 -3 88 c-3 81 -5 90 -29 109 -42 33 -149 25 -175 -14 -4 -6 -8 -81 -8 -166 l0 -155 -306 -195 c-168 -107 -310 -196 -315 -198 -5 -2 -9 45 -9 111 0 125 -6 141 -56 153 -39 10 -114 -2 -133 -20 -13 -14 -17 -48 -21 -203 l-5 -187 -325 -207 -325 -207 -67 -104 c-55 -85 -67 -110 -67 -146 l-1 -42 60 30 c62 31 785 320 801 320 5 0 9 -6 9 -14 0 -7 6 -19 14 -25 12 -10 17 -8 25 8 6 11 11 28 11 39 0 14 14 25 53 40 28 11 59 23 68 27 13 5 18 -2 23 -29 8 -43 23 -47 32 -8 12 60 21 68 105 101 46 18 89 35 95 37 6 3 15 -9 20 -26 13 -45 26 -42 39 10 l11 45 104 41 105 41 10 -34 c14 -47 28 -43 39 11 l9 45 89 36 c48 19 94 35 101 35 7 0 17 -19 23 -42 12 -58 36 -57 50 2 13 53 16 54 194 65 l118 7 5 -468 c4 -479 13 -632 57 -989 11 -88 28 -198 37 -243 11 -56 13 -86 6 -90 -118 -75 -569 -392 -579 -407 -17 -27 -44 -131 -44 -173 0 -27 3 -32 18 -28 9 3 46 12 82 21 36 9 181 52 322 96 142 43 261 79 266 79 4 0 13 -28 20 -63 17 -89 30 -130 47 -152 15 -20 15 -20 30 0 17 22 30 63 47 153 7 34 16 62 21 62 4 0 103 -30 220 -66 175 -54 451 -134 464 -134 17 0 -16 167 -41 205 -10 15 -461 332 -579 407 -7 4 -5 34 6 90 9 45 26 155 37 243 44 357 53 510 57 989 l5 469 106 -7 c186 -12 189 -12 196 -54 3 -21 11 -44 16 -52 9 -13 12 -12 25 4 8 11 15 29 15 40 0 45 12 46 110 8 l95 -38 12 -48 c7 -27 15 -51 18 -54 10 -10 25 21 25 52 0 23 3 27 18 21 9 -4 58 -23 109 -42 85 -33 92 -38 98 -67 4 -17 9 -40 12 -50 5 -19 6 -19 19 -1 8 10 14 27 14 37 0 24 2 24 111 -20 l94 -38 7 -44 c4 -23 10 -45 13 -49 9 -8 25 21 25 47 0 28 3 27 75 -2 52 -21 60 -28 70 -62 13 -47 32 -54 46 -16 l10 29 382 -152 c210 -83 406 -164 435 -178 l52 -27 -1 42 c0 36 -12 61 -67 146 l-67 104 -325 207 -325 207 -6 189 c-3 105 -6 191 -7 192 -1 1 -16 10 -34 19 -40 21 -131 15 -156 -10 -13 -13 -18 -41 -22 -130 l-5 -113 -307 196 -308 196 0 157 0 157 -26 20 c-43 34 -150 26 -176 -13 -4 -6 -8 -49 -8 -95 0 -71 -2 -82 -16 -77 -43 16 -317 202 -332 224 -15 24 -18 85 -23 637 -5 577 -7 615 -28 707 -23 104 -70 247 -103 313 -29 58 -108 175 -118 175 -5 0 -29 -30 -53 -67z" fill="#fed700"/>
            </g>
          </svg>
        `;
        } else if (isAirbusA380) {
          // Custom Airbus A380 Superjumbo Silhouette (user-provided exact path)
          svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2504 5083 c-69 -68 -128 -238 -159 -453 -15 -107 -34 -457 -38 -720 l-2 -144 -265 -223 -265 -223 -5 130 c-4 101 -8 133 -20 140 -22 14 -184 12 -198 -2 -9 -9 -12 -76 -12 -239 l0 -226 -232 -195 -233 -196 -3 129 c-3 129 -3 130 -28 139 -33 13 -145 13 -178 0 l-26 -10 0 -227 0 -228 -358 -301 c-196 -165 -367 -315 -380 -334 -40 -59 -54 -127 -59 -270 l-4 -135 29 32 c22 26 113 70 432 212 223 99 411 181 419 183 8 2 17 -10 23 -29 11 -40 35 -43 44 -5 16 73 17 75 115 119 52 23 97 42 102 42 4 1 7 -8 7 -18 0 -62 35 -68 50 -8 6 23 12 47 14 52 3 8 118 63 191 91 7 3 17 -12 24 -36 17 -58 38 -51 51 18 l12 59 366 162 c202 90 372 165 379 168 8 3 12 -143 16 -584 5 -619 11 -714 56 -876 l19 -68 -317 -262 c-174 -143 -322 -268 -329 -277 -76 -89 -134 -226 -148 -348 -11 -98 -18 -99 454 81 389 148 407 154 414 133 3 -11 18 -77 33 -146 54 -252 76 -252 130 0 15 69 30 135 33 146 7 21 25 15 414 -133 472 -180 465 -179 454 -81 -14 122 -72 259 -148 348 -7 9 -155 134 -329 277 l-317 262 19 68 c45 162 51 257 56 876 4 441 8 587 16 584 7 -3 177 -78 379 -168 l366 -162 12 -59 c13 -69 34 -76 51 -18 7 24 17 39 24 36 73 -28 188 -83 191 -91 2 -5 8 -29 14 -52 15 -60 50 -54 50 8 0 10 3 19 8 18 4 0 49 -19 101 -42 98 -44 99 -46 115 -119 9 -38 33 -35 44 5 6 19 15 31 23 29 8 -2 196 -84 419 -183 319 -142 410 -186 432 -212 l29 -32 -4 135 c-5 139 -18 205 -56 267 -11 17 -182 168 -380 335 l-361 303 0 227 c0 214 -1 228 -19 238 -25 13 -151 13 -185 0 -25 -9 -25 -10 -28 -139 l-3 -129 -232 196 -233 195 0 226 c0 163 -3 230 -12 239 -14 14 -176 16 -198 2 -12 -7 -16 -39 -20 -140 l-5 -130 -265 223 -265 223 -2 144 c-4 263 -23 613 -38 720 -20 138 -58 280 -96 358 -35 71 -90 132 -119 132 -11 0 -36 -16 -56 -37z" fill="#fed700"/>
            </g>
          </svg>
        `;
        } else if (isBoeing737) {
          // Custom Boeing 737 Silhouette (user-provided exact path)
          svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0,512) scale(0.1,-0.1)">
              <path d="M2517 5043 c-135 -290 -233 -673 -267 -1043 -5 -63 -10 -246 -10 -406 l0 -292 -64 -59 c-94 -88 -302 -243 -327 -243 -5 0 -9 29 -9 65 l0 66 -107 -3 -108 -3 -5 -128 -5 -129 -690 -339 c-379 -187 -701 -350 -714 -362 -48 -44 -71 -113 -71 -214 0 -63 4 -93 11 -93 11 0 1377 381 1433 400 26 9 33 6 65 -28 28 -29 39 -52 49 -101 16 -78 36 -77 40 2 3 53 5 57 28 57 44 0 64 17 64 55 l0 35 98 0 c53 0 140 -3 193 -6 l96 -7 6 -326 c7 -429 39 -804 89 -1046 11 -55 21 -106 22 -114 0 -8 -60 -57 -135 -110 -340 -240 -561 -405 -568 -425 -9 -23 -22 -246 -15 -246 5 0 840 208 865 216 12 3 18 -7 25 -43 l9 -48 45 0 45 0 9 48 c7 36 13 46 25 43 59 -18 864 -216 867 -214 2 2 0 59 -5 126 -6 102 -11 126 -27 141 -25 25 -484 356 -602 434 -75 50 -91 66 -87 82 63 249 104 669 112 1156 l6 326 96 7 c53 3 140 6 194 6 l97 0 0 -35 c0 -38 20 -55 64 -55 23 0 25 -4 28 -57 4 -79 24 -80 40 -2 10 49 21 72 49 101 32 34 39 37 65 28 56 -19 1422 -400 1433 -400 7 0 11 30 11 93 0 101 -23 170 -71 214 -13 12 -335 175 -714 362 l-690 339 -5 129 -5 128 -107 3 -108 3 0 -66 c0 -36 -4 -65 -9 -65 -25 0 -233 155 -327 243 l-64 59 0 292 c0 160 -5 343 -10 406 -28 299 -99 616 -197 875 -42 111 -104 245 -113 245 -4 0 -23 -35 -43 -77z" fill="#fed700"/>
            </g>
          </svg>
        `;
        } else if (isBoeing747) {
          // Custom Boeing 747 Silhouette (user-provided exact path)
          svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2512 5104 c-83 -58 -152 -303 -182 -639 -6 -66 -14 -281 -17 -478 l-6 -358 -226 -199 -226 -200 -5 66 c-6 82 -20 94 -105 94 -98 0 -105 -9 -105 -138 0 -59 4 -113 9 -120 4 -7 20 -16 36 -20 27 -8 16 -18 -256 -259 l-284 -252 -3 77 c-2 42 -8 82 -14 89 -14 17 -159 18 -176 1 -8 -8 -12 -52 -12 -130 0 -96 3 -120 15 -124 9 -4 15 -19 15 -38 -1 -28 -27 -54 -285 -281 l-284 -250 0 -235 c0 -129 3 -228 6 -220 4 8 13 48 22 89 l16 74 590 335 590 335 325 104 c179 57 333 106 343 109 16 5 17 -27 17 -579 0 -450 4 -619 15 -738 16 -163 40 -314 55 -353 10 -27 16 -20 -426 -447 l-202 -194 -7 -108 c-4 -60 -5 -111 -2 -113 2 -3 168 44 368 104 200 60 365 108 367 107 2 -2 12 -42 23 -89 12 -47 29 -96 40 -108 l19 -23 19 23 c11 12 28 61 40 108 11 47 21 87 23 89 2 1 167 -47 367 -107 200 -60 366 -107 368 -104 3 2 2 53 -2 113 l-7 108 -202 194 c-442 427 -436 420 -426 447 15 39 39 190 55 353 11 119 15 288 15 738 0 552 1 584 18 579 9 -3 163 -52 342 -109 l326 -104 589 -335 590 -335 16 -74 c9 -41 18 -81 22 -89 3 -8 6 91 6 220 l0 235 -284 250 c-258 227 -284 253 -285 281 0 19 6 34 15 38 12 4 15 28 15 124 0 78 -4 122 -12 130 -17 17 -162 16 -176 -1 -6 -7 -12 -47 -14 -89 l-3 -77 -284 252 c-272 241 -283 251 -256 259 16 4 32 13 36 20 5 7 9 61 9 120 0 129 -7 138 -105 138 -85 0 -99 -12 -105 -94 l-5 -66 -226 200 -226 199 -6 358 c-4 197 -11 412 -17 478 -36 406 -123 655 -230 655 -14 0 -36 -7 -48 -16z" fill="#fed700"/>
            </g>
          </svg>
        `;
        } else if (isBoeing757) {
          // Custom Boeing 757 Silhouette (user-provided exact path)
          svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2518 5102 c-61 -40 -106 -129 -139 -279 -22 -95 -23 -120 -28 -917 l-6 -820 -125 -48 c-69 -26 -141 -54 -161 -62 l-36 -15 14 52 c18 64 13 220 -8 262 -21 43 -52 55 -154 55 -102 0 -130 -11 -158 -57 -45 -77 -27 -281 29 -331 14 -12 26 -34 27 -48 2 -26 -10 -31 -692 -295 -764 -295 -743 -284 -781 -387 -21 -56 -42 -210 -29 -217 3 -3 18 18 33 45 39 72 72 96 145 103 69 7 493 91 992 196 l337 71 270 0 270 0 11 -31 c8 -22 11 -231 11 -663 0 -619 1 -634 25 -801 13 -94 31 -193 39 -219 8 -27 13 -53 10 -58 -6 -10 -130 -101 -401 -296 l-211 -152 -16 -67 c-8 -37 -14 -68 -13 -69 1 -2 158 36 349 84 191 48 349 84 352 82 2 -3 13 -52 23 -110 l19 -105 44 0 44 0 19 105 c10 58 21 107 23 110 3 2 161 -34 352 -82 191 -48 348 -86 349 -84 1 1 -5 32 -13 69 l-16 67 -211 152 c-271 195 -395 286 -401 296 -3 5 2 31 10 58 8 26 26 125 39 219 24 167 25 182 25 801 0 432 3 641 11 663 l11 31 269 0 270 0 457 -94 c251 -52 556 -113 677 -136 121 -23 230 -47 243 -53 12 -6 46 -39 74 -73 29 -34 55 -61 58 -59 12 7 -10 163 -30 217 -38 103 -17 92 -781 387 -682 264 -694 269 -692 295 1 14 13 36 27 48 56 50 74 254 29 331 -28 46 -56 57 -158 57 -102 0 -133 -12 -154 -55 -21 -42 -26 -198 -8 -262 l14 -52 -36 15 c-20 8 -92 36 -161 62 l-125 48 -6 820 c-5 797 -6 822 -28 917 -23 104 -57 191 -91 235 -25 32 -69 62 -90 62 -8 0 -27 -8 -42 -18z" fill="#fed700"/>
            </g>
          </svg>
        `;
        } else if (isBoeing767) {
          // Custom Boeing 767 Silhouette (user-provided exact path)
          svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2504 5088 c-123 -108 -199 -352 -224 -720 -6 -84 -10 -331 -9 -548 l0 -395 -34 -40 c-29 -35 -365 -285 -381 -285 -4 0 -3 62 0 138 6 131 6 138 -16 165 l-22 28 -121 -3 -122 -3 -19 -38 c-17 -36 -18 -49 -7 -180 10 -123 14 -144 32 -159 17 -14 20 -27 17 -75 l-3 -58 -230 -159 c-126 -87 -477 -328 -779 -534 -456 -312 -551 -381 -562 -408 -17 -41 -19 -175 -2 -192 7 -7 21 -12 31 -12 18 0 542 194 1077 399 222 85 236 89 244 70 13 -28 32 -23 42 12 8 26 19 35 84 60 58 23 312 79 359 79 5 0 12 -11 15 -25 9 -34 33 -31 41 5 8 35 1 32 195 65 85 15 163 29 173 31 16 5 17 -22 17 -478 0 -367 4 -514 15 -613 17 -142 40 -282 54 -333 9 -31 7 -35 -37 -76 -55 -51 -327 -282 -564 -479 -132 -110 -167 -144 -172 -169 -7 -37 -8 -158 -1 -158 3 0 203 50 445 110 242 61 444 110 449 110 5 0 12 -15 16 -32 33 -168 77 -168 110 0 4 17 11 32 16 32 5 0 207 -50 449 -110 242 -61 442 -110 445 -110 7 0 6 121 -1 158 -5 25 -40 59 -172 169 -237 197 -509 428 -564 479 -44 41 -46 45 -37 76 14 51 37 191 54 333 11 99 15 246 15 613 0 456 1 483 18 478 9 -2 87 -16 172 -31 194 -33 187 -30 195 -65 8 -36 32 -39 41 -5 3 14 10 25 15 25 47 0 301 -56 359 -79 65 -25 76 -34 84 -60 10 -35 29 -40 42 -12 8 19 22 15 244 -70 535 -205 1059 -399 1077 -399 10 0 24 5 31 12 17 17 15 151 -2 192 -11 27 -106 96 -562 408 -302 206 -652 447 -779 534 l-230 159 -3 58 c-3 48 0 61 17 75 18 15 22 37 32 154 12 148 5 199 -31 218 -10 6 -68 10 -129 10 -108 0 -110 0 -131 -27 -21 -27 -22 -34 -16 -165 4 -76 4 -138 1 -138 -17 0 -352 250 -382 285 l-34 40 0 395 c2 575 -19 812 -90 1026 -47 142 -143 274 -199 274 -11 0 -36 -15 -56 -32z" fill="#fed700"/>
            </g>
          </svg>
        `;
        } else if (isBoeing777) {
          // Custom Boeing 777 Silhouette (user-provided exact path)
          svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2498 5101 c-61 -48 -124 -222 -158 -436 -33 -206 -41 -346 -47 -816 l-6 -456 -150 -104 c-83 -57 -155 -105 -159 -107 -4 -2 -8 43 -8 101 0 122 -13 149 -83 168 -51 14 -155 5 -197 -16 l-30 -16 0 -192 c0 -161 3 -196 16 -216 14 -19 14 -25 3 -36 -8 -7 -348 -243 -756 -525 -843 -581 -784 -531 -791 -683 -6 -108 1 -114 86 -75 100 44 522 218 1008 414 l431 173 311 7 311 7 4 -589 4 -589 31 -175 32 -174 -20 -21 c-11 -11 -161 -135 -333 -276 l-312 -255 -3 -98 c-2 -88 -1 -98 14 -92 89 34 758 256 761 252 3 -3 19 -62 37 -132 21 -83 38 -131 49 -138 34 -21 50 5 83 138 18 70 34 129 37 132 3 4 672 -218 761 -252 15 -6 16 4 14 92 l-3 98 -312 255 c-172 141 -322 265 -333 276 l-20 21 32 174 31 175 4 589 4 589 311 -7 311 -7 431 -173 c486 -196 908 -370 1008 -414 85 -39 92 -33 86 75 -7 152 52 102 -791 683 -408 282 -746 516 -751 521 -6 5 -2 24 8 46 14 32 16 66 14 217 -3 178 -3 179 -28 198 -33 24 -140 34 -198 19 -68 -19 -76 -35 -82 -166 l-5 -114 -161 111 -161 112 -6 455 c-3 251 -11 510 -17 576 -24 268 -72 485 -132 598 -39 72 -69 97 -118 97 -22 0 -48 -8 -62 -19z" fill="#fed700"/>
            </g>
          </svg>
        `;
        } else if (isBoeing787) {
          // Custom Boeing 787 Dreamliner Silhouette (user-provided exact path)
          svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2496 5099 c-57 -45 -109 -172 -145 -351 -47 -237 -61 -444 -61 -913 l-1 -370 -187 -149 -187 -148 -5 151 c-7 201 -2 196 -181 196 l-131 0 -24 -28 c-24 -28 -24 -31 -24 -236 0 -196 1 -210 21 -235 11 -14 28 -26 37 -26 10 0 22 -8 29 -19 10 -16 -52 -69 -633 -536 -635 -511 -750 -612 -819 -720 -62 -96 -104 -242 -76 -260 7 -4 37 17 73 50 169 156 230 188 1146 589 l403 176 274 0 274 0 3 -487 c4 -439 6 -504 27 -653 12 -91 31 -204 41 -253 l18 -88 -308 -294 -307 -295 -7 -76 c-9 -107 -8 -124 7 -124 6 0 147 59 311 130 224 97 310 130 341 130 l41 0 12 -58 c6 -31 22 -78 34 -102 22 -43 25 -45 68 -45 43 0 46 2 68 45 12 24 28 71 34 102 l12 58 41 0 c31 0 117 -33 341 -130 164 -71 305 -130 313 -130 11 0 13 15 7 77 -3 42 -6 86 -6 98 0 16 -85 104 -309 318 l-309 296 18 88 c10 49 29 162 41 253 21 149 23 214 27 652 l3 488 274 0 274 0 403 -176 c916 -401 977 -433 1146 -589 36 -33 66 -54 73 -50 28 18 -14 164 -76 260 -69 108 -184 209 -819 720 -581 467 -643 520 -633 536 7 11 19 19 29 19 9 0 26 12 37 26 20 25 21 39 21 235 0 205 0 208 -24 236 l-24 28 -131 0 c-179 0 -174 5 -181 -197 l-5 -151 -185 149 -185 149 -6 455 c-7 495 -15 594 -60 828 -49 247 -119 372 -209 372 -23 0 -48 -8 -64 -21z" fill="#fed700"/>
            </g>
          </svg>
        `;
        } else if (isEmbraerEJet) {
          // Custom Embraer E-Jet Family Silhouette (user-provided exact path)
          svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2518 5102 c-61 -40 -106 -129 -139 -279 -22 -95 -23 -120 -28 -917 l-6 -820 -125 -48 c-69 -26 -141 -54 -161 -62 l-36 -15 14 52 c18 64 13 220 -8 262 -21 43 -52 55 -154 55 -102 0 -130 -11 -158 -57 -45 -77 -27 -281 29 -331 14 -12 26 -34 27 -48 2 -26 -10 -31 -692 -295 -764 -295 -743 -284 -781 -387 -21 -56 -42 -210 -29 -217 3 -3 18 18 33 45 39 72 72 96 145 103 69 7 493 91 992 196 l337 71 270 0 270 0 11 -31 c8 -22 11 -231 11 -663 0 -619 1 -634 25 -801 13 -94 31 -193 39 -219 8 -27 13 -53 10 -58 -6 -10 -130 -101 -401 -296 l-211 -152 -16 -67 c-8 -37 -14 -68 -13 -69 1 -2 158 36 349 84 191 48 349 84 352 82 2 -3 13 -52 23 -110 l19 -105 44 0 44 0 19 105 c10 58 21 107 23 110 3 2 161 -34 352 -82 191 -48 348 -86 349 -84 1 1 -5 32 -13 69 l-16 67 -211 152 c-271 195 -395 286 -401 296 -3 5 2 31 10 58 8 26 26 125 39 219 24 167 25 182 25 801 0 432 3 641 11 663 l11 31 269 0 270 0 457 -94 c251 -52 556 -113 677 -136 121 -23 230 -47 243 -53 12 -6 46 -39 74 -73 29 -34 55 -61 58 -59 12 7 -10 163 -30 217 -38 103 -17 92 -781 387 -682 264 -694 269 -692 295 1 14 13 36 27 48 56 50 74 254 29 331 -28 46 -56 57 -158 57 -102 0 -133 -12 -154 -55 -21 -42 -26 -198 -8 -262 l14 -52 -36 15 c-20 8 -92 36 -161 62 l-125 48 -6 820 c-5 797 -6 822 -28 917 -23 104 -57 191 -91 235 -25 32 -69 62 -90 62 -8 0 -27 -8 -42 -18z" fill="#fed700"/>
            </g>
          </svg>
        `;
        } else {
          // Default Icon
          svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="-23.0965 -12.669 72.53 48.12" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <path d="M 16.793 12.613 H 32.585 l 15.491 -1.694 C 49.762 9.725 49.856 4.163 48.479 3.318 L 32.109 1.648 l -10.228 0 l -4.852 -1.868 L 16.139 -10.215 L 20.714 -10.552 C 20.971 -10.809 20.886 -11.009 20.714 -11.151 L 13.982 -11.067 L 13.276 -12.669 L 12.519 -11.032 L 5.731 -11.214 C 5.524 -11.108 5.56 -10.745 5.748 -10.598 L 10.257 -10.265 l -0.809 9.966 l -4.372 1.874 L -5.835 1.648 L -21.841 3.135 C -23.646 3.254 -23.46 10.775 -21.571 10.893 L -5.854 12.528 L 9.609 12.613 L 11.801 29.78 L 0.57 29.847 C -1.858 30.337 -0.087 35.092 0.879 35.454 l 24.282 0 C 27.535 34.283 27.704 29.561 25.157 29.746 L 14.652 29.78 Z" fill="black" stroke="black" stroke-width="0.8"/>
            <path d="M 16.793 12.613 H 32.585 l 15.491 -1.694 C 49.762 9.725 49.856 4.163 48.479 3.318 L 32.109 1.648 l -10.228 0 l -4.852 -1.868 L 16.139 -10.215 L 20.714 -10.552 C 20.971 -10.809 20.886 -11.009 20.714 -11.151 L 13.982 -11.067 L 13.276 -12.669 L 12.519 -11.032 L 5.731 -11.214 C 5.524 -11.108 5.56 -10.745 5.748 -10.598 L 10.257 -10.265 l -0.809 9.966 l -4.372 1.874 L -5.835 1.648 L -21.841 3.135 C -23.646 3.254 -23.46 10.775 -21.571 10.893 L -5.854 12.528 L 9.609 12.613 L 11.801 29.78 L 0.57 29.847 C -1.858 30.337 -0.087 35.092 0.879 35.454 l 24.282 0 C 27.535 34.283 27.704 29.561 25.157 29.746 L 14.652 29.78 Z" fill="#fed700"/>
          </svg>
        `;
        }

        return L.divIcon({
          className: 'aircraft-icon',
          html: svgHtml,
          iconSize: [32, 32],
          iconAnchor: [16, 16],
          popupAnchor: [0, -16]
        });
      }

      // Parse aircraft information from KML file
      function parseKMLAircraftInfo(kmlText) {
        try {
          const xml = new DOMParser().parseFromString(kmlText, "text/xml");
          const descriptionCDATA = xml.querySelector("Document > description")?.textContent;

          if (!descriptionCDATA) {
            return null;
          }

          const rawText = descriptionCDATA;
          const aircraftInfo = {};

          // Extract Commercial, Callsign, and Operator
          const pattern1 = /<span[^>]*>\s*<a[^>]*>([A-Z0-9]+)<\/a>\s*<\/span>\s*\/\s*([A-Z0-9]+)<br[^>]*>\s*([^<\n\r]+)/i;
          const match1 = rawText.match(pattern1);

          if (match1) {
            aircraftInfo.Commercial = match1[1];
            aircraftInfo.callsign = match1[2];
            aircraftInfo.operator = match1[3].trim();
          } else {
            // Try simpler pattern
            const pattern2 = /([A-Z0-9]+)\s*\/\s*([A-Z0-9]+)\s*<br[^>]*>\s*([^<\n\r]+)/i;
            const match2 = rawText.match(pattern2);

            if (match2) {
              aircraftInfo.Commercial = match2[1];
              aircraftInfo.callsign = match2[2];
              aircraftInfo.operator = match2[3].trim();
            }
          }

          // Extract image
          const html = new DOMParser().parseFromString(descriptionCDATA, "text/html");
          aircraftInfo.Img = html.querySelector("img")?.src || "";

          // Extract copyright
          const copyrightPattern = /&copy;([^<]+)<\/span>/i;
          const copyrightMatch = rawText.match(copyrightPattern);

          if (copyrightMatch) {
            aircraftInfo.Copyright = " " + copyrightMatch[1].trim();
          } else {
            const copyrightPattern2 = /([^<]+)<\/span>/i;
            const copyrightMatch2 = rawText.match(copyrightPattern2);

            if (copyrightMatch2) {
              aircraftInfo.Copyright = " " + copyrightMatch2[1].trim();
            }
          }

          // Extract airports and cities
          const airports = html.querySelectorAll("h3");
          const cities = html.querySelectorAll("a[title$='Airport']");

          aircraftInfo.DepartureAirport = airports[0]?.textContent || "";
          aircraftInfo.ArrivalAirport = airports[1]?.textContent || "";

          aircraftInfo.DepartureCity = cities[0]?.textContent.replace(aircraftInfo.DepartureAirport, "").trim() || "";
          aircraftInfo.ArrivalCity = cities[1]?.textContent.replace(aircraftInfo.ArrivalAirport, "").trim() || "";

          // Extract times
          const times = html.querySelectorAll("span[title^='202']");

          aircraftInfo.STD = times[0] ? times[0].title + " UTC" : "";
          aircraftInfo.ATD = times[1] ? times[1].title + " UTC" : "";
          aircraftInfo.STA = times[2] ? times[2].title + " UTC" : "";
          aircraftInfo.ETA = times[3] ? times[3].title + " UTC" : "";

          // Extract aircraft model and ICAO code
          const aircraftRow = Array.from(html.querySelectorAll('td')).find(td =>
            td.textContent.includes('Aircraft')
          );

          if (aircraftRow) {
            const aircraftText = aircraftRow.textContent.trim();
            const icaoMatch = aircraftText.match(/\(([A-Z0-9]+)\)/);
            if (icaoMatch) {
              aircraftInfo.ACICAOCode = icaoMatch[1];
            }

            const boldSpan = aircraftRow.querySelector('span[style*="font-weight: bold"]');
            if (boldSpan) {
              aircraftInfo.ACModel = boldSpan.textContent.trim();
            }
          }

          // Extract registration
          aircraftInfo.Registration = html.querySelector("a[href*='/reg/']")?.textContent.trim() || "";

          // Extract bigger photo link from line 10 (target="_blank" href="...")
          const biggerPhotoPattern = /target="_blank"\s+href="([^"]+)"/i;
          const biggerPhotoMatch = rawText.match(biggerPhotoPattern);

          if (biggerPhotoMatch) {
            aircraftInfo.BiggerPhoto = biggerPhotoMatch[1];
          } else {
            // Try alternative pattern (href before target)
            const altPattern = /href="([^"]+)"\s+target="_blank"/i;
            const altMatch = rawText.match(altPattern);
            if (altMatch) {
              aircraftInfo.BiggerPhoto = altMatch[1];
            }
          }

          return aircraftInfo;
        } catch (error) {
          console.error("Error parsing KML aircraft info:", error);
          return null;
        }
      }

      // Display aircraft information in the UI
      function displayAircraftInfo(aircraftInfo) {
        const photoEl = document.getElementById("ac-photo");

        if (!aircraftInfo) {
          // Clear all fields
          document.getElementById("ac-operator").textContent = "--";
          document.getElementById("ac-flight-number").textContent = "-- / --";
          document.getElementById("ac-registration").textContent = "--";
          document.getElementById("ac-departure-airport").textContent = "---";
          document.getElementById("ac-departure-city").textContent = "---";
          document.getElementById("ac-arrival-airport").textContent = "---";
          document.getElementById("ac-arrival-city").textContent = "---";
          document.getElementById("ac-dep-times").innerHTML = "STD --:-- UTC<br>ATD --:-- UTC";
          document.getElementById("ac-arr-times").innerHTML = "STA --:-- UTC<br>ETA --:-- UTC";
          document.getElementById("ac-model").textContent = "--";
          document.getElementById("ac-icao").textContent = "(----)";
          if (photoEl) photoEl.style.display = "none";
          return;
        }

        // Populate operator and flight info
        document.getElementById("ac-operator").textContent = aircraftInfo.operator || "--";

        // Flight number: "FR31 / RYR810Z"
        const flightNumber = `${aircraftInfo.Commercial || "--"} / ${aircraftInfo.callsign || "--"}`;
        document.getElementById("ac-flight-number").textContent = flightNumber;

        document.getElementById("ac-registration").textContent = aircraftInfo.Registration || "--";

        // Departure info
        document.getElementById("ac-departure-airport").textContent = aircraftInfo.DepartureAirport || "---";
        document.getElementById("ac-departure-city").textContent = aircraftInfo.DepartureCity || "---";

        // Arrival info
        document.getElementById("ac-arrival-airport").textContent = aircraftInfo.ArrivalAirport || "---";
        document.getElementById("ac-arrival-city").textContent = aircraftInfo.ArrivalCity || "---";

        // Times - format to show only time part
        const formatTime = (timeStr) => {
          if (!timeStr) return "--:--";
          // Extract time from "2024-01-28 12:30:00 UTC" format
          const match = timeStr.match(/(\d{2}:\d{2})/);
          return match ? match[1] : "--:--";
        };

        // Departure times
        const stdTime = formatTime(aircraftInfo.STD);
        const atdTime = formatTime(aircraftInfo.ATD);
        document.getElementById("ac-dep-times").innerHTML = `STD ${stdTime} UTC<br>ATD ${atdTime} UTC`;

        // Arrival times
        const staTime = formatTime(aircraftInfo.STA);
        const etaTime = formatTime(aircraftInfo.ETA);
        document.getElementById("ac-arr-times").innerHTML = `STA ${staTime} UTC<br>ETA ${etaTime} UTC`;

        // Aircraft model and ICAO
        document.getElementById("ac-model").textContent = aircraftInfo.ACModel || "--";
        document.getElementById("ac-icao").textContent = aircraftInfo.ACICAOCode ? `(${aircraftInfo.ACICAOCode})` : "(----)";

        // Photo
        const copyrightEl = document.getElementById("ac-photo-copyright");

        if (aircraftInfo.Img && photoEl) {
          photoEl.src = aircraftInfo.Img;
          photoEl.style.display = "block";

          // Display copyright overlay
          if (aircraftInfo.Copyright && copyrightEl) {
            copyrightEl.textContent = aircraftInfo.Copyright;
            copyrightEl.style.display = "block";
          } else if (copyrightEl) {
            copyrightEl.style.display = "none";
          }

          // Make photo clickable if BiggerPhoto link exists
          if (aircraftInfo.BiggerPhoto) {
            photoEl.style.cursor = "pointer";
            photoEl.onclick = function () {
              window.open(aircraftInfo.BiggerPhoto, '_blank');
            };
            photoEl.title = "Click to view larger image";
          } else {
            photoEl.style.cursor = "default";
            photoEl.onclick = null;
            photoEl.title = "";
          }
        } else if (photoEl) {
          photoEl.style.display = "none";
          photoEl.onclick = null;
          photoEl.style.cursor = "default";
          if (copyrightEl) {
            copyrightEl.style.display = "none";
          }
        }
      }

      const altitudeColorMap = [
        { alt: 42651, color: 'rgb(255,0,0)' },
        { alt: 41010, color: 'rgb(255,0,228)' },
        { alt: 39370, color: 'rgb(216,0,255)' },
        { alt: 37730, color: 'rgb(174,0,255)' },
        { alt: 36089, color: 'rgb(150,0,255)' },
        { alt: 34449, color: 'rgb(120,0,255)' },
        { alt: 32808, color: 'rgb(96,0,255)' },
        { alt: 31168, color: 'rgb(78,0,255)' },
        { alt: 29528, color: 'rgb(54,0,255)' },
        { alt: 27887, color: 'rgb(36,0,255)' },
        { alt: 26247, color: 'rgb(18,0,255)' },
        { alt: 24606, color: 'rgb(0,0,255)' },
        { alt: 22966, color: 'rgb(0,30,255)' },
        { alt: 21325, color: 'rgb(0,48,255)' },
        { alt: 19685, color: 'rgb(0,84,255)' },
        { alt: 18045, color: 'rgb(0,120,255)' },
        { alt: 16404, color: 'rgb(0,150,255)' },
        { alt: 14764, color: 'rgb(0,168,255)' },
        { alt: 13123, color: 'rgb(0,192,255)' },
        { alt: 11483, color: 'rgb(0,234,255)' },
        { alt: 9843, color: 'rgb(0,255,228)' },
        { alt: 8202, color: 'rgb(0,255,210)' },
        { alt: 6562, color: 'rgb(0,255,156)' },
        { alt: 4921, color: 'rgb(0,255,114)' },
        { alt: 3937, color: 'rgb(0,255,54)' },
        { alt: 3281, color: 'rgb(0,255,12)' },
        { alt: 2625, color: 'rgb(30,255,0)' },
        { alt: 1969, color: 'rgb(66,255,0)' },
        { alt: 1312, color: 'rgb(204,255,0)' },
        { alt: 984, color: 'rgb(240,255,0)' },
        { alt: 656, color: 'rgb(255,234,0)' },
        { alt: 328, color: 'rgb(255,224,98)' },
        { alt: 0, color: 'rgb(255,255,255)' }
      ];

      function getTrackWeight() {
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
        const isMacIPad = (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        return (isIOS || isMacIPad) ? 2 : 4;
      }


      function getColorFromAltitude(feet) {
        for (let i = 0; i < altitudeColorMap.length; i++) {
          if (feet >= altitudeColorMap[i].alt) {
            return altitudeColorMap[i].color;
          }
        }
        return 'rgb(255,255,255)';
      }

      // Convert RGB color string to Cesium Color
      function rgbToCesiumColor(rgbString) {
        const rgb = rgbString.match(/\d+/g).map(Number);
        return Cesium.Color.fromBytes(rgb[0], rgb[1], rgb[2]);
      }

      // Create 3D flight path in Cesium and attach to flight object
      async function addFlightTo3D(flight) {
        if (!viewer || !flight || !flight.points || flight.points.length === 0) return;

        const positionProperty = new Cesium.SampledPositionProperty();
        const orientationProperty = new Cesium.SampledProperty(Cesium.Quaternion);

        // Convert flight points format to expected format if needed
        let processedData = flight.points;
        if (processedData[0] && processedData[0].lat !== undefined) {
          // This is flight points format, convert it
          processedData = processedData.map(point => {
            let isoTime;
            if (point.rawUnix) {
              isoTime = new Date(point.rawUnix * 1000).toISOString();
            } else {
              // Fallback to trying to parse the string
              isoTime = new Date(point.utcTime).toISOString();
            }
            return {
              UTC: isoTime,
              Position: `${point.lat},${point.lng}`,
              Altitude: point.altitudeFeet || 0,
              Direction: point.direction || 0,
              Speed: point.speed || 0
            };
          });
        }

        const startTime = Cesium.JulianDate.fromDate(new Date(processedData[0].UTC));
        const stopTime = Cesium.JulianDate.fromDate(new Date(processedData[processedData.length - 1].UTC));

        // Store time window on the flight object
        flight.startTime = startTime.clone();
        flight.stopTime = stopTime.clone();

        // --- Terrain Clamping Logic ---
        const terrainSamplePositions = [];
        const terrainSampleIndices = [];

        processedData.forEach((row, index) => {
          const alt = row.Altitude || 0;
          if (alt < 3000) {
            const [lat, lon] = row.Position.split(',').map(Number);
            terrainSamplePositions.push(Cesium.Cartographic.fromDegrees(lon, lat));
            terrainSampleIndices.push(index);
          }
        });

        if (terrainSamplePositions.length > 0) {
          try {
            await Cesium.sampleTerrainMostDetailed(viewer.terrainProvider, terrainSamplePositions);

            for (let i = 0; i < terrainSamplePositions.length; i++) {
              const terrainHeight = terrainSamplePositions[i].height;
              const dataIndex = terrainSampleIndices[i];
              const originalAltMeters = (processedData[dataIndex].Altitude || 0) * 0.3048;

              if (terrainHeight !== undefined) {
                const buffer = 1.0;
                if (originalAltMeters < terrainHeight + buffer) {
                  processedData[dataIndex].ClampedAltitudeMeters = terrainHeight + buffer;
                }
              }
            }
          } catch (error) {
            console.warn("Terrain sampling failed, proceeding with original altitudes:", error);
          }
        }

        const pathPositions = [];
        const pathColors = [];

        processedData.forEach((row, i) => {
          const time = Cesium.JulianDate.fromDate(new Date(row.UTC));
          const [lat, lon] = row.Position.split(',').map(Number);

          let alt;
          if (row.ClampedAltitudeMeters !== undefined) {
            alt = row.ClampedAltitudeMeters;
          } else {
            alt = (row.Altitude || 0) * 0.3048;
          }

          const position = Cesium.Cartesian3.fromDegrees(lon, lat, alt);
          positionProperty.addSample(time, position);
          pathPositions.push(position);
          pathColors.push(rgbToCesiumColor(getColorFromAltitude(row.Altitude || 0)));

          const heading = Cesium.Math.toRadians(row.Direction || 0);
          let roll = 0;
          let pitch = 0;

          if (i < processedData.length - 1) {
            const nextRow = processedData[i + 1];
            let currentDir = row.Direction || 0;
            let nextDir = nextRow.Direction || 0;

            let diff = nextDir - currentDir;
            if (diff > 180) diff -= 360;
            if (diff < -180) diff += 360;

            const maxBank = 20;
            roll = diff * 2.0;
            if (roll > maxBank) roll = maxBank;
            if (roll < -maxBank) roll = -maxBank;
            roll = Cesium.Math.toRadians(roll);

            const currentAlt = (row.Altitude || 0);
            const nextAlt = (nextRow.Altitude || 0);
            const altDiff = nextAlt - currentAlt;
            const maxPitch = 15;
            pitch = altDiff * 0.1;
            if (pitch > maxPitch) pitch = maxPitch;
            if (pitch < -maxPitch) pitch = -maxPitch;
            pitch = Cesium.Math.toRadians(pitch);
          }

          const altitudeFeet = row.Altitude || 0;
          if (altitudeFeet <= 30) {
            pitch = 0;
            roll = 0;
          }

          const hpr = new Cesium.HeadingPitchRoll(heading - Cesium.Math.PI_OVER_TWO, pitch, roll);
          const orientation = Cesium.Transforms.headingPitchRollQuaternion(position, hpr);
          orientationProperty.addSample(time, orientation);
        });

        // Aircraft entity
        const aircraftEntity = viewer.entities.add({
          position: positionProperty,
          orientation: orientationProperty,
          model: {
            uri: 'https://raw.githubusercontent.com/Ysurac/FlightAirMap-3dmodels/master/pa28/glTF2/PA28.glb',
            minimumPixelSize: 0,
            maximumScale: 100,
            runAnimations: true
          },
          path: {
            resolution: 1,
            material: new Cesium.PolylineGlowMaterialProperty({
              glowPower: 0.1,
              color: Cesium.Color.YELLOW
            }),
            width: 2,
            trailTime: 1000,
            leadTime: 0
          },
          properties: {
            flightName: flight.name
          }
        });

        // Track Segments
        const segmentEntities = [];
        for (let i = 0; i < pathPositions.length - 1; i++) {
          const avgColor = Cesium.Color.lerp(
            pathColors[i],
            pathColors[i + 1],
            0.5,
            new Cesium.Color()
          );

          const segment = viewer.entities.add({
            polyline: {
              positions: [pathPositions[i], pathPositions[i + 1]],
              width: 6,
              material: avgColor
            }
          });
          segmentEntities.push(segment);
        }

        flight.cesiumEntity = aircraftEntity;
        flight.cesiumTrackEntities = segmentEntities;

        // Define zoom target: use track segments if available, otherwise aircraft
        const zoomTarget = segmentEntities.length > 0 ? segmentEntities : aircraftEntity;

        // Fly to top-down view (Pitch -90)
        viewer.flyTo(zoomTarget, {
          offset: new Cesium.HeadingPitchRange(0, Cesium.Math.toRadians(-90), 0)
        });

        return aircraftEntity;
      }

      function configure3DForFlight(index) {
        if (!viewer || index < 0 || index >= allFlights.length) return;
        const flight = allFlights[index];
        if (!flight.cesiumEntity || !flight.startTime || !flight.stopTime) return;

        viewer.clock.startTime = flight.startTime.clone();
        viewer.clock.stopTime = flight.stopTime.clone();
        viewer.clock.currentTime = flight.startTime.clone();
        viewer.clock.clockRange = Cesium.ClockRange.CLAMPED;
        viewer.clock.multiplier = getSpeedMultiplier();

        // Update global reference for follow functionality
        cesiumAircraftEntity = flight.cesiumEntity;

        // Update global reference for follow functionality
        cesiumAircraftEntity = flight.cesiumEntity;

        if (isFollowing) {
          viewer.trackedEntity = cesiumAircraftEntity;
        } else {
          viewer.trackedEntity = undefined;
          // Fly to top-down view of the track
          const zoomTarget = (flight.cesiumTrackEntities && flight.cesiumTrackEntities.length > 0)
            ? flight.cesiumTrackEntities
            : cesiumAircraftEntity;

          viewer.flyTo(zoomTarget, {
            offset: new Cesium.HeadingPitchRange(0, Cesium.Math.toRadians(-90), 0)
          });
        }
      }

      // Get speed multiplier from current playback speed
      function getSpeedMultiplier() {
        const speeds = [1, 2, 5, 10, 20, 50, 100, 200, 300];
        const speedIndex = parseInt(document.getElementById('speedControl').value);
        return speeds[speedIndex] || 1;
      }

      // Toggle between 2D and 3D mode
      async function toggle3DMode() {
        is3DMode = !is3DMode;

        if (is3DMode) {
          // Initialize Cesium if not already done
          if (!cesiumInitialized) {
            await initCesium();
            if (!cesiumInitialized) return; // Failed to initialize
          }

          // Switch to 3D
          document.getElementById('map').style.display = 'none';
          document.getElementById('cesiumContainer').style.display = 'block';

          // Show new buttons
          document.getElementById('followBtn').style.display = 'flex';
          document.getElementById('layerBtn').style.display = 'none';
          document.getElementById('layer3DBtn').style.display = 'flex';
          document.getElementById('searchBtn').style.display = 'flex';

          // Clear any old entities/state
          viewer.entities.removeAll();

          // Load ALL flights into 3D
          for (let i = 0; i < allFlights.length; i++) {
            const flight = allFlights[i];
            // Always add if not present (although we just wiped all)
            await addFlightTo3D(flight);
          }

          // Configure view for the CURRENT flight
          if (currentFlightIndex >= 0) {
            configure3DForFlight(currentFlightIndex);
            syncPlaybackTo3D();
          }

          // Apply visibility settings
          updateTrackVisibility();

          // Initialize state (must be after creating entity)
          isFollowing = false;
          updateFollowState();
        } else {
          // Switch to 2D
          document.getElementById('map').style.display = 'block';
          document.getElementById('cesiumContainer').style.display = 'none';
          document.getElementById('followBtn').style.display = 'none';
          document.getElementById('layerBtn').style.display = 'flex';
          document.getElementById('layer3DBtn').style.display = 'none';
          document.getElementById('searchBtn').style.display = 'none';
          // Hide geocoder if it was open
          const geocoderContainer = document.querySelector('.cesium-viewer-geocoderContainer');
          if (geocoderContainer) geocoderContainer.classList.remove('active');

          if (viewer) {
            syncPlaybackFrom3D();
          }
        }
      }

      // Sync playback state from 2D to 3D
      function syncPlaybackTo3D() {
        if (!viewer || !currentFlightData || !currentFlightData.points) return;

        const currentIndex = parseInt(document.getElementById('progressBar').value);
        const currentRow = currentFlightData.points[currentIndex];

        let currentTime;
        if (currentRow.rawUnix) {
          currentTime = Cesium.JulianDate.fromDate(new Date(currentRow.rawUnix * 1000));
        } else {
          // Fallback
          currentTime = Cesium.JulianDate.fromDate(new Date(currentRow.utcTime || currentRow.time));
        }

        viewer.clock.currentTime = currentTime;
        viewer.clock.shouldAnimate = isPlaying;
        viewer.clock.multiplier = getSpeedMultiplier();
      }

      // Sync playback state from 3D to 2D
      function syncPlaybackFrom3D() {
        if (!viewer || !currentFlightData || !currentFlightData.points) return;

        const currentTime = Cesium.JulianDate.toDate(viewer.clock.currentTime).getTime();

        // Find closest index in flight data
        let closestIndex = 0;
        let minDiff = Infinity;

        const points = currentFlightData.points;
        for (let i = 0; i < points.length; i++) {
          const point = points[i];
          // Use rawUnix if available, otherwise try parsing utcTime
          const pointTime = point.rawUnix ? point.rawUnix * 1000 : new Date(point.utcTime).getTime();

          const diff = Math.abs(pointTime - currentTime);
          if (diff < minDiff) {
            minDiff = diff;
            closestIndex = i;
          }
        }

        document.getElementById('progressBar').value = closestIndex;
        updateDisplay(closestIndex);
      }

      // Sync stats from 3D clock
      function syncStatsFrom3D() {
        if (!viewer || !currentFlightData || !currentFlightData.points) return;

        const currentTime = Cesium.JulianDate.toDate(viewer.clock.currentTime).getTime();

        // Find closest data point
        let closestIndex = 0;
        let minDiff = Infinity;

        const points = currentFlightData.points;
        for (let i = 0; i < points.length; i++) {
          const point = points[i];
          const pointTime = point.rawUnix ? point.rawUnix * 1000 : new Date(point.utcTime).getTime();

          const diff = Math.abs(pointTime - currentTime);
          if (diff < minDiff) {
            minDiff = diff;
            closestIndex = i;
          }
        }

        document.getElementById('progressBar').value = closestIndex;
        updateDisplay(closestIndex);
      }


      function formatTime(rawTimestamp) {
        if (!rawTimestamp) return 'Heure inconnue';
        let date;
        if (!isNaN(rawTimestamp) && rawTimestamp.length >= 10) {
          const num = Number(rawTimestamp);
          date = new Date(num > 1e12 ? num : num * 1000);
        } else {
          date = new Date(rawTimestamp);
        }
        if (isNaN(date.getTime())) return 'Heure inconnue';
        return date.toLocaleString('fr-FR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      }

      function formatUTCTime(utcTimestamp) {
        if (!utcTimestamp) return 'N/A';
        const date = new Date(utcTimestamp);
        if (isNaN(date.getTime())) return utcTimestamp;

        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const year = date.getUTCFullYear();
        const hours = String(date.getUTCHours()).padStart(2, '0');
        const minutes = String(date.getUTCMinutes()).padStart(2, '0');
        const seconds = String(date.getUTCSeconds()).padStart(2, '0');

        return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
      }

      const map = L.map('map', {
        preferCanvas: true,
        minZoom: 2,
        worldCopyJump: true
      }).setView([37.5, 14.2], 3);

      const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        crossOrigin: true,
        detectRetina: true
      });
      const esriTopo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; Esri',
        crossOrigin: true,
        detectRetina: true
      });
      const esriStreets = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; Esri',
        crossOrigin: true,
        detectRetina: true
      });
      const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; Esri',
        crossOrigin: true,
        detectRetina: true
      });
      const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://carto.com/">CartoDB</a>',
        subdomains: 'abcd',
        crossOrigin: true,
        detectRetina: true
      });
      const cartoDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://carto.com/">CartoDB</a>',
        subdomains: 'abcd',
        crossOrigin: true,
        detectRetina: true
      });
      const opentopomap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> contributors',
        crossOrigin: true,
        detectRetina: true
      });

      esriSatellite.addTo(map);
      L.control.scale().addTo(map);

      // Base layers object for easy access
      const baseLayers = {
        "Esri Satellite": esriSatellite,
        "OpenStreetMap": osmLayer,
        "Esri Topo": esriTopo,
        "Esri Streets": esriStreets,
        "CartoDB Light": cartoLight,
        "CartoDB Dark": cartoDark,
        "OpenTopoMap": opentopomap
      };

      let currentLayerName = "Esri Satellite";

      const layerBtn = document.getElementById('layerBtn');
      const layerModal = document.getElementById('layerModal');
      const infoBtn = document.getElementById('infoBtn');
      const infoModal = document.getElementById('infoModal');

      // Layer Menu Logic
      layerBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent click from bubbling to document
        layerModal.style.display = layerModal.style.display === 'block' ? 'none' : 'block';
        // Close other modals if open
        infoModal.style.display = 'none';
        const layer3DModal = document.getElementById('layer3DModal');
        if (layer3DModal) layer3DModal.style.display = 'none';
      });

      // Info Menu Logic
      infoBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        infoModal.style.display = infoModal.style.display === 'block' ? 'none' : 'block';
        // Close other modals if open
        layerModal.style.display = 'none';
        const layer3DModal = document.getElementById('layer3DModal');
        if (layer3DModal) layer3DModal.style.display = 'none';
      });

      // Close modals when clicking outside
      document.addEventListener('click', (e) => {
        if (layerModal.style.display === 'block' &&
          !layerModal.contains(e.target) &&
          e.target !== layerBtn &&
          !layerBtn.contains(e.target)) {
          layerModal.style.display = 'none';
        }

        if (infoModal.style.display === 'block' &&
          !infoModal.contains(e.target) &&
          e.target !== infoBtn &&
          !infoBtn.contains(e.target)) {
          infoModal.style.display = 'none';
        }
      });

      window.switchBaseLayer = function (name) {
        if (currentLayerName === name) {
          layerModal.style.display = 'none';
          return;
        }

        // Remove current layer
        if (baseLayers[currentLayerName]) {
          map.removeLayer(baseLayers[currentLayerName]);
        }

        // Add new layer
        if (baseLayers[name]) {
          map.addLayer(baseLayers[name]);
        }
        currentLayerName = name;

        // Update UI active state
        document.querySelectorAll('.layer-option').forEach(btn => {
          if (btn.textContent === name) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });

        // Close modal
        layerModal.style.display = 'none';
      };

      // 3D Layer Menu Logic
      const layer3DBtn = document.getElementById('layer3DBtn');
      const layer3DModal = document.getElementById('layer3DModal');
      let current3DLayerName = 'ArcGIS World Imagery';

      layer3DBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent click from bubbling to document
        layer3DModal.style.display = layer3DModal.style.display === 'block' ? 'none' : 'block';
        // Close other modals if open
        infoModal.style.display = 'none';
      });

      // Close 3D layer modal when clicking outside
      document.addEventListener('click', (e) => {
        if (layer3DModal.style.display === 'block' &&
          !layer3DModal.contains(e.target) &&
          e.target !== layer3DBtn &&
          !layer3DBtn.contains(e.target)) {
          layer3DModal.style.display = 'none';
        }
      });

      window.switch3DBaseLayer = function (name) {
        if (!viewer || current3DLayerName === name) {
          layer3DModal.style.display = 'none';
          return;
        }

        // Find the imagery provider view model by name
        const imageryViewModels = viewer.baseLayerPicker.viewModel.imageryProviderViewModels;
        let targetViewModel = null;

        for (let i = 0; i < imageryViewModels.length; i++) {
          if (imageryViewModels[i].name === name || imageryViewModels[i].name.includes(name)) {
            targetViewModel = imageryViewModels[i];
            break;
          }
        }

        if (targetViewModel) {
          viewer.baseLayerPicker.viewModel.selectedImagery = targetViewModel;
          current3DLayerName = name;
        }

        // Update UI active state
        document.querySelectorAll('#layer3DModal .layer-option').forEach(btn => {
          if (btn.textContent === name) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });

        // Close modal
        layer3DModal.style.display = 'none';
      };

      // Error Modal & Overlay
      const errorOverlay = document.createElement('div');
      errorOverlay.id = 'errorOverlay';
      document.body.appendChild(errorOverlay);

      const errorModal = document.createElement('div');
      errorModal.id = 'errorModal';
      errorModal.innerHTML = `
      <h3>File Format Error</h3>
      <p>One or more files format not supported.<br>Please use files from FlightRadar24 output.</p>
      <button id="errorOkBtn">OK</button>
    `;
      document.body.appendChild(errorModal);

      function closeErrorPopup() {
        document.getElementById('errorModal').style.display = 'none';
        document.getElementById('errorOverlay').style.display = 'none';
        // Reset input so same file can be selected again if needed
        if (multiFileInput) multiFileInput.value = '';
      }

      document.getElementById('errorOkBtn').addEventListener('click', closeErrorPopup);
      // Also close on overlay click?
      // errorOverlay.addEventListener('click', closeErrorPopup);

      function showErrorPopup() {
        document.getElementById('errorOverlay').style.display = 'block';
        document.getElementById('errorModal').style.display = 'block';
        // Also reset input immediately so if they cancel/close, it's ready
        if (multiFileInput) multiFileInput.value = '';

        // Reset main button text
        const btn = document.getElementById('multi_file_button');
        if (btn) btn.textContent = 'Select Flight file(s)';

        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) loadingOverlay.style.display = 'none';
      }

      const multiFileInput = document.getElementById('multiCsvFiles');

      // Apply file filter for PC and iPad, but leave open for iPhone
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      const isIPhone = /iPhone/i.test(ua) && !window.MSStream;
      if (!isIPhone) {
        multiFileInput.setAttribute('accept', '.csv, .kml');
      }
      const progressBar = document.getElementById('progressBar');
      const mainTitle = document.getElementById('multi_file_button');
      const heureEl = document.getElementById('heure');
      const altitudeEl = document.getElementById('altitude');
      const vitesseEl = document.getElementById('vitesse');
      const directionEl = document.getElementById('direction');
      const flightTimeEl = document.getElementById('flightTime');
      const playBtn = document.getElementById('playBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const speedControl = document.getElementById('speedControl');
      const flightSelector = document.getElementById('flightSelector');
      const flightSelectorContainer = document.getElementById('flightSelectorContainer');
      const flightSelectorToggle = document.getElementById('flightSelectorToggle');

      const speedPresets = [
        1000, // 1x
        500,  // 2x
        250,  // 4x
        125,  // 8x
        50,   // 20x
        25,   // 40x
        10,   // 100x
        5,    // 200x
        3.33  // 300x
      ];

      const speedMultipliers = [1, 2, 4, 8, 20, 40, 100, 200, 300];

      const speedLabels = [
        "1x", "2x", "4x", "8x", "20x", "40x", "100x", "200x", "300x"
      ];

      playPauseBtn.addEventListener('click', togglePlayPause);
      document.getElementById('screenshotBtn').addEventListener('click', takeScreenshot);
      flightSelectorToggle.addEventListener('click', function () {
        flightSelectorContainer.classList.toggle('collapsed');
      });

      speedControl.addEventListener('input', function () {
        const speedIndex = parseInt(this.value);
        playbackSpeed = speedPresets[speedIndex];
        speedIndicator.textContent = speedLabels[speedIndex];

        // Update 3D speed if in 3D mode
        if (is3DMode && viewer) {
          viewer.clock.multiplier = getSpeedMultiplier();
        }

        if (isPlaying) {
          pauseFlight();
          playFlight();
        }
      });

      // Add 3D toggle button event listener
      document.getElementById('toggle3DBtn').addEventListener('click', async () => {
        if (typeof toggle3DMode === 'function') {
          await toggle3DMode();
        }

        const f2dBtn = document.getElementById('follow2DBtn');
        const radarBtn = document.getElementById('radarBtn');

        // Hide/Show 2D-specific buttons
        const displayStyle = is3DMode ? 'none' : 'flex';

        if (f2dBtn) f2dBtn.style.display = displayStyle;
        if (radarBtn) radarBtn.style.display = displayStyle;
      });

      // Follow Mode Logic
      const followBtn = document.getElementById('followBtn');
      let isFollowing = false; // Default to not following

      followBtn.addEventListener('click', () => {
        if (!is3DMode || !viewer || !cesiumAircraftEntity) return;
        isFollowing = !isFollowing;
        updateFollowState();
      });

      function updateFollowState() {
        if (isFollowing) {
          viewer.trackedEntity = cesiumAircraftEntity;
          followBtn.classList.add('active');
          followBtn.style.color = 'white';
        } else {
          viewer.trackedEntity = undefined;
          followBtn.classList.remove('active');
          followBtn.style.color = '';
        }
      }

      // Follow Mode 2D Logic
      const follow2DBtn = document.getElementById('follow2DBtn');

      follow2DBtn.addEventListener('click', () => {
        isFollowing2D = !isFollowing2D;

        if (isFollowing2D) {
          follow2DBtn.classList.add('active');

          // Center immediately if we have a marker
          if (aircraftMarker) {
            map.panTo(aircraftMarker.getLatLng(), { animate: true });
          }
        } else {
          follow2DBtn.classList.remove('active');
        }
      });

      // TrueTime Button Logic
      const trueTimeBtn = document.getElementById('trueTimeBtn');
      trueTimeBtn.addEventListener('click', () => {
        isTrueTimeMode = !isTrueTimeMode;

        if (isTrueTimeMode) {
          trueTimeBtn.classList.add('active');
          // speedControl.disabled = true; // No longer disabling speed control
        } else {
          trueTimeBtn.classList.remove('active');
          // speedControl.disabled = false;
        }

        // Restart playback if playing to apply new mode
        if (isPlaying) {
          pauseFlight();
          playFlight();
        }
      });

      // Scrubbing Logic (Consolidated)
      progressBar.addEventListener('mousedown', () => isUserScrubbing = true);
      progressBar.addEventListener('touchstart', () => isUserScrubbing = true);

      progressBar.addEventListener('mouseup', () => isUserScrubbing = false);
      progressBar.addEventListener('touchend', () => isUserScrubbing = false);

      progressBar.addEventListener('input', function () {
        const val = parseFloat(this.value);
        const indexFloor = Math.floor(val);

        if (flightPathPoints && flightPathPoints[indexFloor]) {
          // Interpolate time based on slider float value
          const fraction = val - indexFloor;
          const indexCeil = Math.min(indexFloor + 1, flightPathPoints.length - 1);

          let t = 0;
          if (flightPathPoints[indexFloor] && flightPathPoints[indexCeil]) {
            t = flightPathPoints[indexFloor].rawUnix + (flightPathPoints[indexCeil].rawUnix - flightPathPoints[indexFloor].rawUnix) * fraction;
          } else {
            t = flightPathPoints[indexFloor].rawUnix;
          }

          // Update simulation time immediately
          currentSimulatedTime = t;

          // Visual update if paused
          if (!isPlaying) {
            updateDisplay(indexFloor);
            updateAircraftPosition(indexFloor);
          }
        }
      });

      // Maintain center on aircraft after zoom in Follow 2D mode
      map.on('zoomend', () => {
        if (isFollowing2D && aircraftMarker) {
          map.panTo(aircraftMarker.getLatLng(), { animate: true });
        }
      });

      // Search Button Logic (3D Mode)
      const searchBtn = document.getElementById('searchBtn');
      searchBtn.addEventListener('click', () => {
        if (!is3DMode || !viewer) return;
        const geocoderContainer = document.querySelector('.cesium-viewer-geocoderContainer');
        if (geocoderContainer) {
          const isActive = geocoderContainer.classList.contains('active');
          if (isActive) {
            geocoderContainer.classList.remove('active');
          } else {
            geocoderContainer.classList.add('active');
            // Focus the input after a short delay to ensure it's visible
            setTimeout(() => {
              const geocoderInput = document.querySelector('.cesium-geocoder-input');
              if (geocoderInput) geocoderInput.focus();
            }, 100);
          }
        }
      });

      // Close geocoder when clicking outside
      document.addEventListener('click', (e) => {
        const geocoderContainer = document.querySelector('.cesium-viewer-geocoderContainer');
        if (geocoderContainer && geocoderContainer.classList.contains('active')) {
          if (!geocoderContainer.contains(e.target) && e.target !== searchBtn && !searchBtn.contains(e.target)) {
            geocoderContainer.classList.remove('active');
          }
        }
      });

      // Radar Button Logic
      const radarBtn = document.getElementById('radarBtn');
      radarBtn.addEventListener('click', () => {
        radarModeEnabled = !radarModeEnabled;

        if (radarModeEnabled) {
          radarBtn.classList.add('active');
          createATCLabel();
        } else {
          radarBtn.classList.remove('active');
          removeATCLabel();
        }
      });

      function createATCLabel() {
        if (!aircraftMarker || !flightPathPoints || flightPathPoints.length === 0) return;

        // Remove existing label if any
        removeATCLabel();

        // Create the label element
        atcDataLabel = document.createElement('div');
        atcDataLabel.className = 'atc-data-label';

        // Get current flight data
        const currentIndex = parseInt(progressBar.value) || 0;
        const point = flightPathPoints[currentIndex];

        // Build the label content
        updateATCLabelContent(currentIndex);

        // Add to map container
        const mapContainer = document.getElementById('map');
        mapContainer.appendChild(atcDataLabel);

        // Position it relative to aircraft
        const aircraftLatLng = aircraftMarker.getLatLng();
        updateATCLabelPosition(aircraftLatLng);
      }

      function updateATCLabelContent(index, pointOverride = null) {
        if (!atcDataLabel || index < 0 || !flightPathPoints || !flightPathPoints[index]) return;

        // Use interpolated point if available, otherwise array point
        const point = pointOverride || flightPathPoints[index];
        const prevPoint = (index > 0) ? flightPathPoints[index - 1] : point; // Fallback

        // Calculate altitude trend
        let altTrendArrow = '';
        if (pointOverride && pointOverride.trend !== undefined) {
          altTrendArrow = pointOverride.trend;
        } else if (index > 0) {
          const pPrev = flightPathPoints[index - 1];
          const diff = point.altitudeFeet - pPrev.altitudeFeet;
          if (diff > 0.1) altTrendArrow = '^';
          else if (diff < -0.1) altTrendArrow = '';
        }

        // Get aircraft info
        const callsign = currentAircraftInfo?.callsign || flightName || 'N/A';
        const acIcao = point.model || currentAircraftInfo?.ACICAOCode || '----';
        const altitude = Math.round(point.altitudeFeet || 0);
        const speed = Math.round(point.speed || 0);
        const departure = currentAircraftInfo?.DepartureAirport || '----';
        const arrival = currentAircraftInfo?.ArrivalAirport || '----';

        // Format the label exactly as shown in screenshot, with arrow to the left of altitude
        atcDataLabel.innerHTML = `${callsign} ${acIcao}<br>${altTrendArrow}${altitude} ${speed}<br>${departure} ${arrival}`;
      }

      function updateATCLabelPosition(latLng) {
        if (!atcDataLabel || !map) return;

        // Convert lat/lng to pixel coordinates
        const point = map.latLngToContainerPoint(latLng);

        // Get limits and dimensions
        const mapContainer = map.getContainer();
        const mapWidth = mapContainer.clientWidth;
        const labelWidth = atcDataLabel.offsetWidth || 120; // Default estimate if not measured yet

        // Default position: 30px to the right
        let leftPos = point.x + 30;

        // Check if it overflows the right edge
        if (leftPos + labelWidth > mapWidth - 10) {
          // Flip to left side
          leftPos = point.x - 30 - labelWidth;
        }

        atcDataLabel.style.left = leftPos + 'px';
        atcDataLabel.style.top = (point.y - 10) + 'px';
      }

      function removeATCLabel() {
        if (atcDataLabel) {
          atcDataLabel.remove();
          atcDataLabel = null;
        }
      }

      // Update ATC label position on map move/zoom
      // We'll add event listeners after map is available
      // The map variable is accessed globally via window or directly
      setTimeout(() => {
        if (typeof map !== 'undefined' && map) {
          map.on('move', () => {
            if (radarModeEnabled && atcDataLabel && aircraftMarker) {
              updateATCLabelPosition(aircraftMarker.getLatLng());
            }
          });

          map.on('zoom', () => {
            if (radarModeEnabled && atcDataLabel && aircraftMarker) {
              updateATCLabelPosition(aircraftMarker.getLatLng());
            }
          });

          // Disable follow mode on manual drag
          map.on('dragstart', () => {
            if (isFollowing2D) {
              isFollowing2D = false;
              const btn = document.getElementById('follow2DBtn');
              if (btn) btn.classList.remove('active');
            }
          });
        }
      }, 1000);



      function togglePlayPause() {
        if (isPlaying) {
          pauseFlight();
        } else {
          playFlight();
        }
        updatePlayPauseButton();
      }

      function updatePlayPauseButton() {
        playPauseBtn.innerHTML = isPlaying ? '' : '';
      }

      function playFlight() {
        if (!isPlaying && flightPathPoints.length > 0) {
          // If we're at the end, start from the beginning
          if (parseInt(progressBar.value) >= flightPathPoints.length - 1) {
            progressBar.value = 0;
          }

          isPlaying = true;

          // Handle 3D mode playback
          if (is3DMode && viewer) {
            viewer.clock.shouldAnimate = true;
            // Use multiplier for 3D as well
            const speedIdx = parseInt(speedControl.value) || 0;
            const speedMult = speedMultipliers[speedIdx] || 1;

            viewer.clock.multiplier = isTrueTimeMode ? (1.0 * speedMult) : getSpeedMultiplier();
          } else {
            // 2D mode playback
            if (isTrueTimeMode) {
              const startIdx = parseInt(progressBar.value);
              const startPoint = flightPathPoints[startIdx] || flightPathPoints[0];

              // Only reset simulation time if we just entered TrueTime or switched tracks,
              // but here we are IN the playFlight function, which restarts the loop.
              // If scrubbing, we want to continue from current time.

              // If we are "resuming" play, currentSimulatedTime should match current slider
              // If we are "resuming" play, currentSimulatedTime should match current slider
              currentSimulatedTime = startPoint ? startPoint.rawUnix : 0;
              simulationLastFrameTime = performance.now();

              function animate() {
                if (!isPlaying || !isTrueTimeMode) return;

                const now = performance.now();
                let dt = (now - simulationLastFrameTime) / 1000; // Seconds elapsed

                // Safety cap on dt to prevent massive jumps if tab was inactive or paused for long time
                if (dt > 1.0) dt = 0.1;

                simulationLastFrameTime = now;

                // Get current speed multiplier
                const speedIdx = parseInt(speedControl.value) || 0;
                const speedMult = speedMultipliers[speedIdx] || 1;

                // Advance simulation time ONLY if not scrubbing
                if (!isUserScrubbing) {
                  currentSimulatedTime += dt * speedMult;
                } else {
                  // Update lastFrameTime so when we release, we don't jump
                  // Also keep currentSimulatedTime in sync with slider is handled by input listener
                  // But we might want to "play through" the scrub if user wants? 
                  // Usually "scrubbing while playing" means we override the time.
                  // The "input" listener sets currentSimulatedTime.
                }

                // Find updated index based on simulation time
                let i = parseInt(progressBar.value);

                // If we scrubbed, i matches currentSimulatedTime roughly
                if (i >= flightPathPoints.length) i = flightPathPoints.length - 1;

                // Re-sync index to time:
                // Check if currentSimulatedTime is within current segment [i, i+1]
                // If not, find the correct segment

                // Optimization: Search near i
                // If time is before current i, move back
                while (i > 0 && flightPathPoints[i].rawUnix > currentSimulatedTime) {
                  i--;
                }
                // If time is after next point, move forward
                while (i < flightPathPoints.length - 1 && flightPathPoints[i + 1].rawUnix < currentSimulatedTime) {
                  i++;
                }

                if (i >= flightPathPoints.length - 1) {
                  pauseFlight();
                  updatePlayPauseButton();
                  progressBar.value = flightPathPoints.length - 1;
                  return;
                }

                // Interpolate
                const p1 = flightPathPoints[i];
                const p2 = flightPathPoints[i + 1];

                let ratio = 0;
                if (p2.rawUnix > p1.rawUnix) {
                  ratio = (currentSimulatedTime - p1.rawUnix) / (p2.rawUnix - p1.rawUnix);
                }
                ratio = Math.max(0, Math.min(1, ratio));

                const lat = p1.lat + (p2.lat - p1.lat) * ratio;
                const lng = p1.lng + (p2.lng - p1.lng) * ratio;
                const alt = p1.altitudeFeet + (p2.altitudeFeet - p1.altitudeFeet) * ratio;
                const spd = p1.speed + (p2.speed - p1.speed) * ratio;

                // Determine Altitude Trend for Arrow
                let trendArrow = '';
                const altDiff = p2.altitudeFeet - p1.altitudeFeet;

                // Threshold to avoid flickering on flat flight (lowered to 0.1 for sensitivity)
                if (altDiff > 0.1) trendArrow = '^';
                else if (altDiff < -0.1) trendArrow = '';

                // Heading interpolation
                let d1 = p1.direction;
                let d2 = p2.direction;
                let diff = d2 - d1;
                if (diff > 180) diff -= 360;
                if (diff < -180) diff += 360;
                const hdg = (d1 + diff * ratio + 360) % 360;

                const interpolatedPoint = {
                  lat: lat,
                  lng: lng,
                  altitudeFeet: alt,
                  speed: spd,
                  direction: hdg,
                  model: p1.model,
                  time: p1.time,
                  utcTime: p1.utcTime,
                  trend: trendArrow // Pass trend to updateATCLabelContent
                };

                updateAircraftPositionData(interpolatedPoint);
                updateDisplayData(interpolatedPoint, i);

                // Update slider only if user is NOT scrubbing
                if (!isUserScrubbing) {
                  // Update slider with float value for smooth motion
                  progressBar.value = i + ratio;
                }

                trueTimeAnimationFrame = requestAnimationFrame(animate);
              }
              trueTimeAnimationFrame = requestAnimationFrame(animate);

            } else {
              playbackInterval = setInterval(() => {
                let currentIndex = parseInt(progressBar.value);

                if (currentIndex >= flightPathPoints.length - 1) {
                  pauseFlight();
                  updatePlayPauseButton();
                  return;
                }

                if (!isUserScrubbing) {
                  currentIndex++;
                  progressBar.value = currentIndex;
                  updateDisplay(currentIndex);
                  updateAircraftPosition(currentIndex);
                } else {
                  // Just update display for interactivity
                  updateDisplay(currentIndex);
                  updateAircraftPosition(currentIndex);
                }
              }, playbackSpeed);
            }
          }
        }
      }

      function pauseFlight() {
        clearInterval(playbackInterval);
        if (trueTimeAnimationFrame) {
          cancelAnimationFrame(trueTimeAnimationFrame);
          trueTimeAnimationFrame = null;
        }
        isPlaying = false;

        // Pause 3D mode if active
        if (is3DMode && viewer) {
          viewer.clock.shouldAnimate = false;
        }
      }


      function updateAircraftPosition(index) {
        if (!flightPathPoints || index >= flightPathPoints.length) return;
        updateAircraftPositionData(flightPathPoints[index]);
      }

      function updateAircraftPositionData(point) {
        if (!point || !aircraftMarker) return;

        aircraftMarker.setLatLng([point.lat, point.lng]);
        aircraftMarker.setIcon(createAircraftIcon(point.direction, point.model));

        // Update ATC data label position if radar mode is enabled
        if (radarModeEnabled && atcDataLabel) {
          updateATCLabelPosition([point.lat, point.lng]);
        }

        // Handle 2D Follow Mode or Bound Check
        if (isFollowing2D) {
          map.panTo([point.lat, point.lng], { animate: true });
        } else {
          const bounds = map.getBounds();
          if (!bounds.contains([point.lat, point.lng])) {
            map.panTo([point.lat, point.lng], { animate: true });
          }
        }
      }


      let activePointIndex = -1;

      function updateDisplay(index) {
        if (!flightPathPoints || index >= flightPathPoints.length) return;
        updateDisplayData(flightPathPoints[index], index);
      }

      function updateDisplayData(point, index = -1) {
        if (!point) return;

        if (index >= 0) {
          activePointIndex = index;
        }

        if (chartInstance && index >= 0) {
          // Drawing chart every frame might be expensive in TrueTime mode,
          // so maybe only if index changed?
          // For now keep as is, but in interpolation loop, we are calling this frequently.
          // chartInstance.draw() moves the vertical line.
          // We can optimize to only draw if index changed.
          if (activePointIndex !== -1) {
            // We need to update the annotation line on the chart
            // Since chart annotation uses 'value' which is usually index or time
            // If we use index for x-axis, we need the integer index.
          }
          chartInstance.draw();
        }

        heureEl.textContent = point.time;
        document.getElementById("UTCTime").textContent = point.utcTime;
        altitudeEl.textContent = Math.round(point.altitudeFeet);
        vitesseEl.textContent = Math.round(point.speed);
        directionEl.textContent = Math.round(point.direction);

        // Update ATC label content if radar mode is enabled
        if (radarModeEnabled && atcDataLabel && index >= 0) {
          updateATCLabelContent(index, point); // Pass point as override
        }
      }

      function handleSingleFile() {
        // This function might not be used if the input assumes multi-file, 
        // but if there were a single file input elsewhere, we'd update it too.
        // The current UI uses #multiCsvFiles for everything.
        // But preserving this just in case logic is shared.
        const file = multiFileInput.files[0];
        if (file) {
          clearAllFlights();
          flightSelector.style.display = 'none';
          const flightToggleBtn = document.getElementById('flightSelectorToggle');
          if (flightToggleBtn) flightToggleBtn.style.display = 'none';

          if (file.name.toLowerCase().endsWith('.kml')) {
            processKMLFile(file, 0, true);
          } else {
            processCSVFile(file, 0, true);
          }
        }
      }

      function handleMultiFiles() {
        const files = multiFileInput.files;
        const flightToggleBtn = document.getElementById('flightSelectorToggle');
        const loadingOverlay = document.getElementById('loadingOverlay');

        if (files.length > 0) {
          if (loadingOverlay) loadingOverlay.style.display = 'flex';

          // Small timeout to allow UI to render the loading overlay before heavy processing starts
          setTimeout(() => {
            clearAllFlights();
            flightSelector.innerHTML = '';

            const isSingleFile = files.length === 1;

            for (let i = 0; i < files.length; i++) {
              const file = files[i];
              if (file.name.toLowerCase().endsWith('.kml')) {
                processKMLFile(file, i, isSingleFile);
              } else {
                processCSVFile(file, i, isSingleFile);
              }
            }

            if (flightToggleBtn) {
              flightToggleBtn.style.display = !isSingleFile ? 'flex' : 'none';
            }
            flightSelectorContainer.style.display = !isSingleFile ? 'flex' : 'none';

            // Ensure menu starts collapsed (hidden) when loading new files
            if (!isSingleFile) {
              flightSelectorContainer.classList.add('collapsed');
            }
          }, 50);

        } else {
          if (flightToggleBtn) flightToggleBtn.style.display = 'none';
          const toggleGraph = document.getElementById('toggleGraphBtn');
          if (toggleGraph) toggleGraph.style.display = 'none';
        }
      }

      function clearAllFlights() {
        if (viewer) {
          viewer.entities.removeAll();
        }
        // Remove all existing flight paths and markers
        allFlights.forEach(flight => {
          if (flight.path) map.removeLayer(flight.path);
          if (flight.startMarker) map.removeLayer(flight.startMarker);
          if (flight.endMarker) map.removeLayer(flight.endMarker);
          flight.altitudeSegments.forEach(segment => map.removeLayer(segment));
        });

        allFlights = [];
        flightPathPoints = []; // IMPORTANT: Clear the current points so playback stops working on old data
        currentFlightIndex = -1;
        currentFlightData = null;

        // Clear the aircraft marker
        if (aircraftMarker) {
          map.removeLayer(aircraftMarker);
          aircraftMarker = null;
        }

        // Clear ATC data label
        removeATCLabel();

        const toggleBtn = document.getElementById('toggleGraphBtn');
        if (toggleBtn) toggleBtn.style.display = 'none';

        // Destroy chart
        if (chartInstance) {
          chartInstance.destroy();
          chartInstance = null;
        }

        // Reset UI state
        const chartContainer = document.getElementById('chart-container');
        const aircraftInfoContainer = document.getElementById('aircraft-info-container');
        const infoBox = document.querySelector('.infosbox');
        if (chartContainer) chartContainer.classList.add('collapsed');
        if (aircraftInfoContainer) aircraftInfoContainer.classList.add('collapsed');
        if (infoBox) infoBox.classList.remove('expanded');

        // Reset aircraft info
        isKMLFile = false;
        currentAircraftInfo = null;
        infoBoxSlideState = 0;
        displayAircraftInfo(null);

        // Reset Playback & Metadata
        if (typeof isPlaying !== 'undefined' && isPlaying) pauseFlight();
        if (typeof updatePlayPauseButton === 'function') updatePlayPauseButton();

        if (progressBar) {
          progressBar.value = 0;
          progressBar.disabled = true;
        }
        if (speedControl) speedControl.disabled = true;

        if (heureEl) heureEl.textContent = '--/--/---- --:--:--'; // Or 00... user didn't specify, -- is cleaner
        const utcEl = document.getElementById("UTCTime");
        if (utcEl) utcEl.textContent = '--/--/---- --:--:--';

        if (altitudeEl) altitudeEl.textContent = '-----';
        if (vitesseEl) vitesseEl.textContent = '----';
        if (directionEl) directionEl.textContent = '---';
        if (flightTimeEl) flightTimeEl.textContent = '--:--:--';
        const flightDistanceEl = document.getElementById('flightDistance');
        if (flightDistanceEl) flightDistanceEl.textContent = '----';

        updateToggleTracksButton();
      }

      function processKMLFile(file, index, isSingleFile) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
          const flightPoints = [];
          const flightSegments = [];

          // Extract Flight Name (try Document name, or Filename)
          let flightName = file.name.replace('.kml', '');
          const docName = xmlDoc.querySelector('Document > name');
          if (docName && docName.textContent) {
            flightName = docName.textContent;
          }

          // Extract Aircraft Model from Document description (applies to entire flight)
          let aircraftModel = null;
          let aircraftInfo = null;
          const docDescription = xmlDoc.querySelector('Document > description');
          if (docDescription) {
            const docHtmlContent = docDescription.textContent;
            // Look for "Aircraft<span...>(MODEL)</span>"
            const modelMatch = docHtmlContent.match(/Aircraft.*?\((\w+)\)/);
            if (modelMatch) {
              aircraftModel = modelMatch[1];
            }

            // Parse aircraft information from KML
            aircraftInfo = parseKMLAircraftInfo(e.target.result);
          }

          // Find all Placemarks that look like track points (have TimeStamp)
          const placemarks = xmlDoc.querySelectorAll('Placemark');

          placemarks.forEach(pm => {
            const timestampNode = pm.querySelector('TimeStamp > when');
            const pointNode = pm.querySelector('Point > coordinates');
            const descriptionNode = pm.querySelector('description');

            if (timestampNode && pointNode) {
              const coords = pointNode.textContent.trim().split(',');
              const lng = parseFloat(coords[0]);
              const lat = parseFloat(coords[1]);
              const alt = parseFloat(coords[2]) || 0; // standard KML alt is meters usually, but let's check
              // Wait, the KML example description says "Altitude: 0 ft". 
              // The <coordinates> usually have altitude in meters in standard KML, BUT
              // let's rely on the Description HTML if available for more precise/data-logger specific values (Speed/Heading).
              // Actually, let's parse the description for consistent data matching the CSV columns.

              let altitudeFeet = 0;
              let speedKt = 0;
              let headingDeg = 0;

              if (descriptionNode) {
                const htmlContent = descriptionNode.textContent;
                const parser = new DOMParser();
                const htmlDoc = parser.parseFromString(htmlContent, 'text/html');

                // Helper to extracting numeric value from sibling span
                const extractValue = (label) => {
                  const bTags = htmlDoc.getElementsByTagName('b');
                  for (let i = 0; i < bTags.length; i++) {
                    if (bTags[i].textContent.includes(label)) {
                      let valueContainer = null;
                      // Check 1: <description>...<span><b>Label:</b></span> <span>Value</span>...</description>
                      // bTag -> parent(span) -> nextElementSibling(span)
                      if (bTags[i].parentElement && bTags[i].parentElement.tagName.toLowerCase() === 'span') {
                        valueContainer = bTags[i].parentElement.nextElementSibling;
                      }
                      // Check 2: Direct sibling? <b>Label:</b> <span>Value</span>
                      if (!valueContainer) {
                        valueContainer = bTags[i].nextElementSibling;
                      }

                      if (valueContainer) {
                        let text = valueContainer.textContent.trim();

                        // Handle range "24,925 ft - 23,325 ft" -> take the right side
                        if (text.includes('-')) {
                          const parts = text.split('-');
                          text = parts[parts.length - 1].trim();
                        }

                        // Remove commas "23,325" -> "23325"
                        text = text.replace(/,/g, '');

                        const match = text.match(/(\d+)/);
                        if (match) return parseInt(match[1]);
                      }
                    }
                  }

                  // Fallback: Regex on full text
                  const cleanText = htmlDoc.body.textContent || "";
                  const backupRegex = new RegExp(label + "\\s*[:]?\\s*(\\d+)");
                  const match = cleanText.match(backupRegex);
                  if (match) return parseInt(match[1]);

                  return null;
                };

                const altConf = extractValue('Altitude');
                if (altConf !== null) altitudeFeet = altConf;

                const spdConf = extractValue('Speed');
                if (spdConf !== null) speedKt = spdConf;

                const hdgConf = extractValue('Heading');
                if (hdgConf !== null) headingDeg = hdgConf;

              } else {
                // Fallback if no description (standard KML)
                // If standard KML, coords[2] is meters. 1m = 3.28084ft
                altitudeFeet = (parseFloat(coords[2]) || 0) * 3.28084;
              }

              // Check for Style Heading fallback
              if (headingDeg === 0) {
                const iconHeading = pm.querySelector('Style > IconStyle > heading');
                if (iconHeading) headingDeg = parseInt(iconHeading.textContent);
              }

              if (!isNaN(lat) && !isNaN(lng)) {
                const rawTime = timestampNode.textContent;
                // Calculate unix timestamp for graph
                const unixTime = new Date(rawTime).getTime() / 1000;

                flightPoints.push({
                  lat: lat,
                  lng: lng,
                  altitudeFeet: altitudeFeet,
                  speed: speedKt,
                  direction: headingDeg,
                  rawUnix: unixTime,
                  time: formatTime(rawTime), // formatTime handles 'Invalid Date' checks internally
                  utcTime: formatUTCTime(rawTime), // reusing existing if format matches
                  model: aircraftModel // Store aircraft model
                });
              }
            }
          });

          if (flightPoints.length === 0) {
            showErrorPopup();
            return;
          }

          finishProcessingFlight(flightPoints, flightName, index, isSingleFile, { data: [] }, aircraftInfo); // Pass aircraft info
        };
        reader.readAsText(file);
      }

      function processCSVFile(file, index, isSingleFile) {
        Papa.parse(file, {
          header: true,
          complete: function (results) {
            const data = results.data;
            const flightPoints = [];
            // const flightSegments = []; // Unused variable
            let flightName = file.name.replace('.csv', '');

            if (results.meta.fields && results.meta.fields.length >= 3) {
              const c2Value = results.data[0] ? results.data[0][results.meta.fields[2]] : '';
              flightName = c2Value || flightName;
            }

            data.forEach(row => {
              if (row.Position && row.Altitude) {
                const [lat, lng] = row.Position.split(',').map(Number);
                const altitudeFeet = parseFloat(row.Altitude);
                const direction = parseFloat(row.Direction) || 0;

                if (!isNaN(lat) && !isNaN(lng) && !isNaN(altitudeFeet)) {
                  let rawUnix = 0;
                  try {
                    const dateStr = row.UTC || row.Timestamp;
                    if (dateStr) {
                      const d = new Date(dateStr);
                      if (!isNaN(d.getTime())) {
                        rawUnix = d.getTime() / 1000;
                      }
                    }
                  } catch (e) {
                    console.warn("Error parsing date:", e);
                  }

                  flightPoints.push({
                    lat,
                    lng,
                    altitudeFeet: altitudeFeet,
                    speed: row.Speed || 'N/A',
                    direction: direction,
                    rawUnix: rawUnix,
                    time: formatTime(row.Timestamp),
                    utcTime: formatUTCTime(row.UTC)
                  });
                }
              }
            });


            if (flightPoints.length === 0) {
              showErrorPopup();
              return;
            }

            if (flightPoints.length < 2) return;

            finishProcessingFlight(flightPoints, flightName, index, isSingleFile, results, null); // CSV files don't have aircraft info
          }
        });
      }

      function finishProcessingFlight(flightPoints, flightName, index, isSingleFile, originalDataWrapper, aircraftInfo = null) {
        // Shared Logic between CSV and KML

        // Create altitude-based segments
        const altitudeSegments = [];
        for (let i = 0; i < flightPoints.length - 1; i++) {
          const p1 = flightPoints[i];
          const p2 = flightPoints[i + 1];
          const avgAltFeet = (p1.altitudeFeet + p2.altitudeFeet) / 2;
          const color = getColorFromAltitude(avgAltFeet);

          const segment = L.polyline([[p1.lat, p1.lng], [p2.lat, p2.lng]], {
            color: color,
            weight: getTrackWeight()
          }).addTo(map);

          altitudeSegments.push(segment);

          segment.on('mousemove', (e) => {
            if (currentTooltip) {
              map.removeLayer(currentTooltip);
            }

            const tooltipContent = `
                <div class="tooltip-content">
                  <strong>LOCAL TIME: </strong> ${p1.time}<br/>
                  <strong>UTC TIME: </strong> ${p1.utcTime}<br/>
                  <strong>ALTITUDE: </strong> ${p1.altitudeFeet.toFixed(0)} ft<br/>
                  <strong>SPEED: </strong> ${p1.speed} kt<br/>
                  <strong>TRACK: </strong> ${p1.direction}<br/>
                  <strong>LATITUDE: </strong> ${e.latlng.lat.toFixed(6)}<br/>
                  <strong>LONGITUDE: </strong> ${e.latlng.lng.toFixed(6)}
                </div>
              `;

            currentTooltip = L.tooltip({
              permanent: false,
              direction: 'top',
              className: 'tooltip-content'
            })
              .setLatLng(e.latlng)
              .setContent(tooltipContent)
              .addTo(map);
          });

          segment.on('mouseout', () => {
            if (currentTooltip) {
              map.removeLayer(currentTooltip);
              currentTooltip = null;
            }
          });
        }

        // Create start and end markers (visible by default)
        const start = flightPoints[0];
        const end = flightPoints[flightPoints.length - 1];

        const startMarker = L.marker([start.lat, start.lng]).addTo(map);
        const endMarker = L.marker([end.lat, end.lng]).addTo(map);

        // Bind tooltips that only show on hover
        startMarker.bindTooltip(`${flightName} - Takeoff`, {
          permanent: false,
          direction: 'top',
          className: 'tooltip-content'
        });

        endMarker.bindTooltip(`${flightName} - Landing`, {
          permanent: false,
          direction: 'top',
          className: 'tooltip-content'
        });

        // Show tooltip on mouseover
        startMarker.on('mouseover', function () {
          this.openTooltip();
        });

        // Hide tooltip on mouseout
        startMarker.on('mouseout', function () {
          this.closeTooltip();
        });

        // Show tooltip on mouseover
        endMarker.on('mouseover', function () {
          this.openTooltip();
        });

        // Hide tooltip on mouseout
        endMarker.on('mouseout', function () {
          this.closeTooltip();
        });

        // Store flight data
        // For KML we don't have the original 'data' array structure from PapaParse, 
        // allow originalDataWrapper to be just the points if needed, or normalize it? 
        // The updateChart function expects 'data' to have .Timestamp, .Altitude, .Speed properties.
        // We need to normalize data for the chart if it came from KML.

        let chartDataSource = originalDataWrapper.data;

        // If the source data doesn't look like CSV rows (no Timestamp property), we might need to map it back 
        // or update updateChart to handle the 'flightPoints' structure which is cleaner.
        // Ideally, we should refactor updateChart to use flightPoints!
        // But to minimize risk, let's just make sure KML data is mapped to mimic the CSV row structure for the chart.
        if ((!chartDataSource.length || !chartDataSource[0].Timestamp) && flightPoints.length > 0) {
          // It's probably our KML points. Let's remap them to the expected format for updateChart
          chartDataSource = flightPoints.map(p => ({
            Timestamp: p.rawUnix, // Use the raw unix timestamp we stored
            Altitude: p.altitudeFeet,
            Speed: p.speed
          }));
        }

        const flightData = {
          name: flightName,
          points: flightPoints,
          path: null,
          startMarker: startMarker,
          endMarker: endMarker,
          altitudeSegments: altitudeSegments,
          data: chartDataSource,
          aircraftInfo: aircraftInfo, // Store aircraft info (null for CSV files)
          isKML: aircraftInfo !== null // Track if this is a KML file
        };

        allFlights[index] = flightData;

        // Add to flight selector if multiple files
        if (!isSingleFile) {
          flightSelector.innerHTML = '';
          allFlights.forEach((flight, idx) => {
            const flightItem = document.createElement('div');
            flightItem.className = 'flight-item';
            flightItem.textContent = flight.name;
            flightItem.dataset.index = idx; // Store index for reliable selection
            flightItem.onclick = () => selectFlight(idx);

            // Restore active state if needed
            if (idx === currentFlightIndex) {
              flightItem.classList.add('active');
            }

            flightSelector.appendChild(flightItem);
          });
        }

        // If this is the first SUCCESSFUL flight (or single file), select it by default
        if (currentFlightIndex === -1 || isSingleFile) {
          selectFlight(index, isSingleFile);
        }

        const toggleGraph = document.getElementById('toggleGraphBtn');
        if (toggleGraph) toggleGraph.style.display = 'flex';

        // Ensure flight is added to 3D if 3D mode is active (for non-selected flights)
        if (is3DMode && viewer && cesiumInitialized) {
          const flight = allFlights[index];
          if (flight && !flight.cesiumEntity) {
            addFlightTo3D(flight);
          }
        }

        updateTrackVisibility();
        updateToggleTracksButton();

        updateTrackVisibility();
        updateToggleTracksButton();

        if (!is3DMode) {
          const loadingOverlay = document.getElementById('loadingOverlay');
          if (loadingOverlay) loadingOverlay.style.display = 'none';
        }
      }

      async function selectFlight(index, isSingleFile = false) {
        if (index < 0 || index >= allFlights.length) return;

        currentFlightIndex = index;
        const flight = allFlights[index];
        currentFlightData = flight;

        // Update flight selector UI
        const flightItems = document.querySelectorAll('.flight-item');
        flightItems.forEach((item) => {
          // Use loose equality for dataset string vs integer index
          if (item.dataset.index == index) {
            item.classList.add('active');
          } else {
            item.classList.remove('active');
          }
        });

        // Set current flight data
        flightPathPoints = flight.points;

        // Remove previous aircraft marker if exists
        if (aircraftMarker) {
          map.removeLayer(aircraftMarker);
        }

        // Create new aircraft marker
        aircraftMarker = L.marker(
          [flightPathPoints[0].lat, flightPathPoints[0].lng],
          {
            icon: createAircraftIcon(flightPathPoints[0].direction),
            rotationAngle: flightPathPoints[0].direction
          }
        ).addTo(map);

        // Update UI
        document.getElementById('multi_file_button').textContent = `${flight.name}`;
        progressBar.max = flightPathPoints.length - 1;
        progressBar.step = "0.01"; // Enable smooth sliding
        progressBar.disabled = false;
        speedControl.disabled = false;
        progressBar.value = 0;
        updateDisplay(0);

        updateAircraftPosition(0);

        // Calculate and display flight time
        flightTimeEl.textContent = calculateFlightTime(flight.data);

        // Calculate and display flight distance
        const flightDistanceEl = document.getElementById('flightDistance');
        if (flightDistanceEl) {
          flightDistanceEl.textContent = calculateFlightDistance(flight.points);
        }

        // Update chart
        updateChart(flight.data);

        // Update aircraft info for KML files
        isKMLFile = flight.isKML || false;
        currentAircraftInfo = flight.aircraftInfo || null;
        displayAircraftInfo(currentAircraftInfo);

        // Ensure ATC label is created if radar mode is active (now that info is ready)
        if (radarModeEnabled) {
          createATCLabel();
        }

        // Reset info box slide state to collapsed when switching flights
        infoBoxSlideState = 0;
        updateInfoBoxState();

        updateTrackVisibility();

        // Fit bounds to this flight with padding to avoid UI overlap
        // paddingBottomRight y=300 to clear the bottom info box
        map.fitBounds(L.latLngBounds(flightPathPoints.map(p => [p.lat, p.lng])), {
          paddingTopLeft: [70, 70],
          paddingBottomRight: [70, 70]
        });

        // If in 3D mode, create the 3D flight path
        if (is3DMode && viewer && cesiumInitialized) {
          if (!flight.cesiumEntity) {
            await addFlightTo3D(flight);
            configure3DForFlight(index);
          } else {
            configure3DForFlight(index);
          }

          // Hide loading overlay after 3D processing (terrain sampling, etc) is done and camera starts moving
          const loadingOverlay = document.getElementById('loadingOverlay');
          if (loadingOverlay) loadingOverlay.style.display = 'none';
        }
      }


      // Toggle Tracks Logic
      const toggleTracksBtn = document.getElementById('toggleTracksBtn');
      toggleTracksBtn.addEventListener('click', () => {
        isSingleTrackMode = !isSingleTrackMode;
        updateTrackVisibility();
        updateToggleTracksButton();
      });

      function updateToggleTracksButton() {
        const btn = document.getElementById('toggleTracksBtn');
        if (!btn) return;

        // Filter out any potential empty slots if using sparse array, though push/assignment relies on index
        // allFlights matches index logic. Safe to filter.
        const count = allFlights.filter(f => f).length;

        // Hide if 0 or 1 file loaded. The button is only useful if we have > 1 file.
        if (count <= 1) {
          btn.style.display = 'none';
          btn.textContent = "";
          return;
        }

        // If we have > 1 file, ensure button is visible
        btn.style.display = 'flex';

        if (isSingleTrackMode) {
          btn.textContent = "1";
          btn.classList.add('active');
          btn.title = "Show All " + count + " Tracks";
          btn.style.fontSize = ''; // Reset standard size
        } else {
          btn.textContent = count.toString();
          btn.classList.remove('active');
          btn.title = "Show Single Track";

          // Adjust font size for large numbers
          if (count > 999) {
            btn.style.fontSize = '0.7rem';
          } else if (count > 99) {
            btn.style.fontSize = '0.85rem';
          } else {
            btn.style.fontSize = '1.2rem';
          }
        }
      }

      function updateTrackVisibility() {
        // 2D Visibility
        allFlights.forEach((flight, index) => {
          const shouldShow = !isSingleTrackMode || index === currentFlightIndex;

          // 2D Layers
          if (flight.altitudeSegments) {
            flight.altitudeSegments.forEach(seg => {
              if (shouldShow) {
                if (!map.hasLayer(seg)) map.addLayer(seg);
              } else {
                if (map.hasLayer(seg)) map.removeLayer(seg);
              }
            });
          }

          // Start/End Markers
          if (flight.startMarker) {
            if (shouldShow) {
              if (!map.hasLayer(flight.startMarker)) map.addLayer(flight.startMarker);
            } else {
              if (map.hasLayer(flight.startMarker)) map.removeLayer(flight.startMarker);
            }
          }
          if (flight.endMarker) {
            if (shouldShow) {
              if (!map.hasLayer(flight.endMarker)) map.addLayer(flight.endMarker);
            } else {
              if (map.hasLayer(flight.endMarker)) map.removeLayer(flight.endMarker);
            }
          }

          // 3D Visibility
          if (viewer && cesiumInitialized && flight.cesiumTrackEntities) {
            flight.cesiumTrackEntities.forEach(entity => {
              entity.show = shouldShow;
            });
            // Also hide the aircraft entity if it's not the selected one? 
            // The prompt implies "show tracks". Usually we want to hide other aircraft too in "single mode".
            if (flight.cesiumEntity) {
              // Always show the selected aircraft, hide others if single mode
              flight.cesiumEntity.show = shouldShow;
            }
          }
        });
      }

      progressBar.addEventListener('input', function () {
        const index = parseInt(this.value);
        updateDisplay(index);
        updateAircraftPosition(index);

        // Sync 3D view if active
        if (is3DMode && viewer) {
          syncPlaybackTo3D();
        }
      });

      function getChartTheme() {
        const style = getComputedStyle(document.body);
        return {
          axisColor: style.getPropertyValue('--chart-axis-color').trim(),
          gridColor: style.getPropertyValue('--chart-grid-color').trim(),
          tooltipBg: style.getPropertyValue('--tooltip-bg').trim(),
          textMain: style.getPropertyValue('--text-main').trim(),
          textSecondary: style.getPropertyValue('--text-secondary').trim()
        };
      }

      function getGraphLineWidth() {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isSmallScreen = window.innerWidth <= 1024;
        return (isMobile || isSmallScreen) ? 1 : 2;
      }

      function updateChart(data) {
        if (!data) return;

        const theme = getChartTheme();
        const lineWidth = getGraphLineWidth();
        const altitude = [];
        const speed = [];

        data.forEach(row => {
          if (row.Timestamp && !isNaN(row.Altitude) && !isNaN(row.Speed)) {
            const parsedTime = new Date(parseInt(row.Timestamp) * 1000);
            if (!isNaN(parsedTime)) {
              altitude.push({ x: parsedTime, y: row.Altitude });
              speed.push({ x: parsedTime, y: row.Speed });
            }
          }
        });

        const ctx = document.getElementById('flightChart').getContext('2d');
        if (chartInstance) {
          chartInstance.destroy();
        }

        const scrubberLine = {
          id: 'scrubberLine',
          afterDatasetsDraw(chart, args, options) {
            if (activePointIndex === -1) return;

            const { ctx, chartArea: { top, bottom }, scales: { x } } = chart;
            const meta = chart.getDatasetMeta(0);

            // Ensure we have data at this index
            if (!meta.data[activePointIndex]) return;

            const xPos = meta.data[activePointIndex].x;

            ctx.save();
            ctx.beginPath();
            ctx.lineWidth = 1;
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.moveTo(xPos, top);
            ctx.lineTo(xPos, bottom);
            ctx.stroke();
            ctx.restore();
          }
        };

        chartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [
              {
                label: 'GROUND SPEED',
                data: speed,
                borderColor: '#f0ad4e',
                backgroundColor: '#f0ad4e',
                yAxisID: 'y1',
                tension: 0.1, // Less bold zigzags
                fill: false,
                pointRadius: 0,
                borderWidth: lineWidth // Responsive line width
              },
              {
                label: 'ALTITUDE',
                data: altitude,
                borderColor: '#00bfff',
                backgroundColor: '#00bfff',
                yAxisID: 'y',
                tension: 0.1, // Less bold zigzags
                fill: false,
                pointRadius: 0,
                borderWidth: lineWidth // Responsive line width
              }
            ]
          },
          plugins: [scrubberLine],
          options: {
            animation: {
              duration: 0 // Disable animation for responsive scrubbing
            },
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false
            },
            stacked: false,
            plugins: {
              title: {
                display: false
              },
              legend: {
                labels: {
                  color: theme.textMain
                }
              },
              tooltip: {
                backgroundColor: theme.tooltipBg,
                titleColor: theme.textMain,
                bodyColor: theme.textMain,
                borderColor: theme.gridColor,
                borderWidth: 1,
                callbacks: {
                  label: function (context) {
                    if (context.dataset.label === 'GROUND SPEED') {
                      return 'Ground Speed: ' + context.formattedValue + ' kt';
                    } else if (context.dataset.label === 'ALTITUDE') {
                      return 'Altitude: ' + context.formattedValue + ' ft';
                    }
                    return context.formattedValue;
                  }
                }
              }
            },
            scales: {
              x: {
                type: 'time',
                time: {
                  unit: 'minute',
                  tooltipFormat: 'PPpp'
                },
                ticks: {
                  color: theme.axisColor
                },
                grid: {
                  color: theme.gridColor
                }
              },
              y: {
                type: 'linear',
                position: 'left',
                title: {
                  display: true,
                  text: 'Altitude (ft)',
                  color: theme.axisColor
                },
                ticks: {
                  color: theme.axisColor
                },
                grid: {
                  color: theme.gridColor
                }
              },
              y1: {
                type: 'linear',
                position: 'right',
                title: {
                  display: true,
                  text: 'Speed (kt)',
                  color: theme.axisColor
                },
                ticks: {
                  color: theme.axisColor
                },
                grid: {
                  drawOnChartArea: false
                }
              }
            }
          }
        });
      }

      // Listen for theme changes to update chart
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        if (currentFlightData) {
          updateChart(currentFlightData.data);
        }
      });

      const toggleGraphBtn = document.getElementById('toggleGraphBtn');
      const chartContainer = document.getElementById('chart-container');
      const aircraftInfoContainer = document.getElementById('aircraft-info-container');
      const infosbox = document.querySelector('.infosbox');

      // Drag Logic
      let isDragging = false;
      let dragStartY = 0;
      let dragCurrentY = 0;
      let draggedDistance = 0;
      let startHeight = 0;
      const MAX_HEIGHT = 240;

      function updateInfoBoxState() {
        // State 0: Collapsed (both hidden)
        // State 1: Graph shown (chart visible, aircraft info hidden)
        // State 2: Graph + Aircraft info shown (both visible) - only for KML files

        if (infoBoxSlideState === 0) {
          // Collapsed
          chartContainer.classList.add('collapsed');
          aircraftInfoContainer.classList.add('collapsed');
          infosbox.classList.add('collapsed');
          infosbox.classList.remove('expanded');
        } else if (infoBoxSlideState === 1) {
          // Graph shown
          chartContainer.classList.remove('collapsed');
          aircraftInfoContainer.classList.add('collapsed');
          infosbox.classList.remove('collapsed');
          infosbox.classList.add('expanded');
        } else if (infoBoxSlideState === 2) {
          // Graph + Aircraft info shown (only if KML)
          chartContainer.classList.remove('collapsed');
          if (isKMLFile && currentAircraftInfo) {
            aircraftInfoContainer.classList.remove('collapsed');
          } else {
            // If not KML, don't show aircraft info, stay at state 1
            aircraftInfoContainer.classList.add('collapsed');
            infoBoxSlideState = 1;
          }
          infosbox.classList.remove('collapsed');
          infosbox.classList.add('expanded');
        }

        if (chartInstance) {
          setTimeout(() => chartInstance.update(), 10);
        }
      }

      function finishDrag(wasClick) {
        isDragging = false;

        const currentHeight = chartContainer.offsetHeight;

        // Restore transitions
        chartContainer.style.transition = 'height 0.3s ease, opacity 0.3s ease, margin-top 0.3s ease';
        aircraftInfoContainer.style.transition = 'max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease';

        // Remove inline styles
        chartContainer.style.height = '';
        chartContainer.style.opacity = '';
        chartContainer.style.marginTop = '';
        aircraftInfoContainer.style.maxHeight = '';
        aircraftInfoContainer.style.opacity = '';
        aircraftInfoContainer.style.padding = '';

        if (wasClick) {
          // Click: cycle through states
          const maxState = (isKMLFile && currentAircraftInfo) ? 2 : 1;

          if (dragStartY < window.innerHeight / 2) {
            // Clicked on upper half - slide up (increase state)
            infoBoxSlideState = (infoBoxSlideState + 1) % (maxState + 1);
          } else {
            // Clicked on lower half - slide down (decrease state)
            infoBoxSlideState = infoBoxSlideState - 1;
            if (infoBoxSlideState < 0) infoBoxSlideState = maxState;
          }
        } else {
          // Dragged: determine state based on drag direction and distance
          const dy = dragStartY - dragCurrentY;

          if (dy > 50) {
            // Dragged up significantly
            const maxState = (isKMLFile && currentAircraftInfo) ? 2 : 1;
            infoBoxSlideState = Math.min(infoBoxSlideState + 1, maxState);
          } else if (dy < -50) {
            // Dragged down significantly
            infoBoxSlideState = Math.max(infoBoxSlideState - 1, 0);
          }
          // else: small drag, keep current state
        }

        updateInfoBoxState();
      }

      toggleGraphBtn.addEventListener('mousedown', (e) => {
        isDragging = true;
        dragStartY = e.clientY;
        draggedDistance = 0;
        startHeight = chartContainer.offsetHeight;
        chartContainer.style.transition = 'none';
      });

      toggleGraphBtn.addEventListener('touchstart', (e) => {
        if (e.cancelable) e.preventDefault();
        isDragging = true;
        dragStartY = e.touches[0].clientY;
        draggedDistance = 0;
        startHeight = chartContainer.offsetHeight;
        chartContainer.style.transition = 'none';
      }, { passive: false });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        dragCurrentY = e.clientY;
        const dy = dragStartY - dragCurrentY;
        draggedDistance = Math.abs(dy);

        // Determine what to animate based on current state and drag direction
        if (infoBoxSlideState === 2 && dy < 0) {
          // Sliding down from state 2: collapse aircraft info, keep graph stable
          const aircraftInfoMaxHeight = 100; // Match CSS max-height
          let newAircraftHeight = aircraftInfoMaxHeight + dy;
          newAircraftHeight = Math.max(0, Math.min(newAircraftHeight, aircraftInfoMaxHeight));

          // Calculate proportional padding (10px at full height, 0px at collapsed)
          const paddingValue = (newAircraftHeight / aircraftInfoMaxHeight) * 10;

          aircraftInfoContainer.style.transition = 'none';
          aircraftInfoContainer.style.maxHeight = `${newAircraftHeight}px`;
          aircraftInfoContainer.style.opacity = Math.max(0, Math.min(1, newAircraftHeight / aircraftInfoMaxHeight));
          aircraftInfoContainer.style.padding = `${paddingValue}px 15px`;
        } else if (infoBoxSlideState === 1 && dy > 0 && isKMLFile && currentAircraftInfo) {
          // Sliding up from state 1: expand aircraft info, keep graph stable
          const aircraftInfoMaxHeight = 100; // Match CSS max-height
          let newAircraftHeight = Math.min(dy, aircraftInfoMaxHeight);

          // Calculate proportional padding (0px at collapsed, 10px at full height)
          const paddingValue = (newAircraftHeight / aircraftInfoMaxHeight) * 10;

          aircraftInfoContainer.style.transition = 'none';
          aircraftInfoContainer.classList.remove('collapsed');
          aircraftInfoContainer.style.maxHeight = `${newAircraftHeight}px`;
          aircraftInfoContainer.style.opacity = Math.max(0, Math.min(1, newAircraftHeight / aircraftInfoMaxHeight));
          aircraftInfoContainer.style.padding = `${paddingValue}px 15px`;
        } else {
          // Normal drag logic for chart
          let newHeight = startHeight + dy;
          newHeight = Math.max(0, Math.min(newHeight, MAX_HEIGHT));

          // Calculate proportional margin-top (5px at full height, 0px at collapsed)
          const marginValue = (newHeight / MAX_HEIGHT) * 5;

          chartContainer.style.height = `${newHeight}px`;
          chartContainer.style.opacity = Math.max(0.1, Math.min(1, newHeight / 50));
          chartContainer.style.marginTop = `${marginValue}px`;
        }
      });

      document.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        dragCurrentY = e.touches[0].clientY;
        const dy = dragStartY - dragCurrentY;
        draggedDistance = Math.abs(dy);

        // Determine what to animate based on current state and drag direction
        if (infoBoxSlideState === 2 && dy < 0) {
          // Sliding down from state 2: collapse aircraft info, keep graph stable
          const aircraftInfoMaxHeight = 100; // Match CSS max-height
          let newAircraftHeight = aircraftInfoMaxHeight + dy;
          newAircraftHeight = Math.max(0, Math.min(newAircraftHeight, aircraftInfoMaxHeight));

          // Calculate proportional padding (10px at full height, 0px at collapsed)
          const paddingValue = (newAircraftHeight / aircraftInfoMaxHeight) * 10;

          aircraftInfoContainer.style.transition = 'none';
          aircraftInfoContainer.style.maxHeight = `${newAircraftHeight}px`;
          aircraftInfoContainer.style.opacity = Math.max(0, Math.min(1, newAircraftHeight / aircraftInfoMaxHeight));
          aircraftInfoContainer.style.padding = `${paddingValue}px 15px`;
        } else if (infoBoxSlideState === 1 && dy > 0 && isKMLFile && currentAircraftInfo) {
          // Sliding up from state 1: expand aircraft info, keep graph stable
          const aircraftInfoMaxHeight = 100; // Match CSS max-height
          let newAircraftHeight = Math.min(dy, aircraftInfoMaxHeight);

          // Calculate proportional padding (0px at collapsed, 10px at full height)
          const paddingValue = (newAircraftHeight / aircraftInfoMaxHeight) * 10;

          aircraftInfoContainer.style.transition = 'none';
          aircraftInfoContainer.classList.remove('collapsed');
          aircraftInfoContainer.style.maxHeight = `${newAircraftHeight}px`;
          aircraftInfoContainer.style.opacity = Math.max(0, Math.min(1, newAircraftHeight / aircraftInfoMaxHeight));
          aircraftInfoContainer.style.padding = `${paddingValue}px 15px`;
        } else {
          // Normal drag logic for chart
          let newHeight = startHeight + dy;
          newHeight = Math.max(0, Math.min(newHeight, MAX_HEIGHT));

          // Calculate proportional margin-top (5px at full height, 0px at collapsed)
          const marginValue = (newHeight / MAX_HEIGHT) * 5;

          chartContainer.style.height = `${newHeight}px`;
          chartContainer.style.opacity = Math.max(0.1, Math.min(1, newHeight / 50));
          chartContainer.style.marginTop = `${marginValue}px`;
        }
      }, { passive: false });

      document.addEventListener('mouseup', (e) => {
        if (isDragging) {
          // If moved less than 5px, treat as click
          finishDrag(draggedDistance < 5);
        }
      });

      document.addEventListener('touchend', (e) => {
        if (isDragging) {
          finishDrag(draggedDistance < 5);
        }
      });

      infosbox.classList.add('collapsed');
      chartContainer.classList.add('collapsed');
      aircraftInfoContainer.classList.add('collapsed');
      // No text content update needed

      async function takeScreenshot() {
        const screenshotBtn = document.getElementById('screenshotBtn');
        const multiFileBtn = document.getElementById('multi_file_button');
        const flightSelectorCont = document.getElementById('flightSelectorContainer');
        const infosbox = document.querySelector('.infosbox');
        const layersControl = document.querySelector('.leaflet-control-layers');
        const zoomControl = document.querySelector('.leaflet-control-zoom');
        const scaleControl = document.querySelector('.leaflet-control-scale');
        const attributionControl = document.querySelector('.leaflet-control-attribution');
        const layerBtn = document.getElementById('layerBtn');
        const layer3DBtn = document.getElementById('layer3DBtn');
        const infoBtn = document.getElementById('infoBtn');
        const toggle3DBtn = document.getElementById('toggle3DBtn');
        const followBtn = document.getElementById('followBtn');
        const searchBtn = document.getElementById('searchBtn');
        const tipBtn = document.getElementById('tipBtn');
        const flightSelectorToggle = document.getElementById('flightSelectorToggle');
        const toggleTracksBtn = document.getElementById('toggleTracksBtn');
        const radarBtn = document.getElementById('radarBtn');
        const follow2DBtn = document.getElementById('follow2DBtn');

        // Elements to hide (UI elements)
        const elementsToHide = [
          screenshotBtn,
          multiFileBtn,
          flightSelectorCont,
          infosbox,
          layersControl,
          zoomControl,
          scaleControl,
          attributionControl,
          layerBtn,
          layer3DBtn,
          infoBtn,
          toggle3DBtn,
          followBtn,
          searchBtn,
          tipBtn,
          flightSelectorToggle,
          toggleTracksBtn,
          radarBtn,
          atcDataLabel,
          follow2DBtn
        ];

        // Save initial visibility/display
        const originalVisibility = elementsToHide.map(el => el ? el.style.visibility : null);

        // Hide UI elements
        elementsToHide.forEach(el => {
          if (el) el.style.visibility = 'hidden';
        });

        // Hide Cesium UI elements if in 3D mode
        let cesiumToolbar = null;
        let cesiumGeocoder = null;
        if (is3DMode && viewer) {
          cesiumToolbar = document.querySelector('.cesium-viewer-toolbar');
          cesiumGeocoder = document.querySelector('.cesium-viewer-geocoderContainer');
          if (cesiumToolbar) cesiumToolbar.style.visibility = 'hidden';
          if (cesiumGeocoder) cesiumGeocoder.style.visibility = 'hidden';
        }

        // Also hide takeoff/landing pins, aircraft marker, and shadows (2D mode)
        const shadowPane = document.querySelector('.leaflet-shadow-pane');
        if (shadowPane) shadowPane.style.display = 'none';

        allFlights.forEach(flight => {
          if (flight.startMarker) flight.startMarker.getElement().style.display = 'none';
          if (flight.endMarker) flight.endMarker.getElement().style.display = 'none';
        });
        if (aircraftMarker) aircraftMarker.getElement().style.display = 'none';

        const brandingBtn = document.getElementById('brandingBtn');
        const brandingStyles = { backdrop: '', bg: '', shadow: '' };
        let brandingSvg = null;
        const svgStyles = { bg: '', shadow: '' };

        try {
          if (brandingBtn) {
            brandingStyles.backdrop = brandingBtn.style.backdropFilter;
            brandingStyles.bg = brandingBtn.style.background;
            brandingStyles.shadow = brandingBtn.style.boxShadow;

            brandingBtn.style.backdropFilter = 'none';
            brandingBtn.style.webkitBackdropFilter = 'none';
            brandingBtn.style.background = 'transparent';
            brandingBtn.style.boxShadow = 'none';

            brandingSvg = brandingBtn.querySelector('svg');
            if (brandingSvg) {
              svgStyles.bg = brandingSvg.style.background;
              svgStyles.shadow = brandingSvg.style.boxShadow;
              brandingSvg.style.background = 'transparent';
              brandingSvg.style.boxShadow = 'none';
            }
          }

          const captureScale = 3; // High quality (3x)

          if (is3DMode && viewer) {
            viewer.resolutionScale = captureScale;
            viewer.resize();
            viewer.render();
          }

          let brandingCanvas = null;
          let brandingRect = null;

          if (is3DMode && viewer) {
            // 3D Mode: Capture branding separately for composite
            if (brandingBtn) {
              brandingRect = brandingBtn.getBoundingClientRect();
              brandingCanvas = await html2canvas(brandingBtn, {
                backgroundColor: null,
                scale: captureScale,
                logging: false,
                useCORS: true
              });
            }

            // Capture 3D Cesium view
            viewer.render();
            const cesiumCanvas = viewer.scene.canvas;

            canvas = document.createElement('canvas');
            canvas.width = cesiumCanvas.width;
            canvas.height = cesiumCanvas.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(cesiumCanvas, 0, 0);

            // Composite branding for 3D
            if (brandingCanvas && brandingRect) {
              const winW = window.innerWidth;
              const winH = window.innerHeight;
              const rect = brandingRect;

              const isRight = (rect.left + rect.width / 2) > (winW / 2);
              const isBottom = (rect.top + rect.height / 2) > (winH / 2);

              let drawX, drawY;

              if (isRight) {
                const marginR = winW - rect.right;
                drawX = canvas.width - brandingCanvas.width - (marginR * captureScale);
              } else {
                drawX = rect.left * captureScale;
              }

              if (isBottom) {
                const marginB = winH - rect.bottom;
                drawY = canvas.height - brandingCanvas.height - (marginB * captureScale);
              } else {
                drawY = rect.top * captureScale;
              }

              ctx.drawImage(brandingCanvas, drawX, drawY);
            }
          } else {
            // 2D Mode: Capture full body (includes map + branding overlays)
            // Branding styles are stripped so it renders clean on top of map
            canvas = await html2canvas(document.body, {
              useCORS: true,
              allowTaint: false,
              logging: false,
              scale: captureScale,
              scrollX: 0,
              scrollY: 0
            });
          }

          const link = document.createElement('a');
          link.download = `Flight_Replay_${new Date().getTime()}.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
        } catch (error) {
          console.error('Screenshot failed:', error);
          alert('Failed to take screenshot.');
        } finally {
          // Restore branding styles
          if (brandingBtn) {
            brandingBtn.style.backdropFilter = brandingStyles.backdrop;
            brandingBtn.style.webkitBackdropFilter = brandingStyles.backdrop;
            brandingBtn.style.background = brandingStyles.bg;
            brandingBtn.style.boxShadow = brandingStyles.shadow;
          }
          if (brandingSvg) {
            brandingSvg.style.background = svgStyles.bg;
            brandingSvg.style.boxShadow = svgStyles.shadow;
          }

          // Restore UI elements
          elementsToHide.forEach((el, i) => {
            if (el) el.style.visibility = originalVisibility[i];
          });

          // Restore Cesium UI elements
          if (cesiumToolbar) cesiumToolbar.style.visibility = '';
          if (cesiumGeocoder) cesiumGeocoder.style.visibility = '';

          // Restore 3D resolution
          if (is3DMode && viewer) {
            viewer.resolutionScale = window.devicePixelRatio || 1;
            viewer.resize();
            viewer.render();
          }

          // Restore takeoff/landing pins, aircraft marker, and shadows
          if (shadowPane) shadowPane.style.display = '';

          allFlights.forEach(flight => {
            if (flight.startMarker) flight.startMarker.getElement().style.display = '';
            if (flight.endMarker) flight.endMarker.getElement().style.display = '';
          });
          if (aircraftMarker) aircraftMarker.getElement().style.display = '';
        }
      }
      // Initialize Buy Me a Coffee button animation
      window.addEventListener('load', () => {
        setTimeout(() => {
          const tipBtn = document.getElementById('tipBtn');
          if (tipBtn) {
            tipBtn.classList.add('shrunk');
          }
        }, 3000);

        // Link custom button to official BMC widget
        const tipBtn = document.getElementById('tipBtn');
        if (tipBtn) {
          tipBtn.addEventListener('click', () => {
            const bmcWidgetBtn = document.getElementById('bmc-wbtn');
            if (bmcWidgetBtn) {
              bmcWidgetBtn.click();
            }
          });
        }
      });

      // Debug button and FPS counter
      let debugActive = false;
      let lastFrameTime = performance.now();
      let frameCount = 0;
      let fps = 0;
      let ms = 0;
      let fpsUpdateInterval = null;

      const debugBtn = document.getElementById('debugBtn');
      const debugStats = document.getElementById('debugStats');
      const fpsCounter = document.getElementById('fpsCounter');
      const msCounter = document.getElementById('msCounter');


      // Toggle debug mode
      debugBtn.addEventListener('click', () => {
        debugActive = !debugActive;

        if (debugActive) {
          debugBtn.classList.add('active');
          debugStats.classList.add('active');
          startFPSCounter();
        } else {
          debugBtn.classList.remove('active');
          debugStats.classList.remove('active');
          stopFPSCounter();
        }
      });

      function startFPSCounter() {
        lastFrameTime = performance.now();
        frameCount = 0;

        // Update FPS and RAM display every second
        fpsUpdateInterval = setInterval(() => {
          fps = frameCount;
          frameCount = 0;
          fpsCounter.textContent = fps;


        }, 1000);

        // Start animation loop
        requestAnimationFrame(updateFPS);
      }

      function stopFPSCounter() {
        if (fpsUpdateInterval) {
          clearInterval(fpsUpdateInterval);
          fpsUpdateInterval = null;
        }
        fpsCounter.textContent = '0';
        msCounter.textContent = '0';

      }

      function updateFPS() {
        if (!debugActive) return;

        const currentTime = performance.now();
        const delta = currentTime - lastFrameTime;

        // Update ms (frame time)
        ms = Math.round(delta * 10) / 10; // Round to 1 decimal place
        msCounter.textContent = ms.toFixed(1);

        lastFrameTime = currentTime;
        frameCount++;

        // Continue the loop
        requestAnimationFrame(updateFPS);
      }
    </script>
</body>

</html>
