<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Flight Playback</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js"
    data-id="flightplayback" data-description="Support me on Buy me a coffee!" data-message="" data-color="#40DCA5"
    data-position="Right" data-x_margin="70" data-y_margin="18"></script>
  <style>
    :root {
      /* Light Theme (Default) */
      --bg-color: #f0f0f0;
      --glass-bg: rgba(255, 255, 255, 0.65);
      --glass-border: rgba(255, 255, 255, 0.4);
      --text-main: #1a1a1a;
      --text-header: #444444;
      --text-secondary: #666666;
      --button-bg: rgba(0, 0, 0, 0.05);
      --button-border: rgba(0, 0, 0, 0.1);
      --button-hover: rgba(0, 0, 0, 0.1);
      --flight-hover: rgba(0, 0, 0, 0.05);
      --flight-active-bg: rgba(0, 122, 255, 0.15);
      --flight-active-text: #007aff;
      --shadow-color: rgba(0, 0, 0, 0.05);
      --tooltip-bg: rgba(255, 255, 255, 0.85);
      --accent-color: #007aff;
      --chart-axis-color: #555555;
      --chart-grid-color: rgba(0, 0, 0, 0.1);
      --bmc-icon-color: #0D0C22;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        /* Dark Theme */
        --bg-color: #000000;
        --glass-bg: rgba(27, 27, 27, 0.65);
        --glass-border: rgba(255, 255, 255, 0.1);
        --text-main: #ffffff;
        --text-header: #cccccc;
        --text-secondary: #aaaaaa;
        --button-bg: rgba(255, 255, 255, 0.1);
        --button-border: rgba(255, 255, 255, 0.2);
        --button-hover: rgba(255, 255, 255, 0.2);
        --flight-hover: rgba(255, 255, 255, 0.1);
        --flight-active-bg: rgba(10, 132, 255, 0.3);
        --flight-active-text: #0a84ff;
        --shadow-color: rgba(0, 0, 0, 0.5);
        --tooltip-bg: rgba(40, 40, 40, 0.85);
        --accent-color: #0a84ff;
        --chart-axis-color: #cccccc;
        --chart-grid-color: rgba(255, 255, 255, 0.1);
        --bmc-icon-color: #f2f3dd;
      }
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Floating Buttons */
    #multi_file_button {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: var(--text-main);
      font-size: 1rem;
      z-index: 1001;
      background-color: var(--glass-bg);
      padding: 8px 16px;
      border-radius: 20px;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px var(--shadow-color);
      border: 1px solid var(--glass-border);
    }

    #multiCsvFiles {
      display: none;
    }

    #toggleMarkersBtn {
      position: absolute;
      top: 80px;
      left: 10px;
      z-index: 1001;
      padding: 8px 16px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 20px;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
    }

    #screenshotBtn {
      position: absolute;
      top: 80px;
      right: 12px;
      z-index: 1001;
      padding: 10px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
    }

    #tipBtn {
      position: absolute;
      top: 140px;
      right: 12px;
      z-index: 1001;
      padding: 0;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 22px;
      /* Fixed radius to prevent 'bending' */
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      /* Align to the right where the icon stays */
      height: 44px;
      width: 140px;
      overflow: hidden;
      white-space: nowrap;
      text-decoration: none;
      padding-right: 9px;
      /* Precisely centers 24px icon in 44px button (1px border) */
    }

    #tipBtn .btn-text {
      margin-right: 12px;
      opacity: 1;
      transform: translateX(0);
      transition: opacity 1.5s ease, transform 1.5s cubic-bezier(0.4, 0, 0.2, 1), margin 1.5s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-block;
    }

    #tipBtn svg {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
      display: block;
    }

    #tipBtn.shrunk {
      width: 44px;
    }

    #tipBtn.shrunk .btn-text {
      opacity: 0;
      transform: translateX(40px);
      /* Pushed into/behind the icon */
      margin-right: -40px;
      /* Collapse space to keep icon centered */
    }

    #tipBtn:hover {
      transform: scale(1.05);
      background-color: var(--button-hover);
    }

    #layerBtn {
      position: absolute;
      top: 20px;
      right: 12px;
      z-index: 1001;
      padding: 10px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
    }

    #layerBtn:hover {
      transform: scale(1.1);
      background-color: var(--button-hover);
    }

    #infoBtn {
      position: absolute;
      top: 200px;
      right: 12px;
      z-index: 1001;
      padding: 10px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
    }

    #infoBtn:hover {
      transform: scale(1.1);
      background-color: var(--button-hover);
    }

    #infoModal {
      position: fixed;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 20px;
      z-index: 2000;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      width: 250px;
      text-align: center;
      color: var(--text-main);
      display: none;
    }

    #infoModal h3 {
      margin-top: 0;
      margin-bottom: 25px;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-header);
      border-bottom: 1px solid var(--glass-border);
      padding-bottom: 10px;
    }

    .info-group {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .info-label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-secondary);
      letter-spacing: 0.5px;
      margin-bottom: 2px;
    }

    .info-email {
      color: var(--accent-color);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.7rem;
      transition: opacity 0.2s;
    }

    .info-email:hover {
      opacity: 0.8;
      text-decoration: underline;
    }

    .info-subtext {
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .info-feature {
      font-size: 0.9rem;
      color: var(--text-main);
      background: var(--button-bg);
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid var(--button-border);
      display: inline-block;
      margin-top: 4px;
    }

    #infoModal .version {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 25px;
      border-top: 1px solid var(--glass-border);
      padding-top: 10px;
      opacity: 0.7;
    }

    #layerModal {
      position: fixed;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 20px;
      z-index: 2000;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      width: 250px;
      text-align: center;
      color: var(--text-main);
      display: none;
      /* Explicitly hidden in CSS too */
    }

    #errorModal {
      position: fixed;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 59, 48, 0.3);
      /* Red border for error */
      border-radius: 20px;
      padding: 20px;
      z-index: 2100;
      /* Higher than layer modal */
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      width: 320px;
      text-align: center;
      color: var(--text-main);
      display: none;
    }

    #errorOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      z-index: 2099;
      display: none;
    }

    #errorModal h3 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.1rem;
      font-weight: 600;
      color: #ff3b30;
      /* Red color for title */
    }

    #errorModal p {
      font-size: 0.9rem;
      margin-bottom: 20px;
      line-height: 1.4;
    }

    #errorModal button {
      background: var(--button-bg);
      border: 1px solid var(--button-border);
      color: var(--text-main);
      padding: 8px 20px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    #errorModal button:hover {
      background: var(--button-hover);
    }

    #layerModal h3 {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .layer-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .layer-option {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--glass-border);
      padding: 10px;
      border-radius: 10px;
      color: var(--text-main);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .layer-option:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .layer-option.active {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }

    /* Hide the default Buy Me a Coffee widget button */
    #bmc-wbtn {
      display: none !important;
    }

    #screenshotBtn:hover {
      transform: scale(1.1);
      background-color: var(--button-hover);
    }

    #toggleMarkersBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px var(--shadow-color);
      background-color: var(--button-hover);
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      height: 100%;
      width: 100%;
      z-index: 0;
      background-color: #262626;
    }

    /* Info Box Container */
    .infosbox {
      position: absolute;
      z-index: 1001;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 40px);
      max-width: 1400px;
      background-color: var(--glass-bg);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      padding: 4px 20px;
      border-radius: 25px;
      color: var(--text-main);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 32px var(--shadow-color);
      border: 1px solid var(--glass-border);
    }

    .infosbox.expanded {
      top: auto;
      bottom: 20px;
    }

    .infosbox.collapsed {
      top: auto;
      bottom: 20px;
    }

    .info-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .info-header {
      display: flex;
      justify-content: center;
      gap: 30px;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--glass-border);
      padding-bottom: 5px;
      margin-bottom: 2px;
      color: var(--text-header);
    }

    .info-body {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      flex-wrap: wrap;
    }

    .control-group.primary {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 2;
      min-width: 280px;
    }

    .playback-controls button {
      background-color: var(--button-bg);
      border: 1px solid var(--button-border);
      color: var(--text-main);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: background 0.2s;
    }

    .playback-controls button:hover {
      background: var(--button-hover);
    }

    .progress-container {
      flex-grow: 1;
      display: flex;
      align-items: center;
    }

    input[type="range"] {
      width: 100%;
      cursor: pointer;
      accent-color: var(--accent-color);
    }

    .data-group {
      display: flex;
      gap: 15px;
      flex: 3;
      justify-content: space-around;
      flex-wrap: wrap;
    }

    .data-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      min-width: 60px;
    }

    .data-item label {
      font-size: 0.65rem;
      color: var(--text-secondary);
      margin-bottom: 2px;
      text-transform: uppercase;
      font-weight: 600;
    }

    .data-item .value {
      font-size: 1rem;
      font-weight: 600;
      white-space: nowrap;
      color: var(--text-main);
      font-variant-numeric: tabular-nums;
    }

    .data-item .unit {
      font-size: 0.7rem;
      color: var(--text-secondary);
      margin-left: 1px;
    }

    /* Fix degree symbol alignment */
    .data-item .unit.degree {
      position: relative;
      top: -4px;
      font-size: 0.6rem;
    }

    .speed-control {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      min-width: 90px;
    }

    .speed-control input {
      width: 100%;
    }

    .aircraft-icon {
      background-color: transparent;
      border: none;
      transform-origin: center;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.9)) drop-shadow(0 4px 12px rgba(0, 0, 0, 0.6));
      /* Enhanced multi-layer shadow for maximum visibility and contrast */
    }

    .aircraft-icon svg {
      width: 32px;
      height: 32px;
    }

    #chart-container {
      height: 240px;
      background-color: transparent;
      overflow: hidden;
      margin-top: 5px;
      transition: height 0.3s ease, opacity 0.3s ease;
    }

    #chart-container.collapsed {
      height: 0;
      opacity: 0;
      margin-top: 0;
    }

    canvas {
      height: 240px;
    }

    /* Flight Selector Container */
    #flightSelectorContainer {
      position: absolute;
      top: 198px;
      left: 0;
      z-index: 1001;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: flex-start;
    }

    #flightSelectorContainer.collapsed {
      transform: translateX(calc(-100% + 0px));
    }

    .flight-selector {
      background-color: var(--glass-bg);
      padding: 10px;
      border-radius: 16px;
      color: var(--text-main);
      max-height: 50vh;
      overflow-y: auto;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      box-shadow: 0 4px 10px var(--shadow-color);
      border: 1px solid var(--glass-border);
      margin-left: 10px;
    }

    #flightSelectorToggle {
      position: absolute;
      top: 130px;
      left: 12px;
      z-index: 1001;
      padding: 10px;
      background-color: var(--glass-bg);
      color: var(--text-main);
      border-radius: 50%;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
    }

    #flightSelectorToggle:hover {
      background: var(--button-hover);
    }

    #flightSelectorToggle span {
      transition: transform 0.3s ease;
      display: inline-block;
      font-size: 12px;
    }

    #flightSelectorContainer.collapsed #flightSelectorToggle span {
      transform: rotate(180deg);
    }

    .flight-item {
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s;
      white-space: nowrap;
      font-size: 0.9rem;
      margin-bottom: 2px;
    }

    .flight-item:hover {
      background-color: var(--flight-hover);
    }

    .flight-item.active {
      background-color: var(--flight-active-bg);
      color: var(--flight-active-text);
      font-weight: 500;
    }

    /* Toggle Graph Button */
    #toggleGraphBtn {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: -17px;
      /* Adjusted position */
      background: var(--glass-bg);
      color: var(--text-main);
      border: 1px solid var(--glass-border);
      border-bottom: none;
      border-radius: 12px 12px 0 0;
      padding: 0;
      /* Reset padding */
      cursor: grab;
      /* Grab cursor */
      width: 60px;
      /* Wider button */
      height: 16px;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      box-shadow: 0 -2px 10px var(--shadow-color);
      display: none;
      /* Hidden by default */
      /* Flex to center handle */
      align-items: center;
      justify-content: center;
      z-index: 1002;
    }

    #toggleGraphBtn:active {
      cursor: grabbing;
    }

    #toggleGraphBtn .handle-bar {
      width: 30px;
      height: 4px;
      background-color: var(--text-secondary);
      border-radius: 2px;
      opacity: 0.5;
    }

    .tooltip-content {
      font-size: 13px;
      color: var(--text-main);
      border-radius: 12px;
      padding: 8px 12px;
      background: var(--tooltip-bg);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px var(--shadow-color);
      border: 1px solid var(--glass-border);
    }

    .tooltip-content strong {
      color: var(--text-main);
      font-weight: 600;
    }

    .speed-indicator {
      font-size: 0.7rem;
    }

    /* RESPONSIVE MEDIA QUERIES */
    @media (max-width: 1024px) {
      .infosbox {
        width: 96%;
        padding: 8px;
      }

      .data-group {
        gap: 10px;
      }
    }

    @media (max-width: 768px) {
      #multi_file_button {
        font-size: 0.85rem;
        padding: 6px 12px;
      }

      #toggleMarkersBtn {
        padding: 6px 14px;
        margin-top: 10px;
      }

      .flight-selector {
        /* Position above info box on mobile */
        left: 10px;
        max-width: 180px;
      }

      .infosbox {
        width: 96%;
        bottom: 15px;
        padding: 10px 10px;
      }

      .info-header {
        font-size: 0.75rem;
        gap: 8px;
        justify-content: space-evenly;
      }

      .control-group.primary {
        min-width: 0;
        width: 100%;
        margin-bottom: 5px;
      }

      .data-group {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        /* 2 columns for better readability */
        gap: 10px;
      }

      .data-item .value {
        font-size: 0.85rem;
      }

      .data-item label {
        font-size: 0.55rem;
      }

      .data-item.speed-control {
        grid-column: span 2;
        flex-direction: row;
        justify-content: center;
        gap: 10px;
      }

      .speed-control input {
        width: 60%;
      }

      #chart-container {
        height: 200px;
      }
    }
  </style>

  <style>
    /* Mobile Portrait Specific Refinements -> Now applied to all screens <= 939px */
    @media (max-width: 939px) {
      .infosbox {
        bottom: 25px;
        padding: 10px 8px;
        width: 95%;
      }

      .info-header {
        display: flex;
        justify-content: space-between;
        padding: 0 5px 8px 5px;
        font-size: 0.75rem;
        border-bottom: 1px solid var(--glass-border);
        margin-bottom: 10px;
      }

      /* FLEX CONTAINER FOR ROW 2 & 3 */
      .info-body {
        display: flex;
        flex-wrap: wrap;
        /* Allow wrapping */
        align-items: center;
        justify-content: space-between;
        gap: 0;
      }

      /* UNWRAP DATA GROUP to allow mixing children with control-group */
      .data-group {
        display: contents;
      }

      /* --- ROW 2: Playback Controls + Speed --- */

      /* 2A: Play/Progress (Left) */
      .control-group.primary {
        order: 1;
        flex: 1 1 55%;
        /* Take approx 55% width */
        min-width: 0;
        /* Allow shrinking */
        margin-right: 5px;
        margin-bottom: 12px;
        /* Push Row 3 down */
      }

      .progress-container {
        flex-grow: 1;
        margin: 0 5px;
      }

      /* 2B: Speed Control (Right) */
      .data-item.speed-control {
        order: 2;
        flex: 1 1 35%;
        /* Take remaining width */
        min-width: 0;
        display: flex;
        flex-direction: row;
        /* Force row layout */
        align-items: center;
        justify-content: flex-end;
        grid-column: auto;
        /* Reset grid if present */
        margin-bottom: 12px;
        /* Push Row 3 down */
        gap: 4px;
        width: auto !important;
        /* Override explicit widths */
      }

      .speed-control label {
        display: block !important;
        /* Make Visible */
        font-size: 0.6rem;
        margin: 0;
        color: var(--text-secondary);
      }

      .speed-control input {
        width: 70px !important;
        margin: 0 2px;
      }

      .speed-indicator {
        font-size: 0.8rem;
        min-width: 20px;
        text-align: right;
        margin-right: 9px;
      }

      /* --- ROW 3: Data Metrics (Alt, GS, Track, Time) --- */

      .data-item:not(.speed-control) {
        order: 3;
        flex: 1 1 22%;
        /* 4 items ~ 25% each */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-width: 0;
      }

      .data-item:not(.speed-control) label {
        font-size: 0.55rem;
        white-space: nowrap;
        margin-bottom: 2px;
        width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .data-item:not(.speed-control) .value {
        font-size: 0.85rem;
      }

      .data-item .unit {
        font-size: 0.6rem;
      }
    }

    /* CUSTOM ZOOM CONTROL STYLES */
    .leaflet-control-zoom {
      border: none !important;
      box-shadow: 0 4px 6px var(--shadow-color) !important;
      display: flex !important;
      flex-direction: column !important;
      /* Vertical layout */
      gap: 0 !important;
      /* No gap between buttons */
      margin-top: 20px !important;
      /* Top 10px */
      margin-left: 12px !important;
      /* Left 12px */
      background-color: var(--glass-bg) !important;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border: 1px solid var(--glass-border) !important;
      border-radius: 22px !important;
      /* Pill shape (half of 44px width) */
      overflow: hidden;
      /* integrated look */
      padding: 0 !important;
      width: 44px !important;
    }

    .leaflet-control-zoom a {
      background-color: transparent !important;
      color: var(--text-main) !important;
      border: none !important;
      border-radius: 0 !important;
      /* Reset radius */
      width: 42px !important;
      height: 44px !important;
      line-height: 44px !important;
      font-size: 22px !important;
      font-weight: 300 !important;
      box-shadow: none !important;
      transition: background 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin: 0 !important;
    }

    .leaflet-control-zoom a:hover {
      background-color: var(--button-hover) !important;
      color: var(--text-main) !important;
      transform: none !important;
      /* Disable scale to keep pill shape intact */
    }

    /* Standard Order: Plus (In) Top, Minus (Out) Bottom */
    .leaflet-control-zoom-in {
      order: 1;
      border-bottom: 1px solid var(--glass-border) !important;
      /* Separator line */
    }

    .leaflet-control-zoom-out {
      order: 2;
      border-right: none !important;
    }

    /* Remove default rounded corners from first/last child overrides */
    .leaflet-bar a:first-child {
      border-top-left-radius: 0 !important;
      border-top-right-radius: 0 !important;
    }

    .leaflet-bar a:last-child {
      border-bottom-left-radius: 0 !important;
      border-bottom-right-radius: 0 !important;
      border-bottom: none !important;
    }

    /* Center the icons */
    .leaflet-control-zoom-in span,
    .leaflet-control-zoom-out span {
      display: block;
      margin-top: -2px;
    }

    .leaflet-control-zoom-in span,
    .leaflet-control-zoom-out span {
      display: block;
      margin-top: -2px;
    }
  </style>
</head>

<body>
  <input type="file" id="multiCsvFiles" multiple onchange="handleMultiFiles()" />
  <label id="multi_file_button" for="multiCsvFiles">Select Flight file(s)</label>
  <button id="screenshotBtn" title="Take Screenshot">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
      <circle cx="12" cy="13" r="4"></circle>
    </svg>
  </button>
  <button id="tipBtn" title="Support me on Buy me a coffee!">
    <span class="btn-text">Leave a tip</span>
    <svg xmlns="http://www.w3.org/2000/svg" width="auto" height="24" viewBox="0 0 884 1279" fill="none">
      <path d="M791.109 297.518L790.231 297.002L788.201 296.383C789.018 297.072 790.04 297.472 791.109 297.518V297.518Z"
        fill="var(--bmc-icon-color)" />
      <path d="M803.896 388.891L802.916 389.166L803.896 388.891Z" fill="var(--bmc-icon-color)" />
      <path
        d="M791.484 297.377C791.359 297.361 791.237 297.332 791.118 297.29C791.111 297.371 791.111 297.453 791.118 297.534C791.252 297.516 791.379 297.462 791.484 297.377V297.377Z"
        fill="var(--bmc-icon-color)" />
      <path d="M791.113 297.529H791.244V297.447L791.113 297.529Z" fill="var(--bmc-icon-color)" />
      <path
        d="M803.111 388.726L804.591 387.883L805.142 387.573L805.641 387.04C804.702 387.444 803.846 388.016 803.111 388.726V388.726Z"
        fill="var(--bmc-icon-color)" />
      <path d="M793.669 299.515L792.223 298.138L791.243 297.605C791.77 298.535 792.641 299.221 793.669 299.515V299.515Z"
        fill="var(--bmc-icon-color)" />
      <path
        d="M430.019 1186.18C428.864 1186.68 427.852 1187.46 427.076 1188.45L427.988 1187.87C428.608 1187.3 429.485 1186.63 430.019 1186.18Z"
        fill="var(--bmc-icon-color)" />
      <path
        d="M641.187 1144.63C641.187 1143.33 640.551 1143.57 640.705 1148.21C640.705 1147.84 640.86 1147.46 640.929 1147.1C641.015 1146.27 641.084 1145.46 641.187 1144.63Z"
        fill="var(--bmc-icon-color)" />
      <path
        d="M619.284 1186.18C618.129 1186.68 617.118 1187.46 616.342 1188.45L617.254 1187.87C617.873 1187.3 618.751 1186.63 619.284 1186.18Z"
        fill="var(--bmc-icon-color)" />
      <path
        d="M281.304 1196.06C280.427 1195.3 279.354 1194.8 278.207 1194.61C279.136 1195.06 280.065 1195.51 280.684 1195.85L281.304 1196.06Z"
        fill="var(--bmc-icon-color)" />
      <path
        d="M247.841 1164.01C247.704 1162.66 247.288 1161.35 246.619 1160.16C247.093 1161.39 247.489 1162.66 247.806 1163.94L247.841 1164.01Z"
        fill="var(--bmc-icon-color)" />
      <path
        d="M472.623 590.836C426.682 610.503 374.546 632.802 306.976 632.802C278.71 632.746 250.58 628.868 223.353 621.274L270.086 1101.08C271.74 1121.13 280.876 1139.83 295.679 1153.46C310.482 1167.09 329.87 1174.65 349.992 1174.65C349.992 1174.65 416.254 1178.09 438.365 1178.09C462.161 1178.09 533.516 1174.65 533.516 1174.65C553.636 1174.65 573.019 1167.08 587.819 1153.45C602.619 1139.82 611.752 1121.13 613.406 1101.08L663.459 570.876C641.091 563.237 618.516 558.161 593.068 558.161C549.054 558.144 513.591 573.303 472.623 590.836Z"
        fill="#FFDD00" />
      <path
        d="M78.6885 386.132L79.4799 386.872L79.9962 387.182C79.5987 386.787 79.1603 386.435 78.6885 386.132V386.132Z"
        fill="var(--bmc-icon-color)" />
      <path
        d="M879.567 341.849L872.53 306.352C866.215 274.503 851.882 244.409 819.19 232.898C808.711 229.215 796.821 227.633 788.786 220.01C780.751 212.388 778.376 200.55 776.518 189.572C773.076 169.423 769.842 149.257 766.314 129.143C763.269 111.85 760.86 92.4243 752.928 76.56C742.604 55.2584 721.182 42.8009 699.88 34.559C688.965 30.4844 677.826 27.0375 666.517 24.2352C613.297 10.1947 557.342 5.03277 502.591 2.09047C436.875 -1.53577 370.983 -0.443234 305.422 5.35968C256.625 9.79894 205.229 15.1674 158.858 32.0469C141.91 38.224 124.445 45.6399 111.558 58.7341C95.7448 74.8221 90.5829 99.7026 102.128 119.765C110.336 134.012 124.239 144.078 138.985 150.737C158.192 159.317 178.251 165.846 198.829 170.215C256.126 182.879 315.471 187.851 374.007 189.968C438.887 192.586 503.87 190.464 568.44 183.618C584.408 181.863 600.347 179.758 616.257 177.304C634.995 174.43 647.022 149.928 641.499 132.859C634.891 112.453 617.134 104.538 597.055 107.618C594.095 108.082 591.153 108.512 588.193 108.942L586.06 109.252C579.257 110.113 572.455 110.915 565.653 111.661C551.601 113.175 537.515 114.414 523.394 115.378C491.768 117.58 460.057 118.595 428.363 118.647C397.219 118.647 366.058 117.769 334.983 115.722C320.805 114.793 306.661 113.611 292.552 112.177C286.134 111.506 279.733 110.801 273.333 110.009L267.241 109.235L265.917 109.046L259.602 108.134C246.697 106.189 233.792 103.953 221.025 101.251C219.737 100.965 218.584 100.249 217.758 99.2193C216.932 98.1901 216.482 96.9099 216.482 95.5903C216.482 94.2706 216.932 92.9904 217.758 91.9612C218.584 90.9319 219.737 90.2152 221.025 89.9293H221.266C232.33 87.5721 243.479 85.5589 254.663 83.8038C258.392 83.2188 262.131 82.6453 265.882 82.0832H265.985C272.988 81.6186 280.026 80.3625 286.994 79.5366C347.624 73.2302 408.614 71.0801 469.538 73.1014C499.115 73.9618 528.676 75.6996 558.116 78.6935C564.448 79.3474 570.746 80.0357 577.043 80.8099C579.452 81.1025 581.878 81.4465 584.305 81.7391L589.191 82.4445C603.438 84.5667 617.61 87.1419 631.708 90.1703C652.597 94.7128 679.422 96.1925 688.713 119.077C691.673 126.338 693.015 134.408 694.649 142.03L696.731 151.752C696.786 151.926 696.826 152.105 696.852 152.285C701.773 175.227 706.7 198.169 711.632 221.111C711.994 222.806 712.002 224.557 711.657 226.255C711.312 227.954 710.621 229.562 709.626 230.982C708.632 232.401 707.355 233.6 705.877 234.504C704.398 235.408 702.75 235.997 701.033 236.236H700.895L697.884 236.649L694.908 237.044C685.478 238.272 676.038 239.419 666.586 240.486C647.968 242.608 629.322 244.443 610.648 245.992C573.539 249.077 536.356 251.102 499.098 252.066C480.114 252.57 461.135 252.806 442.162 252.771C366.643 252.712 291.189 248.322 216.173 239.625C208.051 238.662 199.93 237.629 191.808 236.58C198.106 237.389 187.231 235.96 185.029 235.651C179.867 234.928 174.705 234.177 169.543 233.397C152.216 230.798 134.993 227.598 117.7 224.793C96.7944 221.352 76.8005 223.073 57.8906 233.397C42.3685 241.891 29.8055 254.916 21.8776 270.735C13.7217 287.597 11.2956 305.956 7.64786 324.075C4.00009 342.193 -1.67805 361.688 0.472751 380.288C5.10128 420.431 33.165 453.054 73.5313 460.35C111.506 467.232 149.687 472.807 187.971 477.556C338.361 495.975 490.294 498.178 641.155 484.129C653.44 482.982 665.708 481.732 677.959 480.378C681.786 479.958 685.658 480.398 689.292 481.668C692.926 482.938 696.23 485.005 698.962 487.717C701.694 490.429 703.784 493.718 705.08 497.342C706.377 500.967 706.846 504.836 706.453 508.665L702.633 545.797C694.936 620.828 687.239 695.854 679.542 770.874C671.513 849.657 663.431 928.434 655.298 1007.2C653.004 1029.39 650.71 1051.57 648.416 1073.74C646.213 1095.58 645.904 1118.1 641.757 1139.68C635.218 1173.61 612.248 1194.45 578.73 1202.07C548.022 1209.06 516.652 1212.73 485.161 1213.01C450.249 1213.2 415.355 1211.65 380.443 1211.84C343.173 1212.05 297.525 1208.61 268.756 1180.87C243.479 1156.51 239.986 1118.36 236.545 1085.37C231.957 1041.7 227.409 998.039 222.9 954.381L197.607 711.615L181.244 554.538C180.968 551.94 180.693 549.376 180.435 546.76C178.473 528.023 165.207 509.681 144.301 510.627C126.407 511.418 106.069 526.629 108.168 546.76L120.298 663.214L145.385 904.104C152.532 972.528 159.661 1040.96 166.773 1109.41C168.15 1122.52 169.44 1135.67 170.885 1148.78C178.749 1220.43 233.465 1259.04 301.224 1269.91C340.799 1276.28 381.337 1277.59 421.497 1278.24C472.979 1279.07 524.977 1281.05 575.615 1271.72C650.653 1257.95 706.952 1207.85 714.987 1130.13C717.282 1107.69 719.576 1085.25 721.87 1062.8C729.498 988.559 737.115 914.313 744.72 840.061L769.601 597.451L781.009 486.263C781.577 480.749 783.905 475.565 787.649 471.478C791.392 467.391 796.352 464.617 801.794 463.567C823.25 459.386 843.761 452.245 859.023 435.916C883.318 409.918 888.153 376.021 879.567 341.849ZM72.4301 365.835C72.757 365.68 72.1548 368.484 71.8967 369.792C71.8451 367.813 71.9483 366.058 72.4301 365.835ZM74.5121 381.94C74.6842 381.819 75.2003 382.508 75.7337 383.334C74.925 382.576 74.4089 382.009 74.4949 381.94H74.5121ZM76.5597 384.641C77.2996 385.897 77.6953 386.689 76.5597 384.641V384.641ZM80.672 387.979H80.7752C80.7752 388.1 80.9645 388.22 81.0333 388.341C80.9192 388.208 80.7925 388.087 80.6548 387.979H80.672ZM800.796 382.989C793.088 390.319 781.473 393.726 769.996 395.43C641.292 414.529 510.713 424.199 380.597 419.932C287.476 416.749 195.336 406.407 103.144 393.382C94.1102 392.109 84.3197 390.457 78.1082 383.798C66.4078 371.237 72.1548 345.944 75.2003 330.768C77.9878 316.865 83.3218 298.334 99.8572 296.355C125.667 293.327 155.64 304.218 181.175 308.09C211.917 312.781 242.774 316.538 273.745 319.36C405.925 331.405 540.325 329.529 671.92 311.91C695.905 308.686 719.805 304.941 743.619 300.674C764.835 296.871 788.356 289.731 801.175 311.703C809.967 326.673 811.137 346.701 809.778 363.615C809.359 370.984 806.139 377.915 800.779 382.989H800.796Z"
        fill="var(--bmc-icon-color)" />
    </svg>
  </button>
  <button id="layerBtn" title="Change Map Layer">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
      <polyline points="2 17 12 22 22 17"></polyline>
      <polyline points="2 12 12 17 22 12"></polyline>
    </svg>
  </button>
  <button id="infoBtn" title="Info & Contact">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
    </svg>
  </button>
  <div id="infoModal" style="display: none;">
    <h3>About Flight Playback</h3>

    <div class="info-group">
      <div class="info-label">Contact</div>
      <a href="mailto:flightplayback.webmaster@gmail.com" class="info-email">flightplayback.webmaster@gmail.com</a>
      <div class="info-subtext">For feedbacks and bug reports.</div>
    </div>

    <div class="info-group">
      <div class="info-label">Coming Soon</div>
      <div class="info-feature">3D Globe Visualiser</div>
    </div>

    <div class="version">Version 0.1.0</div>
  </div>
  <div id="layerModal" style="display: none;">
    <h3>Select Map Style</h3>
    <div class="layer-options">
      <!-- Options will be generated by JS or static -->
      <button class="layer-option active" onclick="switchBaseLayer('Esri Satellite')">Esri Satellite</button>
      <button class="layer-option" onclick="switchBaseLayer('OpenStreetMap')">OpenStreetMap</button>
      <button class="layer-option" onclick="switchBaseLayer('Esri Topo')">Esri Topo</button>
      <button class="layer-option" onclick="switchBaseLayer('Esri Streets')">Esri Streets</button>
      <button class="layer-option" onclick="switchBaseLayer('CartoDB Light')">CartoDB Light</button>
      <button class="layer-option" onclick="switchBaseLayer('CartoDB Dark')">CartoDB Dark</button>
      <button class="layer-option" onclick="switchBaseLayer('OpenTopoMap')">OpenTopoMap</button>
    </div>
  </div>
  <div id="map"></div>
  <div id="flightSelectorContainer" class="collapsed" style="display: none;">
    <div id="flightSelector" class="flight-selector"></div>
  </div>
  <button id="flightSelectorToggle" title="Toggle Flight List" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </button>
  <!-- <button id="toggleMarkersBtn">VFR</button> -->
  <div class="infosbox collapsed">
    <button id="toggleGraphBtn" title="Slide to toggle graph">
      <div class="handle-bar"></div>
    </button>

    <div class="info">
      <div class="info-grid">
        <div class="info-header">
          <div>LOC <span id="heure">--/--/---- --:--:--</span></div>
          <div>UTC <span id="UTCTime">--/--/---- --:--:--</span></div>
        </div>

        <div class="info-body">
          <div class="control-group primary">
            <div class="playback-controls">
              <button id="playPauseBtn">▶</button>
            </div>
            <div class="progress-container">
              <input type="range" id="progressBar" value="0" min="0" step="1" disabled>
            </div>
          </div>

          <div class="data-group">
            <div class="data-item speed-control">
              <label>Speed</label>
              <input type="range" id="speedControl" min="0" max="8" value="0" step="1" disabled>
              <span class="speed-indicator" id="speedIndicator">1x</span>
            </div>

            <div class="data-item">
              <label>Baro Altitude</label>
              <div class="value"><span id="altitude">-----</span><span class="unit">ft</span></div>
            </div>

            <div class="data-item">
              <label>Ground Speed</label>
              <div class="value"><span id="vitesse">----</span><span class="unit">kts</span></div>
            </div>

            <div class="data-item">
              <label>Track</label>
              <div class="value"><span id="direction">---</span><span class="unit degree">°</span></div>
            </div>

            <div class="data-item">
              <label>Actual Flt Time</label>
              <div class="value"><span id="flightTime">--:--:--</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="chart-container" class="collapsed">
      <canvas id="flightChart"></canvas>
    </div>
  </div>

  <script>
    let aircraftMarker = null;
    let flightPath = null;
    let flightPathPoints = [];
    let playbackInterval = null;
    let isPlaying = false;
    let playbackSpeed = 200;
    let chartInstance = null;
    let currentTooltip = null;
    let flightName = "";
    let altitudeSegments = [];
    let allFlights = [];
    let currentFlightIndex = 0;
    let currentFlightData = null;

    function calculateFlightTime(data) {
      if (!data || data.length === 0) return "00:00:00";

      let firstAirborneTimestamp = null;
      for (let i = 0; i < data.length; i++) {
        if (parseFloat(data[i].Altitude) > 0) {
          firstAirborneTimestamp = parseInt(data[i].Timestamp);
          break;
        }
      }

      let lastAirborneTimestamp = null;
      for (let i = data.length - 1; i >= 0; i--) {
        if (parseFloat(data[i].Altitude) > 0) {
          lastAirborneTimestamp = parseInt(data[i].Timestamp);
          break;
        }
      }

      if (firstAirborneTimestamp && lastAirborneTimestamp) {
        const durationSeconds = lastAirborneTimestamp - firstAirborneTimestamp;
        const hours = Math.floor(durationSeconds / 3600);
        const minutes = Math.floor((durationSeconds % 3600) / 60);
        const seconds = Math.floor(durationSeconds % 60);

        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }

      return "00:00:00";
    }

    function createAircraftIcon(rotation = 0, model = "") {
      const isAirbusA320 = /A3(1[89]|2[01])/i.test(model || "");
      const isAirbusA330 = /A33[23789P]|A30[LT]/i.test(model || "");
      const isAirbusA340 = /A34[23456]|A340/i.test(model || "");
      const isAirbusA380 = /A388|A380/i.test(model || "");
      const isBoeing737 = /B(3[789]M|73[1-9])/i.test(model || "");
      const isBoeing747 = /B74[1-48DRSCF]|BLCF/i.test(model || "");
      const isBoeing757 = /B75[023]/i.test(model || "");
      const isBoeing767 = /B76[234]|B462|B767/i.test(model || "");
      const isBoeing777 = /B77[2L3WX89F]/i.test(model || "");
      const isBoeing787 = /B78[89X]/i.test(model || "");
      const isEmbraerEJet = /E(19[05]|295)/i.test(model || "");

      let svgHtml = '';
      if (isAirbusA320) {
        // Custom Airbus A320 Family Silhouette (user-provided exact path)
        svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <path d="M 251.239 4.012 C 242.63 11.82 234.623 25.533 230.719 39.347 C 229.117 45.252 228.817 51.959 228.316 111.718 L 227.816 177.582 L 211.3 186.391 L 194.784 195.299 L 194.183 180.085 C 193.783 169.674 193.082 163.769 191.981 161.166 L 190.379 157.362 L 176.566 157.663 L 162.752 157.963 L 161.251 160.966 C 160.25 163.168 159.749 168.773 159.449 181.686 C 158.948 202.006 159.249 204.208 162.752 205.109 C 164.654 205.609 165.255 206.41 165.255 208.412 C 165.255 211.015 161.451 213.117 97.989 247.15 C 60.953 266.869 29.622 284.186 28.421 285.488 C 25.218 288.891 23.416 296.098 22.315 309.611 C 21.814 315.918 21.514 321.323 21.714 321.423 C 21.814 321.623 23.216 319.221 24.817 316.018 L 27.62 310.212 L 99.09 285.388 L 170.46 260.563 L 199.388 260.563 L 228.316 260.563 L 228.316 315.817 C 228.316 382.282 229.618 399.7 236.725 427.427 L 239.027 436.536 L 233.922 441.541 C 228.116 447.246 213.602 457.856 190.279 473.272 C 181.471 479.077 173.463 484.983 172.562 486.485 C 171.361 488.186 170.76 491.79 170.46 497.896 C 170.059 505.703 170.26 506.804 171.661 506.804 C 172.562 506.804 189.478 502.7 209.298 497.796 C 229.117 492.791 245.633 488.787 246.134 488.787 C 246.634 488.787 247.435 492.29 248.036 496.695 C 248.636 500.999 249.938 506.304 250.939 508.406 C 252.64 511.809 253.241 512.31 256.344 512.31 C 259.447 512.31 260.047 511.809 261.749 508.406 C 262.75 506.304 264.051 500.999 264.652 496.695 C 265.253 492.29 266.053 488.787 266.554 488.787 C 267.054 488.787 283.571 492.891 303.39 497.796 C 323.209 502.801 340.126 506.804 341.027 506.804 C 342.428 506.804 342.628 505.703 342.228 497.896 C 341.928 491.79 341.327 488.186 340.126 486.384 C 339.125 484.983 331.317 479.077 322.609 473.372 C 299.987 458.457 284.672 447.346 278.766 441.541 L 273.661 436.536 L 275.963 427.427 C 283.07 399.7 284.371 382.282 284.371 315.817 L 284.371 260.563 L 313.3 260.563 L 342.228 260.563 L 413.598 285.388 L 485.068 310.212 L 487.871 316.018 C 489.472 319.221 490.873 321.623 490.974 321.423 C 491.174 321.323 490.873 315.918 490.373 309.611 C 489.272 296.098 487.47 288.891 484.267 285.488 C 483.066 284.186 451.735 266.869 414.699 247.15 C 351.237 213.117 347.433 211.015 347.433 208.412 C 347.433 206.41 348.034 205.609 349.935 205.109 C 353.439 204.208 353.739 202.006 353.239 181.686 C 352.938 168.773 352.438 163.168 351.437 160.966 L 349.935 157.963 L 336.122 157.663 L 322.308 157.362 L 320.707 161.166 C 319.606 163.769 318.905 169.674 318.505 180.085 L 317.904 195.299 L 301.188 186.291 L 284.371 177.282 L 284.371 115.121 C 284.271 48.356 284.071 44.652 279.066 31.139 C 277.765 27.435 275.062 21.83 273.26 18.727 C 269.757 12.921 258.246 0.308 256.344 0.308 C 255.843 0.308 253.541 2.01 251.239 4.012 Z" fill="#fed700"/>
          </svg>
        `;
      } else if (isAirbusA330) {
        // Custom Airbus A330 Family Silhouette (user-provided exact path)
        svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2507 5080 c-68 -80 -132 -246 -161 -420 -28 -167 -36 -354 -36 -820 l0 -456 -47 -36 c-43 -32 -309 -198 -318 -198 -2 0 -5 56 -7 123 -2 86 -7 129 -17 140 -11 14 -33 17 -112 17 -134 0 -134 1 -134 -209 0 -152 1 -156 23 -166 59 -26 50 -32 -754 -534 -514 -321 -783 -495 -798 -515 -12 -17 -48 -66 -79 -108 -44 -60 -57 -85 -57 -113 0 -19 2 -35 5 -35 3 0 427 165 942 366 l938 366 185 14 c102 7 190 13 196 14 9 0 13 -138 17 -512 5 -512 13 -672 53 -983 14 -114 48 -297 60 -328 4 -11 -62 -59 -233 -172 -131 -86 -269 -178 -308 -203 -86 -58 -105 -91 -105 -184 0 -48 4 -68 13 -68 7 0 159 40 337 90 179 49 332 90 340 90 11 0 21 -28 38 -98 24 -106 43 -142 72 -142 29 0 48 36 72 142 17 70 27 98 38 98 8 0 161 -41 340 -90 178 -50 330 -90 337 -90 20 0 17 127 -5 170 -18 38 -9 31 -395 285 -173 114 -237 161 -233 172 13 32 46 214 60 328 42 336 56 603 56 1088 0 319 3 407 13 407 6 -1 95 -7 197 -14 l185 -14 938 -366 c515 -201 939 -366 942 -366 3 0 5 16 5 35 0 28 -13 53 -57 113 -31 42 -67 91 -79 108 -15 20 -285 195 -798 515 -804 502 -813 508 -753 534 21 10 22 14 22 166 0 210 0 209 -134 209 -79 0 -101 -3 -112 -17 -10 -11 -15 -54 -17 -140 -2 -67 -5 -123 -7 -123 -9 0 -275 166 -317 198 l-48 36 0 451 c0 600 -14 777 -75 988 -44 153 -129 297 -175 297 -10 0 -34 -18 -53 -40z" fill="#fed700"/>
            </g>
          </svg>
        `;
      } else if (isAirbusA340) {
        // Custom Airbus A340 Family Silhouette (user-provided exact path)
        svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2507 5053 c-58 -88 -78 -129 -116 -236 -73 -207 -74 -216 -80 -894 -6 -591 -7 -612 -26 -638 -11 -15 -92 -73 -180 -129 l-160 -103 -3 88 c-3 81 -5 90 -29 109 -42 33 -149 25 -175 -14 -4 -6 -8 -81 -8 -166 l0 -155 -306 -195 c-168 -107 -310 -196 -315 -198 -5 -2 -9 45 -9 111 0 125 -6 141 -56 153 -39 10 -114 -2 -133 -20 -13 -14 -17 -48 -21 -203 l-5 -187 -325 -207 -325 -207 -67 -104 c-55 -85 -67 -110 -67 -146 l-1 -42 60 30 c62 31 785 320 801 320 5 0 9 -6 9 -14 0 -7 6 -19 14 -25 12 -10 17 -8 25 8 6 11 11 28 11 39 0 14 14 25 53 40 28 11 59 23 68 27 13 5 18 -2 23 -29 8 -43 23 -47 32 -8 12 60 21 68 105 101 46 18 89 35 95 37 6 3 15 -9 20 -26 13 -45 26 -42 39 10 l11 45 104 41 105 41 10 -34 c14 -47 28 -43 39 11 l9 45 89 36 c48 19 94 35 101 35 7 0 17 -19 23 -42 12 -58 36 -57 50 2 13 53 16 54 194 65 l118 7 5 -468 c4 -479 13 -632 57 -989 11 -88 28 -198 37 -243 11 -56 13 -86 6 -90 -118 -75 -569 -392 -579 -407 -17 -27 -44 -131 -44 -173 0 -27 3 -32 18 -28 9 3 46 12 82 21 36 9 181 52 322 96 142 43 261 79 266 79 4 0 13 -28 20 -63 17 -89 30 -130 47 -152 15 -20 15 -20 30 0 17 22 30 63 47 153 7 34 16 62 21 62 4 0 103 -30 220 -66 175 -54 451 -134 464 -134 17 0 -16 167 -41 205 -10 15 -461 332 -579 407 -7 4 -5 34 6 90 9 45 26 155 37 243 44 357 53 510 57 989 l5 469 106 -7 c186 -12 189 -12 196 -54 3 -21 11 -44 16 -52 9 -13 12 -12 25 4 8 11 15 29 15 40 0 45 12 46 110 8 l95 -38 12 -48 c7 -27 15 -51 18 -54 10 -10 25 21 25 52 0 23 3 27 18 21 9 -4 58 -23 109 -42 85 -33 92 -38 98 -67 4 -17 9 -40 12 -50 5 -19 6 -19 19 -1 8 10 14 27 14 37 0 24 2 24 111 -20 l94 -38 7 -44 c4 -23 10 -45 13 -49 9 -8 25 21 25 47 0 28 3 27 75 -2 52 -21 60 -28 70 -62 13 -47 32 -54 46 -16 l10 29 382 -152 c210 -83 406 -164 435 -178 l52 -27 -1 42 c0 36 -12 61 -67 146 l-67 104 -325 207 -325 207 -6 189 c-3 105 -6 191 -7 192 -1 1 -16 10 -34 19 -40 21 -131 15 -156 -10 -13 -13 -18 -41 -22 -130 l-5 -113 -307 196 -308 196 0 157 0 157 -26 20 c-43 34 -150 26 -176 -13 -4 -6 -8 -49 -8 -95 0 -71 -2 -82 -16 -77 -43 16 -317 202 -332 224 -15 24 -18 85 -23 637 -5 577 -7 615 -28 707 -23 104 -70 247 -103 313 -29 58 -108 175 -118 175 -5 0 -29 -30 -53 -67z" fill="#fed700"/>
            </g>
          </svg>
        `;
      } else if (isAirbusA380) {
        // Custom Airbus A380 Superjumbo Silhouette (user-provided exact path)
        svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2504 5083 c-69 -68 -128 -238 -159 -453 -15 -107 -34 -457 -38 -720 l-2 -144 -265 -223 -265 -223 -5 130 c-4 101 -8 133 -20 140 -22 14 -184 12 -198 -2 -9 -9 -12 -76 -12 -239 l0 -226 -232 -195 -233 -196 -3 129 c-3 129 -3 130 -28 139 -33 13 -145 13 -178 0 l-26 -10 0 -227 0 -228 -358 -301 c-196 -165 -367 -315 -380 -334 -40 -59 -54 -127 -59 -270 l-4 -135 29 32 c22 26 113 70 432 212 223 99 411 181 419 183 8 2 17 -10 23 -29 11 -40 35 -43 44 -5 16 73 17 75 115 119 52 23 97 42 102 42 4 1 7 -8 7 -18 0 -62 35 -68 50 -8 6 23 12 47 14 52 3 8 118 63 191 91 7 3 17 -12 24 -36 17 -58 38 -51 51 18 l12 59 366 162 c202 90 372 165 379 168 8 3 12 -143 16 -584 5 -619 11 -714 56 -876 l19 -68 -317 -262 c-174 -143 -322 -268 -329 -277 -76 -89 -134 -226 -148 -348 -11 -98 -18 -99 454 81 389 148 407 154 414 133 3 -11 18 -77 33 -146 54 -252 76 -252 130 0 15 69 30 135 33 146 7 21 25 15 414 -133 472 -180 465 -179 454 -81 -14 122 -72 259 -148 348 -7 9 -155 134 -329 277 l-317 262 19 68 c45 162 51 257 56 876 4 441 8 587 16 584 7 -3 177 -78 379 -168 l366 -162 12 -59 c13 -69 34 -76 51 -18 7 24 17 39 24 36 73 -28 188 -83 191 -91 2 -5 8 -29 14 -52 15 -60 50 -54 50 8 0 10 3 19 8 18 4 0 49 -19 101 -42 98 -44 99 -46 115 -119 9 -38 33 -35 44 5 6 19 15 31 23 29 8 -2 196 -84 419 -183 319 -142 410 -186 432 -212 l29 -32 -4 135 c-5 139 -18 205 -56 267 -11 17 -182 168 -380 335 l-361 303 0 227 c0 214 -1 228 -19 238 -25 13 -151 13 -185 0 -25 -9 -25 -10 -28 -139 l-3 -129 -232 196 -233 195 0 226 c0 163 -3 230 -12 239 -14 14 -176 16 -198 2 -12 -7 -16 -39 -20 -140 l-5 -130 -265 223 -265 223 -2 144 c-4 263 -23 613 -38 720 -20 138 -58 280 -96 358 -35 71 -90 132 -119 132 -11 0 -36 -16 -56 -37z" fill="#fed700"/>
            </g>
          </svg>
        `;
      } else if (isBoeing737) {
        // Custom Boeing 737 Silhouette (user-provided exact path)
        svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0,512) scale(0.1,-0.1)">
              <path d="M2517 5043 c-135 -290 -233 -673 -267 -1043 -5 -63 -10 -246 -10 -406 l0 -292 -64 -59 c-94 -88 -302 -243 -327 -243 -5 0 -9 29 -9 65 l0 66 -107 -3 -108 -3 -5 -128 -5 -129 -690 -339 c-379 -187 -701 -350 -714 -362 -48 -44 -71 -113 -71 -214 0 -63 4 -93 11 -93 11 0 1377 381 1433 400 26 9 33 6 65 -28 28 -29 39 -52 49 -101 16 -78 36 -77 40 2 3 53 5 57 28 57 44 0 64 17 64 55 l0 35 98 0 c53 0 140 -3 193 -6 l96 -7 6 -326 c7 -429 39 -804 89 -1046 11 -55 21 -106 22 -114 0 -8 -60 -57 -135 -110 -340 -240 -561 -405 -568 -425 -9 -23 -22 -246 -15 -246 5 0 840 208 865 216 12 3 18 -7 25 -43 l9 -48 45 0 45 0 9 48 c7 36 13 46 25 43 59 -18 864 -216 867 -214 2 2 0 59 -5 126 -6 102 -11 126 -27 141 -25 25 -484 356 -602 434 -75 50 -91 66 -87 82 63 249 104 669 112 1156 l6 326 96 7 c53 3 140 6 194 6 l97 0 0 -35 c0 -38 20 -55 64 -55 23 0 25 -4 28 -57 4 -79 24 -80 40 -2 10 49 21 72 49 101 32 34 39 37 65 28 56 -19 1422 -400 1433 -400 7 0 11 30 11 93 0 101 -23 170 -71 214 -13 12 -335 175 -714 362 l-690 339 -5 129 -5 128 -107 3 -108 3 0 -66 c0 -36 -4 -65 -9 -65 -25 0 -233 155 -327 243 l-64 59 0 292 c0 160 -5 343 -10 406 -28 299 -99 616 -197 875 -42 111 -104 245 -113 245 -4 0 -23 -35 -43 -77z" fill="#fed700"/>
            </g>
          </svg>
        `;
      } else if (isBoeing747) {
        // Custom Boeing 747 Silhouette (user-provided exact path)
        svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2512 5104 c-83 -58 -152 -303 -182 -639 -6 -66 -14 -281 -17 -478 l-6 -358 -226 -199 -226 -200 -5 66 c-6 82 -20 94 -105 94 -98 0 -105 -9 -105 -138 0 -59 4 -113 9 -120 4 -7 20 -16 36 -20 27 -8 16 -18 -256 -259 l-284 -252 -3 77 c-2 42 -8 82 -14 89 -14 17 -159 18 -176 1 -8 -8 -12 -52 -12 -130 0 -96 3 -120 15 -124 9 -4 15 -19 15 -38 -1 -28 -27 -54 -285 -281 l-284 -250 0 -235 c0 -129 3 -228 6 -220 4 8 13 48 22 89 l16 74 590 335 590 335 325 104 c179 57 333 106 343 109 16 5 17 -27 17 -579 0 -450 4 -619 15 -738 16 -163 40 -314 55 -353 10 -27 16 -20 -426 -447 l-202 -194 -7 -108 c-4 -60 -5 -111 -2 -113 2 -3 168 44 368 104 200 60 365 108 367 107 2 -2 12 -42 23 -89 12 -47 29 -96 40 -108 l19 -23 19 23 c11 12 28 61 40 108 11 47 21 87 23 89 2 1 167 -47 367 -107 200 -60 366 -107 368 -104 3 2 2 53 -2 113 l-7 108 -202 194 c-442 427 -436 420 -426 447 15 39 39 190 55 353 11 119 15 288 15 738 0 552 1 584 18 579 9 -3 163 -52 342 -109 l326 -104 589 -335 590 -335 16 -74 c9 -41 18 -81 22 -89 3 -8 6 91 6 220 l0 235 -284 250 c-258 227 -284 253 -285 281 0 19 6 34 15 38 12 4 15 28 15 124 0 78 -4 122 -12 130 -17 17 -162 16 -176 -1 -6 -7 -12 -47 -14 -89 l-3 -77 -284 252 c-272 241 -283 251 -256 259 16 4 32 13 36 20 5 7 9 61 9 120 0 129 -7 138 -105 138 -85 0 -99 -12 -105 -94 l-5 -66 -226 200 -226 199 -6 358 c-4 197 -11 412 -17 478 -36 406 -123 655 -230 655 -14 0 -36 -7 -48 -16z" fill="#fed700"/>
            </g>
          </svg>
        `;
      } else if (isBoeing757) {
        // Custom Boeing 757 Silhouette (user-provided exact path)
        svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2518 5102 c-61 -40 -106 -129 -139 -279 -22 -95 -23 -120 -28 -917 l-6 -820 -125 -48 c-69 -26 -141 -54 -161 -62 l-36 -15 14 52 c18 64 13 220 -8 262 -21 43 -52 55 -154 55 -102 0 -130 -11 -158 -57 -45 -77 -27 -281 29 -331 14 -12 26 -34 27 -48 2 -26 -10 -31 -692 -295 -764 -295 -743 -284 -781 -387 -21 -56 -42 -210 -29 -217 3 -3 18 18 33 45 39 72 72 96 145 103 69 7 493 91 992 196 l337 71 270 0 270 0 11 -31 c8 -22 11 -231 11 -663 0 -619 1 -634 25 -801 13 -94 31 -193 39 -219 8 -27 13 -53 10 -58 -6 -10 -130 -101 -401 -296 l-211 -152 -16 -67 c-8 -37 -14 -68 -13 -69 1 -2 158 36 349 84 191 48 349 84 352 82 2 -3 13 -52 23 -110 l19 -105 44 0 44 0 19 105 c10 58 21 107 23 110 3 2 161 -34 352 -82 191 -48 348 -86 349 -84 1 1 -5 32 -13 69 l-16 67 -211 152 c-271 195 -395 286 -401 296 -3 5 2 31 10 58 8 26 26 125 39 219 24 167 25 182 25 801 0 432 3 641 11 663 l11 31 269 0 270 0 457 -94 c251 -52 556 -113 677 -136 121 -23 230 -47 243 -53 12 -6 46 -39 74 -73 29 -34 55 -61 58 -59 12 7 -10 163 -30 217 -38 103 -17 92 -781 387 -682 264 -694 269 -692 295 1 14 13 36 27 48 56 50 74 254 29 331 -28 46 -56 57 -158 57 -102 0 -133 -12 -154 -55 -21 -42 -26 -198 -8 -262 l14 -52 -36 15 c-20 8 -92 36 -161 62 l-125 48 -6 820 c-5 797 -6 822 -28 917 -23 104 -57 191 -91 235 -25 32 -69 62 -90 62 -8 0 -27 -8 -42 -18z" fill="#fed700"/>
            </g>
          </svg>
        `;
      } else if (isBoeing767) {
        // Custom Boeing 767 Silhouette (user-provided exact path)
        svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2504 5088 c-123 -108 -199 -352 -224 -720 -6 -84 -10 -331 -9 -548 l0 -395 -34 -40 c-29 -35 -365 -285 -381 -285 -4 0 -3 62 0 138 6 131 6 138 -16 165 l-22 28 -121 -3 -122 -3 -19 -38 c-17 -36 -18 -49 -7 -180 10 -123 14 -144 32 -159 17 -14 20 -27 17 -75 l-3 -58 -230 -159 c-126 -87 -477 -328 -779 -534 -456 -312 -551 -381 -562 -408 -17 -41 -19 -175 -2 -192 7 -7 21 -12 31 -12 18 0 542 194 1077 399 222 85 236 89 244 70 13 -28 32 -23 42 12 8 26 19 35 84 60 58 23 312 79 359 79 5 0 12 -11 15 -25 9 -34 33 -31 41 5 8 35 1 32 195 65 85 15 163 29 173 31 16 5 17 -22 17 -478 0 -367 4 -514 15 -613 17 -142 40 -282 54 -333 9 -31 7 -35 -37 -76 -55 -51 -327 -282 -564 -479 -132 -110 -167 -144 -172 -169 -7 -37 -8 -158 -1 -158 3 0 203 50 445 110 242 61 444 110 449 110 5 0 12 -15 16 -32 33 -168 77 -168 110 0 4 17 11 32 16 32 5 0 207 -50 449 -110 242 -61 442 -110 445 -110 7 0 6 121 -1 158 -5 25 -40 59 -172 169 -237 197 -509 428 -564 479 -44 41 -46 45 -37 76 14 51 37 191 54 333 11 99 15 246 15 613 0 456 1 483 18 478 9 -2 87 -16 172 -31 194 -33 187 -30 195 -65 8 -36 32 -39 41 -5 3 14 10 25 15 25 47 0 301 -56 359 -79 65 -25 76 -34 84 -60 10 -35 29 -40 42 -12 8 19 22 15 244 -70 535 -205 1059 -399 1077 -399 10 0 24 5 31 12 17 17 15 151 -2 192 -11 27 -106 96 -562 408 -302 206 -652 447 -779 534 l-230 159 -3 58 c-3 48 0 61 17 75 18 15 22 37 32 154 12 148 5 199 -31 218 -10 6 -68 10 -129 10 -108 0 -110 0 -131 -27 -21 -27 -22 -34 -16 -165 4 -76 4 -138 1 -138 -17 0 -352 250 -382 285 l-34 40 0 395 c2 575 -19 812 -90 1026 -47 142 -143 274 -199 274 -11 0 -36 -15 -56 -32z" fill="#fed700"/>
            </g>
          </svg>
        `;
      } else if (isBoeing777) {
        // Custom Boeing 777 Silhouette (user-provided exact path)
        svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2498 5101 c-61 -48 -124 -222 -158 -436 -33 -206 -41 -346 -47 -816 l-6 -456 -150 -104 c-83 -57 -155 -105 -159 -107 -4 -2 -8 43 -8 101 0 122 -13 149 -83 168 -51 14 -155 5 -197 -16 l-30 -16 0 -192 c0 -161 3 -196 16 -216 14 -19 14 -25 3 -36 -8 -7 -348 -243 -756 -525 -843 -581 -784 -531 -791 -683 -6 -108 1 -114 86 -75 100 44 522 218 1008 414 l431 173 311 7 311 7 4 -589 4 -589 31 -175 32 -174 -20 -21 c-11 -11 -161 -135 -333 -276 l-312 -255 -3 -98 c-2 -88 -1 -98 14 -92 89 34 758 256 761 252 3 -3 19 -62 37 -132 21 -83 38 -131 49 -138 34 -21 50 5 83 138 18 70 34 129 37 132 3 4 672 -218 761 -252 15 -6 16 4 14 92 l-3 98 -312 255 c-172 141 -322 265 -333 276 l-20 21 32 174 31 175 4 589 4 589 311 -7 311 -7 431 -173 c486 -196 908 -370 1008 -414 85 -39 92 -33 86 75 -7 152 52 102 -791 683 -408 282 -746 516 -751 521 -6 5 -2 24 8 46 14 32 16 66 14 217 -3 178 -3 179 -28 198 -33 24 -140 34 -198 19 -68 -19 -76 -35 -82 -166 l-5 -114 -161 111 -161 112 -6 455 c-3 251 -11 510 -17 576 -24 268 -72 485 -132 598 -39 72 -69 97 -118 97 -22 0 -48 -8 -62 -19z" fill="#fed700"/>
            </g>
          </svg>
        `;
      } else if (isBoeing787) {
        // Custom Boeing 787 Dreamliner Silhouette (user-provided exact path)
        svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2496 5099 c-57 -45 -109 -172 -145 -351 -47 -237 -61 -444 -61 -913 l-1 -370 -187 -149 -187 -148 -5 151 c-7 201 -2 196 -181 196 l-131 0 -24 -28 c-24 -28 -24 -31 -24 -236 0 -196 1 -210 21 -235 11 -14 28 -26 37 -26 10 0 22 -8 29 -19 10 -16 -52 -69 -633 -536 -635 -511 -750 -612 -819 -720 -62 -96 -104 -242 -76 -260 7 -4 37 17 73 50 169 156 230 188 1146 589 l403 176 274 0 274 0 3 -487 c4 -439 6 -504 27 -653 12 -91 31 -204 41 -253 l18 -88 -308 -294 -307 -295 -7 -76 c-9 -107 -8 -124 7 -124 6 0 147 59 311 130 224 97 310 130 341 130 l41 0 12 -58 c6 -31 22 -78 34 -102 22 -43 25 -45 68 -45 43 0 46 2 68 45 12 24 28 71 34 102 l12 58 41 0 c31 0 117 -33 341 -130 164 -71 305 -130 313 -130 11 0 13 15 7 77 -3 42 -6 86 -6 98 0 16 -85 104 -309 318 l-309 296 18 88 c10 49 29 162 41 253 21 149 23 214 27 652 l3 488 274 0 274 0 403 -176 c916 -401 977 -433 1146 -589 36 -33 66 -54 73 -50 28 18 -14 164 -76 260 -69 108 -184 209 -819 720 -581 467 -643 520 -633 536 7 11 19 19 29 19 9 0 26 12 37 26 20 25 21 39 21 235 0 205 0 208 -24 236 l-24 28 -131 0 c-179 0 -174 5 -181 -197 l-5 -151 -185 149 -185 149 -6 455 c-7 495 -15 594 -60 828 -49 247 -119 372 -209 372 -23 0 -48 -8 -64 -21z" fill="#fed700"/>
            </g>
          </svg>
        `;
      } else if (isEmbraerEJet) {
        // Custom Embraer E-Jet Family Silhouette (user-provided exact path)
        svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)">
              <path d="M2518 5102 c-61 -40 -106 -129 -139 -279 -22 -95 -23 -120 -28 -917 l-6 -820 -125 -48 c-69 -26 -141 -54 -161 -62 l-36 -15 14 52 c18 64 13 220 -8 262 -21 43 -52 55 -154 55 -102 0 -130 -11 -158 -57 -45 -77 -27 -281 29 -331 14 -12 26 -34 27 -48 2 -26 -10 -31 -692 -295 -764 -295 -743 -284 -781 -387 -21 -56 -42 -210 -29 -217 3 -3 18 18 33 45 39 72 72 96 145 103 69 7 493 91 992 196 l337 71 270 0 270 0 11 -31 c8 -22 11 -231 11 -663 0 -619 1 -634 25 -801 13 -94 31 -193 39 -219 8 -27 13 -53 10 -58 -6 -10 -130 -101 -401 -296 l-211 -152 -16 -67 c-8 -37 -14 -68 -13 -69 1 -2 158 36 349 84 191 48 349 84 352 82 2 -3 13 -52 23 -110 l19 -105 44 0 44 0 19 105 c10 58 21 107 23 110 3 2 161 -34 352 -82 191 -48 348 -86 349 -84 1 1 -5 32 -13 69 l-16 67 -211 152 c-271 195 -395 286 -401 296 -3 5 2 31 10 58 8 26 26 125 39 219 24 167 25 182 25 801 0 432 3 641 11 663 l11 31 269 0 270 0 457 -94 c251 -52 556 -113 677 -136 121 -23 230 -47 243 -53 12 -6 46 -39 74 -73 29 -34 55 -61 58 -59 12 7 -10 163 -30 217 -38 103 -17 92 -781 387 -682 264 -694 269 -692 295 1 14 13 36 27 48 56 50 74 254 29 331 -28 46 -56 57 -158 57 -102 0 -133 -12 -154 -55 -21 -42 -26 -198 -8 -262 l14 -52 -36 15 c-20 8 -92 36 -161 62 l-125 48 -6 820 c-5 797 -6 822 -28 917 -23 104 -57 191 -91 235 -25 32 -69 62 -90 62 -8 0 -27 -8 -42 -18z" fill="#fed700"/>
            </g>
          </svg>
        `;
      } else {
        // Default Icon
        svgHtml = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="-23.0965 -12.669 72.53 48.12" width="36" height="36" style="transform: rotate(${rotation}deg); transform-origin: center;">
            <path d="M 16.793 12.613 H 32.585 l 15.491 -1.694 C 49.762 9.725 49.856 4.163 48.479 3.318 L 32.109 1.648 l -10.228 0 l -4.852 -1.868 L 16.139 -10.215 L 20.714 -10.552 C 20.971 -10.809 20.886 -11.009 20.714 -11.151 L 13.982 -11.067 L 13.276 -12.669 L 12.519 -11.032 L 5.731 -11.214 C 5.524 -11.108 5.56 -10.745 5.748 -10.598 L 10.257 -10.265 l -0.809 9.966 l -4.372 1.874 L -5.835 1.648 L -21.841 3.135 C -23.646 3.254 -23.46 10.775 -21.571 10.893 L -5.854 12.528 L 9.609 12.613 L 11.801 29.78 L 0.57 29.847 C -1.858 30.337 -0.087 35.092 0.879 35.454 l 24.282 0 C 27.535 34.283 27.704 29.561 25.157 29.746 L 14.652 29.78 Z" fill="black" stroke="black" stroke-width="0.8"/>
            <path d="M 16.793 12.613 H 32.585 l 15.491 -1.694 C 49.762 9.725 49.856 4.163 48.479 3.318 L 32.109 1.648 l -10.228 0 l -4.852 -1.868 L 16.139 -10.215 L 20.714 -10.552 C 20.971 -10.809 20.886 -11.009 20.714 -11.151 L 13.982 -11.067 L 13.276 -12.669 L 12.519 -11.032 L 5.731 -11.214 C 5.524 -11.108 5.56 -10.745 5.748 -10.598 L 10.257 -10.265 l -0.809 9.966 l -4.372 1.874 L -5.835 1.648 L -21.841 3.135 C -23.646 3.254 -23.46 10.775 -21.571 10.893 L -5.854 12.528 L 9.609 12.613 L 11.801 29.78 L 0.57 29.847 C -1.858 30.337 -0.087 35.092 0.879 35.454 l 24.282 0 C 27.535 34.283 27.704 29.561 25.157 29.746 L 14.652 29.78 Z" fill="#fed700"/>
          </svg>
        `;
      }

      return L.divIcon({
        className: 'aircraft-icon',
        html: svgHtml,
        iconSize: [32, 32],
        iconAnchor: [16, 16],
        popupAnchor: [0, -16]
      });
    }

    const altitudeColorMap = [
      { alt: 42651, color: 'rgb(255,0,0)' },
      { alt: 41010, color: 'rgb(255,0,228)' },
      { alt: 39370, color: 'rgb(216,0,255)' },
      { alt: 37730, color: 'rgb(174,0,255)' },
      { alt: 36089, color: 'rgb(150,0,255)' },
      { alt: 34449, color: 'rgb(120,0,255)' },
      { alt: 32808, color: 'rgb(96,0,255)' },
      { alt: 31168, color: 'rgb(78,0,255)' },
      { alt: 29528, color: 'rgb(54,0,255)' },
      { alt: 27887, color: 'rgb(36,0,255)' },
      { alt: 26247, color: 'rgb(18,0,255)' },
      { alt: 24606, color: 'rgb(0,0,255)' },
      { alt: 22966, color: 'rgb(0,30,255)' },
      { alt: 21325, color: 'rgb(0,48,255)' },
      { alt: 19685, color: 'rgb(0,84,255)' },
      { alt: 18045, color: 'rgb(0,120,255)' },
      { alt: 16404, color: 'rgb(0,150,255)' },
      { alt: 14764, color: 'rgb(0,168,255)' },
      { alt: 13123, color: 'rgb(0,192,255)' },
      { alt: 11483, color: 'rgb(0,234,255)' },
      { alt: 9843, color: 'rgb(0,255,228)' },
      { alt: 8202, color: 'rgb(0,255,210)' },
      { alt: 6562, color: 'rgb(0,255,156)' },
      { alt: 4921, color: 'rgb(0,255,114)' },
      { alt: 3937, color: 'rgb(0,255,54)' },
      { alt: 3281, color: 'rgb(0,255,12)' },
      { alt: 2625, color: 'rgb(30,255,0)' },
      { alt: 1969, color: 'rgb(66,255,0)' },
      { alt: 1312, color: 'rgb(204,255,0)' },
      { alt: 984, color: 'rgb(240,255,0)' },
      { alt: 656, color: 'rgb(255,234,0)' },
      { alt: 328, color: 'rgb(255,224,98)' },
      { alt: 0, color: 'rgb(255,255,255)' }
    ];

    function getTrackWeight() {
      const userAgent = navigator.userAgent || navigator.vendor || window.opera;
      const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
      const isMacIPad = (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      return (isIOS || isMacIPad) ? 2 : 4;
    }


    function getColorFromAltitude(feet) {
      for (let i = 0; i < altitudeColorMap.length; i++) {
        if (feet >= altitudeColorMap[i].alt) {
          return altitudeColorMap[i].color;
        }
      }
      return 'rgb(255,255,255)';
    }

    function formatTime(rawTimestamp) {
      if (!rawTimestamp) return 'Heure inconnue';
      let date;
      if (!isNaN(rawTimestamp) && rawTimestamp.length >= 10) {
        const num = Number(rawTimestamp);
        date = new Date(num > 1e12 ? num : num * 1000);
      } else {
        date = new Date(rawTimestamp);
      }
      if (isNaN(date.getTime())) return 'Heure inconnue';
      return date.toLocaleString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function formatUTCTime(utcTimestamp) {
      if (!utcTimestamp) return 'N/A';
      const date = new Date(utcTimestamp);
      if (isNaN(date.getTime())) return utcTimestamp;

      const day = String(date.getUTCDate()).padStart(2, '0');
      const month = String(date.getUTCMonth() + 1).padStart(2, '0');
      const year = date.getUTCFullYear();
      const hours = String(date.getUTCHours()).padStart(2, '0');
      const minutes = String(date.getUTCMinutes()).padStart(2, '0');
      const seconds = String(date.getUTCSeconds()).padStart(2, '0');

      return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
    }

    const map = L.map('map', {
      preferCanvas: true,
      minZoom: 2,
      worldCopyJump: true
    }).setView([37.5, 14.2], 3);

    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      crossOrigin: true,
      detectRetina: true
    });
    const esriTopo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; Esri',
      crossOrigin: true,
      detectRetina: true
    });
    const esriStreets = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; Esri',
      crossOrigin: true,
      detectRetina: true
    });
    const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; Esri',
      crossOrigin: true,
      detectRetina: true
    });
    const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://carto.com/">CartoDB</a>',
      subdomains: 'abcd',
      crossOrigin: true,
      detectRetina: true
    });
    const cartoDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://carto.com/">CartoDB</a>',
      subdomains: 'abcd',
      crossOrigin: true,
      detectRetina: true
    });
    const opentopomap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> contributors',
      crossOrigin: true,
      detectRetina: true
    });

    esriSatellite.addTo(map);
    L.control.scale().addTo(map);

    // Base layers object for easy access
    const baseLayers = {
      "Esri Satellite": esriSatellite,
      "OpenStreetMap": osmLayer,
      "Esri Topo": esriTopo,
      "Esri Streets": esriStreets,
      "CartoDB Light": cartoLight,
      "CartoDB Dark": cartoDark,
      "OpenTopoMap": opentopomap
    };

    let currentLayerName = "Esri Satellite";

    const layerBtn = document.getElementById('layerBtn');
    const layerModal = document.getElementById('layerModal');
    const infoBtn = document.getElementById('infoBtn');
    const infoModal = document.getElementById('infoModal');

    // Layer Menu Logic
    layerBtn.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent click from bubbling to document
      layerModal.style.display = layerModal.style.display === 'block' ? 'none' : 'block';
      // Close other modals if open
      infoModal.style.display = 'none';
    });

    // Info Menu Logic
    infoBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      infoModal.style.display = infoModal.style.display === 'block' ? 'none' : 'block';
      // Close other modals if open
      layerModal.style.display = 'none';
    });

    // Close modals when clicking outside
    document.addEventListener('click', (e) => {
      if (layerModal.style.display === 'block' &&
        !layerModal.contains(e.target) &&
        e.target !== layerBtn &&
        !layerBtn.contains(e.target)) {
        layerModal.style.display = 'none';
      }

      if (infoModal.style.display === 'block' &&
        !infoModal.contains(e.target) &&
        e.target !== infoBtn &&
        !infoBtn.contains(e.target)) {
        infoModal.style.display = 'none';
      }
    });

    window.switchBaseLayer = function (name) {
      if (currentLayerName === name) {
        layerModal.style.display = 'none';
        return;
      }

      // Remove current layer
      if (baseLayers[currentLayerName]) {
        map.removeLayer(baseLayers[currentLayerName]);
      }

      // Add new layer
      if (baseLayers[name]) {
        map.addLayer(baseLayers[name]);
      }
      currentLayerName = name;

      // Update UI active state
      document.querySelectorAll('.layer-option').forEach(btn => {
        if (btn.textContent === name) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      // Close modal
      layerModal.style.display = 'none';
    };

    // Error Modal & Overlay
    const errorOverlay = document.createElement('div');
    errorOverlay.id = 'errorOverlay';
    document.body.appendChild(errorOverlay);

    const errorModal = document.createElement('div');
    errorModal.id = 'errorModal';
    errorModal.innerHTML = `
      <h3>File Format Error</h3>
      <p>One or more files format not supported.<br>Please use files from FlightRadar24 output.</p>
      <button id="errorOkBtn">OK</button>
    `;
    document.body.appendChild(errorModal);

    function closeErrorPopup() {
      document.getElementById('errorModal').style.display = 'none';
      document.getElementById('errorOverlay').style.display = 'none';
      // Reset input so same file can be selected again if needed
      if (multiFileInput) multiFileInput.value = '';
    }

    document.getElementById('errorOkBtn').addEventListener('click', closeErrorPopup);
    // Also close on overlay click?
    // errorOverlay.addEventListener('click', closeErrorPopup);

    function showErrorPopup() {
      document.getElementById('errorOverlay').style.display = 'block';
      document.getElementById('errorModal').style.display = 'block';
      // Also reset input immediately so if they cancel/close, it's ready
      if (multiFileInput) multiFileInput.value = '';

      // Reset main button text
      const btn = document.getElementById('multi_file_button');
      if (btn) btn.textContent = 'Select Flight file(s)';
    }

    const multiFileInput = document.getElementById('multiCsvFiles');

    // Apply file filter for PC and iPad, but leave open for iPhone
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    const isIPhone = /iPhone/i.test(ua) && !window.MSStream;
    if (!isIPhone) {
      multiFileInput.setAttribute('accept', '.csv, .kml');
    }
    const progressBar = document.getElementById('progressBar');
    const mainTitle = document.getElementById('multi_file_button');
    const heureEl = document.getElementById('heure');
    const altitudeEl = document.getElementById('altitude');
    const vitesseEl = document.getElementById('vitesse');
    const directionEl = document.getElementById('direction');
    const flightTimeEl = document.getElementById('flightTime');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const speedControl = document.getElementById('speedControl');
    const flightSelector = document.getElementById('flightSelector');
    const flightSelectorContainer = document.getElementById('flightSelectorContainer');
    const flightSelectorToggle = document.getElementById('flightSelectorToggle');

    const speedPresets = [
      1000, // 1x
      500,  // 2x
      250,  // 4x
      125,  // 8x
      50,   // 20x
      25,   // 40x
      10,   // 100x
      5,    // 200x
      3.33  // 300x
    ];

    const speedLabels = [
      "1x", "2x", "4x", "8x", "20x", "40x", "100x", "200x", "300x"
    ];

    playPauseBtn.addEventListener('click', togglePlayPause);
    document.getElementById('screenshotBtn').addEventListener('click', takeScreenshot);
    flightSelectorToggle.addEventListener('click', function () {
      flightSelectorContainer.classList.toggle('collapsed');
    });

    speedControl.addEventListener('input', function () {
      const speedIndex = parseInt(this.value);
      playbackSpeed = speedPresets[speedIndex];
      speedIndicator.textContent = speedLabels[speedIndex];
      if (isPlaying) {
        pauseFlight();
        playFlight();
      }
    });

    function togglePlayPause() {
      if (isPlaying) {
        pauseFlight();
      } else {
        playFlight();
      }
      updatePlayPauseButton();
    }

    function updatePlayPauseButton() {
      playPauseBtn.innerHTML = isPlaying ? '⏸' : '▶';
    }

    function playFlight() {
      if (!isPlaying && flightPathPoints.length > 0) {
        // If we're at the end, start from the beginning
        if (parseInt(progressBar.value) >= flightPathPoints.length - 1) {
          progressBar.value = 0;
        }

        isPlaying = true;

        playbackInterval = setInterval(() => {
          let currentIndex = parseInt(progressBar.value);
          if (currentIndex >= flightPathPoints.length - 1) {
            pauseFlight();
            updatePlayPauseButton();
            return;
          }
          currentIndex++;
          progressBar.value = currentIndex;
          updateDisplay(currentIndex);
          updateAircraftPosition(currentIndex);
        }, playbackSpeed);
      }
    }

    function pauseFlight() {
      clearInterval(playbackInterval);
      isPlaying = false;
    }

    function updateAircraftPosition(index) {
      if (!flightPathPoints || !aircraftMarker || index >= flightPathPoints.length) return;

      const point = flightPathPoints[index];

      aircraftMarker.setLatLng([point.lat, point.lng]);
      aircraftMarker.setIcon(createAircraftIcon(point.direction, point.model));

      const bounds = map.getBounds();
      if (!bounds.contains([point.lat, point.lng])) {
        map.panTo([point.lat, point.lng], { animate: true });
      }
    }

    let activePointIndex = -1;

    function updateDisplay(index) {
      const point = flightPathPoints[index];
      if (!point) return;

      activePointIndex = index;
      if (chartInstance) {
        chartInstance.draw();
      }

      heureEl.textContent = point.time;
      document.getElementById("UTCTime").textContent = point.utcTime;
      altitudeEl.textContent = Math.round(point.altitudeFeet);
      vitesseEl.textContent = Math.round(point.speed);
      directionEl.textContent = Math.round(point.direction);
    }

    function handleSingleFile() {
      // This function might not be used if the input assumes multi-file, 
      // but if there were a single file input elsewhere, we'd update it too.
      // The current UI uses #multiCsvFiles for everything.
      // But preserving this just in case logic is shared.
      const file = multiFileInput.files[0];
      if (file) {
        clearAllFlights();
        flightSelector.style.display = 'none';
        const flightToggleBtn = document.getElementById('flightSelectorToggle');
        if (flightToggleBtn) flightToggleBtn.style.display = 'none';

        if (file.name.toLowerCase().endsWith('.kml')) {
          processKMLFile(file, 0, true);
        } else {
          processCSVFile(file, 0, true);
        }
      }
    }

    function handleMultiFiles() {
      const files = multiFileInput.files;
      const flightToggleBtn = document.getElementById('flightSelectorToggle');

      if (files.length > 0) {
        clearAllFlights();
        flightSelector.innerHTML = '';

        const isSingleFile = files.length === 1;

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (file.name.toLowerCase().endsWith('.kml')) {
            processKMLFile(file, i, isSingleFile);
          } else {
            processCSVFile(file, i, isSingleFile);
          }
        }

        if (flightToggleBtn) {
          flightToggleBtn.style.display = !isSingleFile ? 'flex' : 'none';
        }
        flightSelectorContainer.style.display = !isSingleFile ? 'flex' : 'none';

        // Ensure menu starts collapsed (hidden) when loading new files
        if (!isSingleFile) {
          flightSelectorContainer.classList.add('collapsed');
        }



      } else {
        if (flightToggleBtn) flightToggleBtn.style.display = 'none';
        const toggleGraph = document.getElementById('toggleGraphBtn');
        if (toggleGraph) toggleGraph.style.display = 'none';
      }
    }

    function clearAllFlights() {
      // Remove all existing flight paths and markers
      allFlights.forEach(flight => {
        if (flight.path) map.removeLayer(flight.path);
        if (flight.startMarker) map.removeLayer(flight.startMarker);
        if (flight.endMarker) map.removeLayer(flight.endMarker);
        flight.altitudeSegments.forEach(segment => map.removeLayer(segment));
      });

      allFlights = [];
      flightPathPoints = []; // IMPORTANT: Clear the current points so playback stops working on old data
      currentFlightIndex = -1;
      currentFlightData = null;

      // Clear the aircraft marker
      if (aircraftMarker) {
        map.removeLayer(aircraftMarker);
        aircraftMarker = null;
      }

      const toggleBtn = document.getElementById('toggleGraphBtn');
      if (toggleBtn) toggleBtn.style.display = 'none';

      // Destroy chart
      if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
      }

      // Reset UI state
      const chartContainer = document.getElementById('chart-container');
      const infoBox = document.querySelector('.infosbox');
      if (chartContainer) chartContainer.classList.add('collapsed');
      if (infoBox) infoBox.classList.remove('expanded');

      // Reset Playback & Metadata
      if (typeof isPlaying !== 'undefined' && isPlaying) pauseFlight();
      if (typeof updatePlayPauseButton === 'function') updatePlayPauseButton();

      if (progressBar) {
        progressBar.value = 0;
        progressBar.disabled = true;
      }
      if (speedControl) speedControl.disabled = true;

      if (heureEl) heureEl.textContent = '--/--/---- --:--:--'; // Or 00... user didn't specify, -- is cleaner
      const utcEl = document.getElementById("UTCTime");
      if (utcEl) utcEl.textContent = '--/--/---- --:--:--';

      if (altitudeEl) altitudeEl.textContent = '-----';
      if (vitesseEl) vitesseEl.textContent = '----';
      if (directionEl) directionEl.textContent = '---';
      if (flightTimeEl) flightTimeEl.textContent = '--:--:--';
    }

    function processKMLFile(file, index, isSingleFile) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
        const flightPoints = [];
        const flightSegments = [];

        // Extract Flight Name (try Document name, or Filename)
        let flightName = file.name.replace('.kml', '');
        const docName = xmlDoc.querySelector('Document > name');
        if (docName && docName.textContent) {
          flightName = docName.textContent;
        }

        // Extract Aircraft Model from Document description (applies to entire flight)
        let aircraftModel = null;
        const docDescription = xmlDoc.querySelector('Document > description');
        if (docDescription) {
          const docHtmlContent = docDescription.textContent;
          // Look for "Aircraft<span...>(MODEL)</span>"
          const modelMatch = docHtmlContent.match(/Aircraft.*?\((\w+)\)/);
          if (modelMatch) {
            aircraftModel = modelMatch[1];
          }
        }

        // Find all Placemarks that look like track points (have TimeStamp)
        const placemarks = xmlDoc.querySelectorAll('Placemark');

        placemarks.forEach(pm => {
          const timestampNode = pm.querySelector('TimeStamp > when');
          const pointNode = pm.querySelector('Point > coordinates');
          const descriptionNode = pm.querySelector('description');

          if (timestampNode && pointNode) {
            const coords = pointNode.textContent.trim().split(',');
            const lng = parseFloat(coords[0]);
            const lat = parseFloat(coords[1]);
            const alt = parseFloat(coords[2]) || 0; // standard KML alt is meters usually, but let's check
            // Wait, the KML example description says "Altitude: 0 ft". 
            // The <coordinates> usually have altitude in meters in standard KML, BUT
            // let's rely on the Description HTML if available for more precise/data-logger specific values (Speed/Heading).
            // Actually, let's parse the description for consistent data matching the CSV columns.

            let altitudeFeet = 0;
            let speedKt = 0;
            let headingDeg = 0;

            if (descriptionNode) {
              const htmlContent = descriptionNode.textContent;
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(htmlContent, 'text/html');

              // Helper to extracting numeric value from sibling span
              const extractValue = (label) => {
                const bTags = htmlDoc.getElementsByTagName('b');
                for (let i = 0; i < bTags.length; i++) {
                  if (bTags[i].textContent.includes(label)) {
                    let valueContainer = null;
                    // Check 1: <description>...<span><b>Label:</b></span> <span>Value</span>...</description>
                    // bTag -> parent(span) -> nextElementSibling(span)
                    if (bTags[i].parentElement && bTags[i].parentElement.tagName.toLowerCase() === 'span') {
                      valueContainer = bTags[i].parentElement.nextElementSibling;
                    }
                    // Check 2: Direct sibling? <b>Label:</b> <span>Value</span>
                    if (!valueContainer) {
                      valueContainer = bTags[i].nextElementSibling;
                    }

                    if (valueContainer) {
                      let text = valueContainer.textContent.trim();

                      // Handle range "24,925 ft - 23,325 ft" -> take the right side
                      if (text.includes('-')) {
                        const parts = text.split('-');
                        text = parts[parts.length - 1].trim();
                      }

                      // Remove commas "23,325" -> "23325"
                      text = text.replace(/,/g, '');

                      const match = text.match(/(\d+)/);
                      if (match) return parseInt(match[1]);
                    }
                  }
                }

                // Fallback: Regex on full text
                const cleanText = htmlDoc.body.textContent || "";
                const backupRegex = new RegExp(label + "\\s*[:]?\\s*(\\d+)");
                const match = cleanText.match(backupRegex);
                if (match) return parseInt(match[1]);

                return null;
              };

              const altConf = extractValue('Altitude');
              if (altConf !== null) altitudeFeet = altConf;

              const spdConf = extractValue('Speed');
              if (spdConf !== null) speedKt = spdConf;

              const hdgConf = extractValue('Heading');
              if (hdgConf !== null) headingDeg = hdgConf;

            } else {
              // Fallback if no description (standard KML)
              // If standard KML, coords[2] is meters. 1m = 3.28084ft
              altitudeFeet = (parseFloat(coords[2]) || 0) * 3.28084;
            }

            // Check for Style Heading fallback
            if (headingDeg === 0) {
              const iconHeading = pm.querySelector('Style > IconStyle > heading');
              if (iconHeading) headingDeg = parseInt(iconHeading.textContent);
            }

            if (!isNaN(lat) && !isNaN(lng)) {
              const rawTime = timestampNode.textContent;
              // Calculate unix timestamp for graph
              const unixTime = new Date(rawTime).getTime() / 1000;

              flightPoints.push({
                lat: lat,
                lng: lng,
                altitudeFeet: altitudeFeet,
                speed: speedKt,
                direction: headingDeg,
                rawUnix: unixTime,
                time: formatTime(rawTime), // formatTime handles 'Invalid Date' checks internally
                utcTime: formatUTCTime(rawTime), // reusing existing if format matches
                model: aircraftModel // Store aircraft model
              });
            }
          }
        });

        if (flightPoints.length === 0) {
          showErrorPopup();
          return;
        }

        finishProcessingFlight(flightPoints, flightName, index, isSingleFile, { data: [] }); // KML has no raw data equivalent to CSV
      };
      reader.readAsText(file);
    }

    function processCSVFile(file, index, isSingleFile) {
      Papa.parse(file, {
        header: true,
        complete: function (results) {
          const data = results.data;
          const flightPoints = [];
          // const flightSegments = []; // Unused variable
          let flightName = file.name.replace('.csv', '');

          if (results.meta.fields && results.meta.fields.length >= 3) {
            const c2Value = results.data[0] ? results.data[0][results.meta.fields[2]] : '';
            flightName = c2Value || flightName;
          }

          data.forEach(row => {
            if (row.Position && row.Altitude) {
              const [lat, lng] = row.Position.split(',').map(Number);
              const altitudeFeet = parseFloat(row.Altitude);
              const direction = parseFloat(row.Direction) || 0;

              if (!isNaN(lat) && !isNaN(lng) && !isNaN(altitudeFeet)) {
                flightPoints.push({
                  lat,
                  lng,
                  altitudeFeet: altitudeFeet,
                  speed: row.Speed || 'N/A',
                  direction: direction,
                  time: formatTime(row.Timestamp),
                  utcTime: formatUTCTime(row.UTC)
                });
              }
            }
          });


          if (flightPoints.length === 0) {
            showErrorPopup();
            return;
          }

          if (flightPoints.length < 2) return;

          finishProcessingFlight(flightPoints, flightName, index, isSingleFile, results);
        }
      });
    }

    function finishProcessingFlight(flightPoints, flightName, index, isSingleFile, originalDataWrapper) {
      // Shared Logic between CSV and KML

      // Create altitude-based segments
      const altitudeSegments = [];
      for (let i = 0; i < flightPoints.length - 1; i++) {
        const p1 = flightPoints[i];
        const p2 = flightPoints[i + 1];
        const avgAltFeet = (p1.altitudeFeet + p2.altitudeFeet) / 2;
        const color = getColorFromAltitude(avgAltFeet);

        const segment = L.polyline([[p1.lat, p1.lng], [p2.lat, p2.lng]], {
          color: color,
          weight: getTrackWeight()
        }).addTo(map);

        altitudeSegments.push(segment);

        segment.on('mousemove', (e) => {
          if (currentTooltip) {
            map.removeLayer(currentTooltip);
          }

          const tooltipContent = `
                <div class="tooltip-content">
                  <strong>LOCAL TIME: </strong> ${p1.time}<br/>
                  <strong>UTC TIME: </strong> ${p1.utcTime}<br/>
                  <strong>ALTITUDE: </strong> ${p1.altitudeFeet.toFixed(0)} ft<br/>
                  <strong>SPEED: </strong> ${p1.speed} kt<br/>
                  <strong>TRACK: </strong> ${p1.direction}°<br/>
                  <strong>LATITUDE: </strong> ${e.latlng.lat.toFixed(6)}<br/>
                  <strong>LONGITUDE: </strong> ${e.latlng.lng.toFixed(6)}
                </div>
              `;

          currentTooltip = L.tooltip({
            permanent: false,
            direction: 'top',
            className: 'tooltip-content'
          })
            .setLatLng(e.latlng)
            .setContent(tooltipContent)
            .addTo(map);
        });

        segment.on('mouseout', () => {
          if (currentTooltip) {
            map.removeLayer(currentTooltip);
            currentTooltip = null;
          }
        });
      }

      // Create start and end markers (visible by default)
      const start = flightPoints[0];
      const end = flightPoints[flightPoints.length - 1];

      const startMarker = L.marker([start.lat, start.lng]).addTo(map);
      const endMarker = L.marker([end.lat, end.lng]).addTo(map);

      // Bind tooltips that only show on hover
      startMarker.bindTooltip(`${flightName} - Takeoff`, {
        permanent: false,
        direction: 'top',
        className: 'tooltip-content'
      });

      endMarker.bindTooltip(`${flightName} - Landing`, {
        permanent: false,
        direction: 'top',
        className: 'tooltip-content'
      });

      // Show tooltip on mouseover
      startMarker.on('mouseover', function () {
        this.openTooltip();
      });

      // Hide tooltip on mouseout
      startMarker.on('mouseout', function () {
        this.closeTooltip();
      });

      // Show tooltip on mouseover
      endMarker.on('mouseover', function () {
        this.openTooltip();
      });

      // Hide tooltip on mouseout
      endMarker.on('mouseout', function () {
        this.closeTooltip();
      });

      // Store flight data
      // For KML we don't have the original 'data' array structure from PapaParse, 
      // allow originalDataWrapper to be just the points if needed, or normalize it? 
      // The updateChart function expects 'data' to have .Timestamp, .Altitude, .Speed properties.
      // We need to normalize data for the chart if it came from KML.

      let chartDataSource = originalDataWrapper.data;

      // If the source data doesn't look like CSV rows (no Timestamp property), we might need to map it back 
      // or update updateChart to handle the 'flightPoints' structure which is cleaner.
      // Ideally, we should refactor updateChart to use flightPoints!
      // But to minimize risk, let's just make sure KML data is mapped to mimic the CSV row structure for the chart.
      if ((!chartDataSource.length || !chartDataSource[0].Timestamp) && flightPoints.length > 0) {
        // It's probably our KML points. Let's remap them to the expected format for updateChart
        chartDataSource = flightPoints.map(p => ({
          Timestamp: p.rawUnix, // Use the raw unix timestamp we stored
          Altitude: p.altitudeFeet,
          Speed: p.speed
        }));
      }

      const flightData = {
        name: flightName,
        points: flightPoints,
        path: null,
        startMarker: startMarker,
        endMarker: endMarker,
        altitudeSegments: altitudeSegments,
        data: chartDataSource
      };

      allFlights[index] = flightData;

      // Add to flight selector if multiple files
      if (!isSingleFile) {
        flightSelector.innerHTML = '';
        allFlights.forEach((flight, idx) => {
          const flightItem = document.createElement('div');
          flightItem.className = 'flight-item';
          flightItem.textContent = flight.name;
          flightItem.dataset.index = idx; // Store index for reliable selection
          flightItem.onclick = () => selectFlight(idx);

          // Restore active state if needed
          if (idx === currentFlightIndex) {
            flightItem.classList.add('active');
          }

          flightSelector.appendChild(flightItem);
        });
      }

      // If this is the first SUCCESSFUL flight (or single file), select it by default
      if (currentFlightIndex === -1 || isSingleFile) {
        selectFlight(index, isSingleFile);
      }

      const toggleGraph = document.getElementById('toggleGraphBtn');
      if (toggleGraph) toggleGraph.style.display = 'flex';
    }

    function selectFlight(index, isSingleFile = false) {
      if (index < 0 || index >= allFlights.length) return;

      currentFlightIndex = index;
      const flight = allFlights[index];
      currentFlightData = flight;

      // Update flight selector UI
      const flightItems = document.querySelectorAll('.flight-item');
      flightItems.forEach((item) => {
        // Use loose equality for dataset string vs integer index
        if (item.dataset.index == index) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });

      // Set current flight data
      flightPathPoints = flight.points;

      // Remove previous aircraft marker if exists
      if (aircraftMarker) {
        map.removeLayer(aircraftMarker);
      }

      // Create new aircraft marker
      aircraftMarker = L.marker(
        [flightPathPoints[0].lat, flightPathPoints[0].lng],
        {
          icon: createAircraftIcon(flightPathPoints[0].direction),
          rotationAngle: flightPathPoints[0].direction
        }
      ).addTo(map);

      // Update UI
      document.getElementById('multi_file_button').textContent = `Playback of flight ${flight.name}`;
      progressBar.max = flightPathPoints.length - 1;
      progressBar.disabled = false;
      speedControl.disabled = false;
      progressBar.value = 0;
      updateDisplay(0);
      updateAircraftPosition(0);

      // Calculate and display flight time
      flightTimeEl.textContent = calculateFlightTime(flight.data);

      // Update chart
      updateChart(flight.data);

      // Fit bounds to this flight with padding to avoid UI overlap
      // paddingBottomRight y=300 to clear the bottom info box
      map.fitBounds(L.latLngBounds(flightPathPoints.map(p => [p.lat, p.lng])), {
        paddingTopLeft: [70, 70],
        paddingBottomRight: [70, 70]
      });
    }

    /*
    let showMarkers = false;

    const vfrPoints = [
      { coords: [33.43841601567446, -111.75538815237346], name: "THREE DOME CHURCH" },
      { coords: [33.41199254647871, -111.72344653339482], name: "WAGON WHEEL" },
      { coords: [33.451442, -111.669770], name: "MCKELLIPS ROAD" },
      { coords: [33.43866693950161, -111.6626337051323], name: "BALL FIELDS" },
      { coords: [33.410004, -111.613071], name: "POINT LIMA" },
      { coords: [33.442993, -111.588846], name: "RC AIRFIELD" },
      { coords: [33.36731941789664, -111.53085200313159], name: "AJ LANDFILL" },
      { coords: [33.321551316756626, -111.42991940016202], name: "RENAISSANCE FESTIVAL" },
      { coords: [33.253013, -111.414020], name: "CEMENT PLANT" },
      { coords: [33.373270, -111.751450], name: "VALVISTA LAKES" },
      { coords: [33.39124357152383, -111.69036638245055], name: "SUPER MALL" },
      { coords: [33.06485236367131, -111.5148693346962], name: "MR VOLCANO" },
      { coords: [33.25560430330835, -111.3388951495078], name: "FLORENCE JUNCTION" },
      { coords: [33.37915128576638, -111.4605532335147], name: "GOLD CANYON" },
      { coords: [33.24164274819704, -111.523013610029], name: "RITTENHOUSE" },
      { coords: [33.1731, -111.67104], name: "THE GAP" },
      { coords: [33.17206881765591, -111.4736358539546], name: "WATER SKY LAKE" },
      { coords: [33.03058167410544, -111.6193482691844], name: "BLACK WATER" },
    ];

    function createVFRPointIcon() {
      return L.divIcon({
        className: 'vfr-icon',
        html: `
          <svg viewBox="0 0 24 24" width="24" height="24">
            <circle cx="12" cy="12" r="10" fill="#2159ff" opacity="0.8"/>
            <circle cx="12" cy="12" r="6" fill="#FFFFFF"/>
          </svg>
        `,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });
    }

    const vfrMarkers = vfrPoints.map(point => {
      const marker = L.marker(point.coords, {
        icon: createVFRPointIcon()
      }).bindTooltip(point.name, {
        permanent: false,
        direction: 'top',
        className: 'tooltip-content'
      });
      return marker;
    });

    const style = document.createElement('style');
    style.textContent = `
      .vfr-icon {
        background-color: transparent;
        border: none;
        filter: drop-shadow(0 0 2px rgba(0,0,0,0.7));
      }
    `;
    document.head.appendChild(style);

    const toggleMarkersBtn = document.getElementById('toggleMarkersBtn');

    toggleMarkersBtn.addEventListener('click', function () {
      showMarkers = !showMarkers;

      vfrMarkers.forEach(marker => {
        if (showMarkers) {
          map.addLayer(marker);
          toggleMarkersBtn.style.backgroundColor = 'rgba(33, 89, 255)';
          toggleMarkersBtn.style.color = 'rgb(255, 255, 255)';
        } else {
          map.removeLayer(marker);
          toggleMarkersBtn.style.backgroundColor = 'rgba(255, 255, 255)';
          toggleMarkersBtn.style.color = 'rgb(0, 0, 0)';
        }
      });
    });
    */

    progressBar.addEventListener('input', function () {
      const index = parseInt(this.value);
      updateDisplay(index);
      updateAircraftPosition(index);
    });

    function getChartTheme() {
      const style = getComputedStyle(document.body);
      return {
        axisColor: style.getPropertyValue('--chart-axis-color').trim(),
        gridColor: style.getPropertyValue('--chart-grid-color').trim(),
        tooltipBg: style.getPropertyValue('--tooltip-bg').trim(),
        textMain: style.getPropertyValue('--text-main').trim(),
        textSecondary: style.getPropertyValue('--text-secondary').trim()
      };
    }

    function getGraphLineWidth() {
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isSmallScreen = window.innerWidth <= 1024;
      return (isMobile || isSmallScreen) ? 1 : 2;
    }

    function updateChart(data) {
      if (!data) return;

      const theme = getChartTheme();
      const lineWidth = getGraphLineWidth();
      const altitude = [];
      const speed = [];

      data.forEach(row => {
        if (row.Timestamp && !isNaN(row.Altitude) && !isNaN(row.Speed)) {
          const parsedTime = new Date(parseInt(row.Timestamp) * 1000);
          if (!isNaN(parsedTime)) {
            altitude.push({ x: parsedTime, y: row.Altitude });
            speed.push({ x: parsedTime, y: row.Speed });
          }
        }
      });

      const ctx = document.getElementById('flightChart').getContext('2d');
      if (chartInstance) {
        chartInstance.destroy();
      }

      const scrubberLine = {
        id: 'scrubberLine',
        afterDatasetsDraw(chart, args, options) {
          if (activePointIndex === -1) return;

          const { ctx, chartArea: { top, bottom }, scales: { x } } = chart;
          const meta = chart.getDatasetMeta(0);

          // Ensure we have data at this index
          if (!meta.data[activePointIndex]) return;

          const xPos = meta.data[activePointIndex].x;

          ctx.save();
          ctx.beginPath();
          ctx.lineWidth = 1;
          ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
          ctx.moveTo(xPos, top);
          ctx.lineTo(xPos, bottom);
          ctx.stroke();
          ctx.restore();
        }
      };

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [
            {
              label: 'GROUND SPEED',
              data: speed,
              borderColor: '#f0ad4e',
              backgroundColor: '#f0ad4e',
              yAxisID: 'y1',
              tension: 0.1, // Less bold zigzags
              fill: false,
              pointRadius: 0,
              borderWidth: lineWidth // Responsive line width
            },
            {
              label: 'ALTITUDE',
              data: altitude,
              borderColor: '#00bfff',
              backgroundColor: '#00bfff',
              yAxisID: 'y',
              tension: 0.1, // Less bold zigzags
              fill: false,
              pointRadius: 0,
              borderWidth: lineWidth // Responsive line width
            }
          ]
        },
        plugins: [scrubberLine],
        options: {
          animation: {
            duration: 0 // Disable animation for responsive scrubbing
          },
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          stacked: false,
          plugins: {
            title: {
              display: false
            },
            legend: {
              labels: {
                color: theme.textMain
              }
            },
            tooltip: {
              backgroundColor: theme.tooltipBg,
              titleColor: theme.textMain,
              bodyColor: theme.textMain,
              borderColor: theme.gridColor,
              borderWidth: 1,
              callbacks: {
                label: function (context) {
                  if (context.dataset.label === 'GROUND SPEED') {
                    return 'Ground Speed: ' + context.formattedValue + ' kt';
                  } else if (context.dataset.label === 'ALTITUDE') {
                    return 'Altitude: ' + context.formattedValue + ' ft';
                  }
                  return context.formattedValue;
                }
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'minute',
                tooltipFormat: 'PPpp'
              },
              ticks: {
                color: theme.axisColor
              },
              grid: {
                color: theme.gridColor
              }
            },
            y: {
              type: 'linear',
              position: 'left',
              title: {
                display: true,
                text: 'Altitude (ft)',
                color: theme.axisColor
              },
              ticks: {
                color: theme.axisColor
              },
              grid: {
                color: theme.gridColor
              }
            },
            y1: {
              type: 'linear',
              position: 'right',
              title: {
                display: true,
                text: 'Speed (kt)',
                color: theme.axisColor
              },
              ticks: {
                color: theme.axisColor
              },
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });
    }

    // Listen for theme changes to update chart
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      if (currentFlightData) {
        updateChart(currentFlightData.data);
      }
    });

    const toggleGraphBtn = document.getElementById('toggleGraphBtn');
    const chartContainer = document.getElementById('chart-container');
    const infosbox = document.querySelector('.infosbox');

    // Drag Logic
    let isDragging = false;
    let dragStartY = 0;
    let draggedDistance = 0;
    let startHeight = 0;
    const MAX_HEIGHT = 240;

    function finishDrag(wasClick) {
      isDragging = false;

      const currentHeight = chartContainer.offsetHeight;

      // Restore transitions
      chartContainer.style.transition = 'height 0.3s ease, opacity 0.3s ease';

      // Remove inline styles
      chartContainer.style.height = '';
      chartContainer.style.opacity = '';

      const isCurrentlyCollapsed = chartContainer.classList.contains('collapsed');
      let shouldExpand = false;

      if (wasClick) {
        shouldExpand = isCurrentlyCollapsed;
      } else {
        // Dragged: snap to closest
        shouldExpand = currentHeight > (MAX_HEIGHT / 3); // Threshold to keep open
      }

      if (shouldExpand) {
        chartContainer.classList.remove('collapsed');
        infosbox.classList.remove('collapsed');
        infosbox.classList.add('expanded');
      } else {
        chartContainer.classList.add('collapsed');
        infosbox.classList.add('collapsed');
        infosbox.classList.remove('expanded');
      }

      if (chartInstance) {
        // Delay update slightly to let transition start
        setTimeout(() => chartInstance.update(), 10);
      }
    }

    toggleGraphBtn.addEventListener('mousedown', (e) => {
      isDragging = true;
      dragStartY = e.clientY;
      draggedDistance = 0;
      startHeight = chartContainer.offsetHeight;
      chartContainer.style.transition = 'none';
    });

    toggleGraphBtn.addEventListener('touchstart', (e) => {
      if (e.cancelable) e.preventDefault();
      isDragging = true;
      dragStartY = e.touches[0].clientY;
      draggedDistance = 0;
      startHeight = chartContainer.offsetHeight;
      chartContainer.style.transition = 'none';
    }, { passive: false });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      e.preventDefault();
      const dy = dragStartY - e.clientY;
      draggedDistance = Math.abs(dy);

      // Drag logic
      let newHeight = startHeight + dy;
      newHeight = Math.max(0, Math.min(newHeight, MAX_HEIGHT));
      chartContainer.style.height = `${newHeight}px`;
      chartContainer.style.opacity = Math.max(0.1, Math.min(1, newHeight / 50));
    });

    document.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      e.preventDefault();
      const dy = dragStartY - e.touches[0].clientY;
      draggedDistance = Math.abs(dy);

      let newHeight = startHeight + dy;
      newHeight = Math.max(0, Math.min(newHeight, MAX_HEIGHT));
      chartContainer.style.height = `${newHeight}px`;
      chartContainer.style.opacity = Math.max(0.1, Math.min(1, newHeight / 50));
    }, { passive: false });

    document.addEventListener('mouseup', (e) => {
      if (isDragging) {
        // If moved less than 5px, treat as click
        finishDrag(draggedDistance < 5);
      }
    });

    document.addEventListener('touchend', (e) => {
      if (isDragging) {
        finishDrag(draggedDistance < 5);
      }
    });

    infosbox.classList.add('collapsed');
    chartContainer.classList.add('collapsed');
    // No text content update needed

    async function takeScreenshot() {
      const screenshotBtn = document.getElementById('screenshotBtn');
      const multiFileBtn = document.getElementById('multi_file_button');
      const flightSelectorCont = document.getElementById('flightSelectorContainer');
      const infosbox = document.querySelector('.infosbox');
      const layersControl = document.querySelector('.leaflet-control-layers');
      const zoomControl = document.querySelector('.leaflet-control-zoom');
      const scaleControl = document.querySelector('.leaflet-control-scale');
      const attributionControl = document.querySelector('.leaflet-control-attribution');

      // Elements to hide (UI elements)
      const elementsToHide = [
        screenshotBtn,
        multiFileBtn,
        flightSelectorCont,
        infosbox,
        layersControl,
        zoomControl,
        scaleControl,
        attributionControl
      ];

      // Save initial visibility/display
      const originalVisibility = elementsToHide.map(el => el ? el.style.visibility : null);

      // Hide UI elements
      elementsToHide.forEach(el => {
        if (el) el.style.visibility = 'hidden';
      });

      // Also hide takeoff/landing pins, aircraft marker, and shadows
      const shadowPane = document.querySelector('.leaflet-shadow-pane');
      if (shadowPane) shadowPane.style.display = 'none';

      allFlights.forEach(flight => {
        if (flight.startMarker) flight.startMarker.getElement().style.display = 'none';
        if (flight.endMarker) flight.endMarker.getElement().style.display = 'none';
      });
      if (aircraftMarker) aircraftMarker.getElement().style.display = 'none';

      try {
        // We use html2canvas on the #map element directly instead of document.body
        // This is safer and avoids potential issues with hidden elements
        const canvas = await html2canvas(document.getElementById('map'), {
          useCORS: true,
          allowTaint: false,
          backgroundColor: '#262626', // Match map background
          logging: false,
          scale: 2,
          ignoreElements: (element) => {
            // Further protect against any lingering UI elements inside map container if any
            return element.classList.contains('leaflet-control-container');
          }
        });

        const link = document.createElement('a');
        link.download = `flight_playback_${new Date().getTime()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      } catch (error) {
        console.error('Screenshot failed:', error);
        alert('Failed to take screenshot. There might be a CORS issue with map tiles.');
      } finally {
        // Restore UI elements
        elementsToHide.forEach((el, i) => {
          if (el) el.style.visibility = originalVisibility[i];
        });

        // Restore takeoff/landing pins, aircraft marker, and shadows
        if (shadowPane) shadowPane.style.display = '';

        allFlights.forEach(flight => {
          if (flight.startMarker) flight.startMarker.getElement().style.display = '';
          if (flight.endMarker) flight.endMarker.getElement().style.display = '';
        });
        if (aircraftMarker) aircraftMarker.getElement().style.display = '';
      }
    }
    // Initialize Buy Me a Coffee button animation
    window.addEventListener('load', () => {
      setTimeout(() => {
        const tipBtn = document.getElementById('tipBtn');
        if (tipBtn) {
          tipBtn.classList.add('shrunk');
        }
      }, 3000);

      // Link custom button to official BMC widget
      const tipBtn = document.getElementById('tipBtn');
      if (tipBtn) {
        tipBtn.addEventListener('click', () => {
          const bmcWidgetBtn = document.getElementById('bmc-wbtn');
          if (bmcWidgetBtn) {
            bmcWidgetBtn.click();
          }
        });
      }
    });
  </script>
</body>

</html>

